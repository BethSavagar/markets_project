---
title: "mrktc_origdest_catchment"
output: html_document
date: "2024-02-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)
library(rmarkdown)
library(igraph)
library(ggraph)
```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "serif", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C")
```

## Quick Network Analysis ##


```{r load-data, include = F}

# Market survey A data:
mrkta_gps <- read_csv(here("data/data-cleaning_data/mrkta_gps_tanzania_final.csv")) 

# Market Survey C data
mrktc_gps <- read_csv(here("data/data-cleaning_data/mrktc_allgps_tanzania_final.csv"))

mrktc_coords <- mrktc_gps %>%
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
mrktc_sf <- st_as_sf(mrktc_coords, coords = c("long","lat"),  crs = 4326)

# Market Survey C origins and destinations (from mrktc_origindest-cleaning_mar24)
mrktc_all <- read_csv(here("data/data-cleaning_data/mrktc_infoactvty_tanzania.csv"))

# Load Tanzania Shapefile:
sf_use_s2(FALSE)
twards_shp <- st_read(here("data/shapefiles/tzshp_final/twards_final.shp"))
tdists_shp <- st_read(here("data/shapefiles/tzshp_final/tdists_final.shp"))
tregs_shp <- st_read(here("data/shapefiles/tzshp_final/tregs_final.shp"))

```

# Script Producing Summary Origin/Destination data for MFA

# Data Overview:

Market Identifiers:
- fid
- date
- region
- district
- district20
- ward
- village
- market



## Update mrktc market locations data
- match to market locations in mrkt survey A (consistent between surveys)
- generate gps location within ward of market

```{r mrktclocations}

mrktc_gps_update <- mrktc_gps %>% 
  
  # remove and add coordinates from market survey A:
  select(-`gps.coordinates.of.the.market`) %>%
  
  # join market survey A location data:
  left_join(
    mrkta_gps %>% select(-c(fid,date,unique.row.identifier.uuid.))
  ) %>%
  # tidy market location data
  select(-district) %>%
  rename(
    mrkt.region = region,
    mrkt.district = district20,
    mrkt.ward = ward,
    mrkt.village = village,
    mrkt.name = market
  ) %>%
  
  # variables for market lat and long:
  mutate(mrktlong = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2],
         mrktlong = as.numeric(mrktlong),
         mrktlat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         mrktlat = as.numeric(mrktlat)
  )


# Unique markets in market C data:

mrktc_unique_gps <- mrktc_gps_update %>% 
  group_by(
    mrkt.region, mrkt.district, mrkt.ward, mrkt.village, mrkt.name, mrktlong, mrktlat
  ) %>%
  summarise(nsrvy = n()) %>%
  ungroup() %>%
  mutate(
    mrktid = paste0("M", row_number())
    )


# Unique wards in market C data (for building network): 

mrktc_wards <- mrktc_unique_gps %>%
  select(-c(mrktlong, mrktlat, mrkt.village, mrkt.name)) %>%
   left_join(
    twards_shp %>% select(Region20_N, Dist20_N, Ward_N, geometry),
    by = c(`mrkt.ward` = "Ward_N", 
           `mrkt.district` = "Dist20_N",
           `mrkt.region` = "Region20_N")
  ) %>%
  st_as_sf() %>%
  # transform to point data (centroid/central point within ward)
  st_point_on_surface()
  
mrktc_ward_gps <- mrktc_wards %>%
  st_drop_geometry() %>%
  mutate(mrktlong = st_coordinates(mrktc_ward_sf)[,1],
         mrktlat = st_coordinates(mrktc_ward_sf)[,2]) %>%
  group_by(mrkt.region, mrkt.district, mrkt.ward, mrktlong, mrktlat) %>%
  summarise(nmrkts = n(),
            totsrvy = sum(nsrvy)) %>%
  ungroup() %>%
  mutate(mrktWid = paste0("W", row_number()))

mrktc_ward_sf <- st_as_sf(mrktc_ward_gps, coords = c("mrktlong","mrktlat"),  crs = 4326)

mrktc_mrkts <- ggplot() +
  geom_sf(data = tregs_shp)+
  geom_sf(data = mrktc_ward_sf, aes(size = totsrvy, col = factor(nmrkts)))+
  geom_sf(data = mrktc_ward_sf, shape = 4)

mrktc_mrkts
ggplotly(mrktc_mrkts)

```


## Market Netowrk Full:
- All origins and destinations on one network.



## Subset Origins and add point locations (district/ward centroid) ##

```{r origins}

# Subset only origin data (2021 rows with origin data)
mrktc_origins <- mrktc_all %>%
  select(
    fid,
    origin.ward = `2.origin.ward`,
    origin.district = `2.origin.district`,
    origin.region = `2.origin.region`
  ) %>%
  drop_na() %>%
  mutate(
    origin.place = origin.ward
  ) %>%
  
  # join tanzania ward polygons to origins data:
  left_join(
    twards_shp %>% select(Region20_N, Dist20_N, Ward_N, geometry),
    by = c(`origin.ward` = "Ward_N", 
           `origin.district` = "Dist20_N",
           `origin.region` = "Region20_N")
  ) %>%
  st_as_sf() %>%
  # transform to point data (centroid/central point within ward)
  st_point_on_surface()


mrktc_origins_gps <- mrktc_origins %>%
  st_drop_geometry() %>%
  mutate(origlong = st_coordinates(mrktc_origins)[,1],
         origlat = st_coordinates(mrktc_origins)[,2])

origins_unique_gps <- mrktc_origins_gps %>%
  select(-c(fid, origin.place)) %>%
  distinct()





mrktc_dests <- mrktc_all %>%
  select(
    fid,
    dest.ward = `6.dest.ward`,
    dest.district = `6.dest.district`,
    dest.region = `6.dest.region`
  ) %>%
  drop_na() %>%
  mutate(
    dest.place = dest.ward
  ) %>%
  
  # join tanzania ward polygons to origins data:
  left_join(
    twards_shp %>% select(Region20_N, Dist20_N, Ward_N, geometry),
    by = c(`dest.ward` = "Ward_N", 
           `dest.district` = "Dist20_N",
           `dest.region` = "Region20_N")
  ) %>%
  st_as_sf() %>%
  # transform to point data (centroid/central point within ward)
  st_point_on_surface()

mrktc_dests_gps <- mrktc_dests %>%
  st_drop_geometry() %>%
  mutate(destlong = st_coordinates(mrktc_dests)[,1],
         destlat = st_coordinates(mrktc_dests)[,2])

dests_unique_gps <- mrktc_dests_gps %>%
  select(-c(fid, dest.place)) %>%
  distinct()


## Combine origins and destinations:

OD_unique_gps <- origins_unique_gps %>%
  rename(od.ward = origin.ward, od.district = origin.district, od.region = origin.region, od.long = origlong, od.lat = origlat) %>%
  bind_rows(
    dests_unique_gps %>%  rename(od.ward = dest.ward, od.district = dest.district, od.region = dest.region, od.long = destlong, od.lat = destlat)
  ) %>%
  distinct() %>%
  mutate(id = paste0("od", row_number()))

```


```{r nodes}

nodes <- mrktc_ward_gps %>%
  #distinct(mrkt.ward,mrkt.district,mrkt.region, mrktlong,mrktlat) %>%
  select(
    # place = mrkt.name,
    ward = mrkt.ward, 
     district = mrkt.district, 
     region = mrkt.region, 
     long = mrktlong, 
     lat = mrktlat) %>%
  
  # Join unique origin and destinations:
  bind_rows(
    OD_unique_gps %>%
      select(
        # place = origin.place,
        ward = od.ward,
             district = od.district,
             region = od.region,
             long = od.long,
             lat = od.lat) 
  ) %>%
  distinct() %>%
  mutate(id = paste0("N", row_number())) %>%
  select(id, long, lat, ward, district, region)


```

# Origin - Destination data:

```{r origmrktOD_data}

# Join origins data to markets data to create OD dataframe:

origmrkt_OD <- mrktc_origins_gps %>%
  left_join(mrktc_gps_update %>% select(-c(gps.coordinates.of.the.market, unique.row.identifier.uuid., date, country)),
            by = "fid") %>%
  # exclude if no GPS data:
  filter(! (is.na(mrktlong)|is.na(mrktlat)|is.na(origlong)|is.na(origlat))) %>%
  mutate(flow = "origmrkt") %>%
  rename(od.ward = origin.ward,
         od.district = origin.district,
         od.region = origin.region, 
         od.place = origin.place, 
         odlong = origlong,
         odlat = origlat)

mrktdest_OD <- mrktc_gps_update %>% 
  select(-c(gps.coordinates.of.the.market, unique.row.identifier.uuid., date, country)) %>%
  left_join(mrktc_dests_gps, by = "fid") %>%
  # exclude if no GPS data:
  filter(!(is.na(mrktlong)|is.na(mrktlat)|is.na(destlong)|is.na(destlat))) %>%
  mutate(flow = "mrktdest") %>%
  rename(od.ward = dest.ward,
         od.district = dest.district,
         od.region = dest.region, 
         od.place = dest.place, 
         odlong = destlong,
         odlat = destlat)


fullnet <- origmrkt_OD %>%
  bind_rows(mrktdest_OD) %>%

  # join market ID
  left_join(nodes %>% select(region,district,ward, "mrktid" = id),
            by = c("mrkt.region" = "region", "mrkt.district" = "district", "mrkt.ward" = "ward")) %>%
  # join origin ID
  left_join(nodes %>% select(region,district,ward, "odid" = id),
            by = c("od.ward" = "ward","od.district" = "district","od.region" = "region"))

fulledges <- fullnet %>%
  # exclude within-ward /same market movements
  filter(!(mrktid == odid)) %>%
  # select IDs
  group_by(odid, mrktid) %>%
  count() %>%
  select(from = odid, to = mrktid, weight = n)


```


```{r net1}

g <- graph_from_data_frame(fulledges, directed = TRUE, vertices = nodes)


edges_for_plot <- fulledges %>%
  inner_join(nodes %>% select(id, long, lat), by = c('from' = 'id')) %>%
  rename(x = long, y = lat) %>%
  inner_join(nodes %>% select(id, long, lat), by = c('to' = 'id')) %>%
  rename(xend = long, yend = lat)

assert_that(nrow(edges_for_plot) == nrow(fulledges))

nodes$weight = degree(g)


full_moves <- ggplot(nodes) + 
  geom_sf(data = tregs_shp) +
  geom_curve(
    data = edges_for_plot,
    aes(x = x, 
        y = y, 
        xend = xend, 
        yend = yend,     # draw edges as arcs
        color = weight),
    arrow = arrow(length=unit(0.2,"cm")),
    size = 1)+
  geom_point(data = nodes, aes(x = long, y = lat), col = "white", alpha = 0.5)+
  geom_sf(data = mrktc_ward_sf, col = "red")


full_moves



```


```{r net2}

origedges <- fullnet %>%
  filter(flow == "origmrkt") %>%
  # exclude within-ward /same market movements
  filter(!(mrktid == odid)) %>%
  # select IDs
  group_by(odid, mrktid) %>%
  count() %>%
  select(from = odid, to = mrktid, weight = n)

orignodes <- nodes %>% 
  filter(id %in% c(origedges$from, origedges$to))

g_orig <- graph_from_data_frame(origedges, directed = TRUE, vertices = orignodes)


edges_for_plotorig <- origedges %>%
  inner_join(orignodes %>% select(id, long, lat), by = c('from' = 'id')) %>%
  rename(x = long, y = lat) %>%
  inner_join(orignodes %>% select(id, long, lat), by = c('to' = 'id')) %>%
  rename(xend = long, yend = lat)

assert_that(nrow(edges_for_plotorig) == nrow(origedges))

orignodes$weight = degree(g_orig)


orig_moves <- ggplot(orignodes) + 
  geom_sf(data = tregs_shp) +
  geom_curve(
    data = edges_for_plotorig,
    aes(x = x, 
        y = y, 
        xend = xend, 
        yend = yend,     # draw edges as arcs
        color = weight),
    arrow = arrow(length=unit(0.2,"cm")),
    size = 1)+
  geom_point(data = orignodes, aes(x = long, y = lat), col = "white", alpha = 0.5)+
  geom_sf(data = mrktc_ward_sf, col = "red")


orig_moves



```

```{r net23}

destedges <- fullnet %>%
  filter(flow == "mrktdest") %>%
  # exclude within-ward /same market movements
  filter(!(mrktid == odid)) %>%
  # select IDs
  group_by(odid, mrktid) %>%
  count() %>%
  select(from = odid, to = mrktid, weight = n)

destnodes <- nodes %>% 
  filter(id %in% c(destedges$from, destedges$to))

g_dest <- graph_from_data_frame(destedges, directed = TRUE, vertices = destnodes)


edges_for_plotdest <- destedges %>%
  inner_join(destnodes %>% select(id, long, lat), by = c('from' = 'id')) %>%
  rename(x = long, y = lat) %>%
  inner_join(destnodes %>% select(id, long, lat), by = c('to' = 'id')) %>%
  rename(xend = long, yend = lat)

assert_that(nrow(edges_for_plotdest) == nrow(destedges))

destnodes$weight = degree(g_dest)


dest_moves <- ggplot(destnodes) + 
  geom_sf(data = tregs_shp) +
  geom_curve(
    data = edges_for_plotdest,
    aes(x = x, 
        y = y, 
        xend = xend, 
        yend = yend,     # draw edges as arcs
        color = weight),
    arrow = arrow(length=unit(0.2,"cm")),
    size = 1)+
  geom_point(data = destnodes, aes(x = long, y = lat), col = "white", alpha = 0.5)+
  geom_sf(data = mrktc_ward_sf, col = "red")


dest_moves


ggarrange(full_moves, orig_moves, dest_moves, nrow = 1)

```





```{r distorigchloro}

dist_exchange_df <- mrktOD_df %>% 
  mutate(distexchange = if_else(origin.district == mrkt.district, "within", "other")) %>%
  group_by(mrkt.district, distexchange) %>%
  count() %>%
  ungroup()

dist_within_shp <- tdists_shp %>%
  left_join(dist_exchange_df %>% filter(distexchange == "within") %>% select(-distexchange), 
            by = c("Dist20_N" = "mrkt.district"))

dist_outside_shp <- tdists_shp %>%
  left_join(dist_exchange_df %>% filter(distexchange == "other") %>% select(-distexchange), 
            by = c("Dist20_N" = "mrkt.district"))

dist_within <- ggplot() +
  geom_sf(data = dist_within_shp, aes(fill = n))+
  labs(title = "Within-District")

dist_outside <- ggplot() +
  geom_sf(data = dist_outside_shp, aes(fill = n))+
  labs(title = "Outside-District")

origin_districts <- ggarrange(dist_within, dist_outside, ncol = 1)
```




<!-- ```{r dstrctnetwork} -->
<!-- # Origin Destination data between distinct districts: -->

<!-- mrktorig_OD <- mrktorig_df %>% -->
<!--     mutate(orig_distreg = paste(`2.sell.place.district.final`, `2.sell.place.region.final`, sep = "-"), -->
<!--            mrkt_distreg = paste(`mrkt.district`,`mrkt.region`, sep = "-")) %>% -->
<!--   select(fid,orig_distreg,mrkt_distreg) %>% -->
<!--   group_by(orig_distreg,mrkt_distreg) %>% -->
<!--   count() %>% -->
<!--   # remove self-self loops: -->
<!--   filter(!orig_distreg == mrkt_distreg) -->


<!-- ############### -->
<!-- mrktorig_net <- graph_from_data_frame(d = mrktorig_OD) -->
<!-- # network <- graph_from_data_frame(d = mrktc_orignetwork, directed = TRUE) -->


<!-- plot(mrktorig_net) -->
<!-- plot(mrktorig_net, edge.width = E(mrktorig_net)$n) -->

<!-- ggraph(mrktorig_net, layout = "fr") +  # Using the Fruchterman-Reingold layout -->
<!--   geom_edge_link(aes(width = n), color = "gray") +  -->
<!--   geom_node_point(color = "blue", size = 5) + -->
<!--   geom_node_text(aes(label = name), repel = TRUE, size = 3) + -->
<!--   theme_graph() +  -->
<!--   labs(title = "Network Visualization with ggraph") -->

<!-- ``` -->


<!-- ```{r wardmvmtmap}  -->
<!-- # Assuming 'movements' has columns: origin_lon, origin_lat, destination_lon, destination_lat, and num_movements -->

<!-- # AA: We used R [35], a language and environment for statistical computing, as well as add-on -->
<!-- # packages (ggplot,flows,network) [36, 37] to perform data analysis and plotting -->

<!-- ``` -->




```{r dests}

# Subset only origin data (2021 rows with origin data)
mrktc_dests <- mrktc_origdest %>%
  select(
    fid,
    dest.ward = `6.buy.place.ward.final`,
    dest.district = `6.buy.place.district.final`,
    dest.region = `6.buy.place.region.final`
  ) %>%
  drop_na() %>%
  mutate(
    dest.place = dest.ward
  )


# ORIGIN GPS DATA
# - Add ward centroid gps coords for each market:

mrktc_destspt_sf <- mrktc_dests %>%
  # join tanzania ward polygons to origins data:
  left_join(
    twards_shp %>% select(Region20_N, Dist20_N, Ward_N, geometry),
    by = c(`dest.ward` = "Ward_N", 
           `dest.district` = "Dist20_N",
           `dest.region` = "Region20_N")
  ) %>%
  st_as_sf() %>%
  # transform to point data (centroid/central point within ward)
  st_point_on_surface()

## CREATE REF (LONG-LAT) DF
# - update locations of markets which are surveyed using mtka_gps data:

mrktc_destspt_gps <- mrktc_destspt_sf %>%
  st_drop_geometry() %>%
  mutate(destlong = st_coordinates(mrktc_destspt_sf)[,1],
         destlat = st_coordinates(mrktc_destspt_sf)[,2]) # %>%
  # join mrktc market location data if appearing as origins
  # left_join(
  #   mrktc_pts_gps %>% distinct(mrkt.ward,mrkt.district,mrkt.region,mrktlong,mrktlat),
  #   by = c("2.sell.place.ward.final" = "mrkt.ward",
  #          "2.sell.place.district.final" = "mrkt.district",
  #          "2.sell.place.region.final" = "mrkt.region")
  # ) %>%
  # # update origin lon/lat with market locations
  # mutate(origlong = if_else(is.na(mrktlong), origlong, mrktlong),
  #        origlat = if_else(is.na(mrktlat), origlat, mrktlat))

dests_unique_gps <- mrktc_destspt_gps %>%
  select(-c(fid, dest.place)) %>%
  distinct()
  
```


```{r nodes}

nodes <- mrktc_ward_gps %>%
  #distinct(mrkt.ward,mrkt.district,mrkt.region, mrktlong,mrktlat) %>%
  select(
    # place = mrkt.name,
    ward = mrkt.ward, 
     district = mrkt.district, 
     region = mrkt.region, 
     long = mrktlong, 
     lat = mrktlat) %>%
  bind_rows(
    dests_unique_gps %>%
      select(
        # place = origin.place,
        ward = dest.ward,
             district = dest.district,
             region = dest.region,
             long = destlong,
             lat = destlat)
  ) %>%
  distinct() %>%
  mutate(id = paste0("M", row_number()),
         nodetype = if_else(ward==mrktc_ward_gps$mrkt.ward & 
                              district == mrktc_ward_gps$mrkt.district & 
                              region == mrktc_ward_gps$mrkt.region,
                            "mrktsrvy",
                            "dest")) %>%
  select(id, long, lat, nodetype, ward, district, region)


```

# Origin - Destination data:

```{r }

# Join origins data to markets data to create OD dataframe:

mrktOD_df <- mrktc_pts_gps %>%
  select(-c(gps.coordinates.of.the.market, unique.row.identifier.uuid.)) %>%
  # Join origin gps data:
  left_join(mrktc_destspt_gps, by = "fid") %>%
  # exclude if no GPS data:
  filter(! (is.na(mrktlong)|is.na(mrktlat)|is.na(destlong)|is.na(destlat))) %>%
  # join market ID
  left_join(nodes %>% select(region,district,ward,"mrktid" = id),
            by = c("mrkt.region" = "region", "mrkt.district" = "district", "mrkt.ward" = "ward")) %>%
  # join origin ID
  left_join(nodes %>% select(region,district,ward,"destid" = id),
            by = c("dest.ward" = "ward","dest.district" = "district","dest.region" = "region"))

edges <- mrktOD_df %>%
  # exclude within-ward /same market movements
  filter(!(mrktid == destid)) %>%
  # select IDs
  group_by(destid, mrktid) %>%
  count() %>%
  select(from = mrktid, to = destid, weight = n)


```


```{r net1}

g <- graph_from_data_frame(edges, directed = TRUE, vertices = nodes)


edges_for_plot <- edges %>%
  inner_join(nodes %>% select(id, long, lat), by = c('from' = 'id')) %>%
  rename(x = long, y = lat) %>%
  inner_join(nodes %>% select(id, long, lat), by = c('to' = 'id')) %>%
  rename(xend = long, yend = lat)

assert_that(nrow(edges_for_plot) == nrow(edges))

nodes$weight = degree(g)


destination_moves <- ggplot(nodes) + 
  geom_sf(data = tregs_shp) +
  geom_curve(
    data = edges_for_plot,
    aes(x = x, 
        y = y, 
        xend = xend, 
        yend = yend,     # draw edges as arcs
        color = weight),
    arrow = arrow(length=unit(0.2,"cm")),
    size = 1)+
  geom_point(data = nodes, aes(x = long, y = lat), col = "white")+
  geom_point(data = nodes %>% filter(nodetype == "mrktsrvy"),
             aes(x = long, y = lat), col = "red")


```


```{r distdestchloro}

dist_exchange_df <- mrktOD_df %>% 
  mutate(distexchange = if_else(dest.district == mrkt.district, "within", "other")) %>%
  group_by(mrkt.district, distexchange) %>%
  count() %>%
  ungroup()

dist_within_shp <- tdists_shp %>%
  left_join(dist_exchange_df %>% filter(distexchange == "within") %>% select(-distexchange), 
            by = c("Dist20_N" = "mrkt.district"))

dist_outside_shp <- tdists_shp %>%
  left_join(dist_exchange_df %>% filter(distexchange == "other") %>% select(-distexchange), 
            by = c("Dist20_N" = "mrkt.district"))

dist_within <- ggplot() +
  geom_sf(data = dist_within_shp, aes(fill = n))+
  labs(title = "Within-District")

dist_outside <- ggplot() +
  geom_sf(data = dist_outside_shp, aes(fill = n))+
  labs(title = "Outside-District")

destination_districts <- ggarrange(dist_within, dist_outside, ncol = 1)
```


```{r }

ggarrange(origin_moves, destination_moves, labels = c("tomrkt", "frommrkt"))

ggarrange(origin_districts, destination_districts, labels = c("tomrkt", "frommrkt"))

```
