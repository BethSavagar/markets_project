---
title: "Tanzania Market Survey C: Descriptive Analysis"
author: "Beth Savagar"
date: "2024-01-25"
output:
  html_document: 
    toc: true
    toc_depth: 2
    df_print: paged
---

<style type="text/css">
   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)
library(rmarkdown)

```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C")
```

```{r load-data, include = F}
#tanzania map: 

# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tza_admbnda_adm1_20181019.shp")) %>% # with region boundaries
   rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
  )

twards_shp <- st_read(here("data/shapefiles/tza_admbnda_adm3_20181019.shp")) %>% # with ward boundaries
    rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
    "District_N" = ADM2_EN,
    "District_C" = ADM2_PCODE,
    "Ward_Name"=ADM3_EN,
    "Ward_Code"= ADM3_PCODE
  )

mrkta_gps <- read_csv(here("data/tanzania_data/mrkta_gps_tanzania_final.csv"))
#mrktc_gps <- read_csv(here("data/tanzania_data/mrktc_allgps_tanzania_final.csv"))

# mrkta_generalinfo, need to link to cleaned update market location data
mrktc_info <-  read_csv(here("data/data-cleaning_data/mrktc_generalinfo_tanzania_final.csv"))
mrktc_gps <-  mrktc_info %>% select(
  fid, 
  date, 
  date.final,
  country, 
  region.final,
  district.final,
  ward.final,
  village.final,
  market.final,
  gps.coordinates.of.the.market = gps.coordinates.of.the.market.final,
  unique.row.identifier.uuid.
)


# # link mrktc Info to clean gps data and retain only variables of interest
# mrktc_info <- left_join(
#   mrktc_info_CLEAN %>% select(-c(contains(".code"), contains(".name"), contains("village"))),
#   mrktc_gps %>% select(-c(country, uniqueMrkt.check)),
#   by = c("fid","date", "unique.row.identifier.uuid.")) %>% # can't join by "gps.coordinates.of.the.market" as some rows of original data have no location.
#   select(
#     fid,
#     contains("date"),
#     country,
#     ends_with(".check"),
#     everything(),
#     gps.coordinates.of.the.market.check = gps.coordinates.of.the.market.y,
#     unique.row.identifier.uuid.
#   )

```

```{r lookups, include = F, eval = T}
lkp_mrkttype<- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpmrkt_type.csv"))
```

# Map of Survey C Locations
- Triangles indicate market survey C locations
- Circles indicate market survey A locations

```{r mrktcMap, include = F}

# Market A Map Data
mrkta_mapdata <- mrkta_gps %>%
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>%
  filter(!is.na(lat), !is.na(long))

mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)

# Market C Map Data  
mrktc_mapdata <- mrktc_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  filter(!is.na(lat), !is.na(long))

mrktc_sf <- st_as_sf(mrktc_mapdata, coords = c("long","lat"),  crs = 4326)

Regions_Cmanual <- mrktc_sf %>% pull(region.final) %>% unique() %>% str_to_title()

mrktc_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_Nam %in% Regions_Cmanual), aes(fill = Region_Nam),alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), alpha = 0.5, size = 3)+
   geom_sf(data = mrktc_sf, aes(col = region.final),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_fill_manual(values=rep(market_pal,2), guide = "none")+
  scale_colour_manual(values = rep(market_pal,2))+
  coord_sf()+
  labs(title = "Market survey C locations",
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

```

```{r mapPrint, echo = F, warning= F}
mrktc_mapByReg
```

# Market Survey C Data: Overview

- Market survey C is the buyer-seller questionnaire
- There is one row per survey.
- The "General Information" section contains details about: ...
- The "Market Activities" section contains details about:

*From the EcoPPR Field Guide:*

- Questionnaire by face-to-face interview with individual people who are buying and/or selling animals in the market, about the sources and destinations of the animals, the reasons for buying and/or selling, transport method, trading patterns and disease problems.

**Data Collection Method**

- A minimum of 20 people should be interviewed, or 10% of the people buying and/or selling in the market, whichever is greater, depending on the size of the market. 
- The people to be interviewed should be selected randomly or systematically to obtain a representative sample of all types of buyer and sellers and to avoid bias. 
    - The research team for each country should discuss how their markets are laid out and make a plan of how to obtain an unbiased sample. 
    - If the markets are laid out in a rectangular enclosure, then the field team should walk a transect from one corner of the market, diagonally across the market area to the opposite corner, interviewing every person buying and selling that they meet along the transect. Having completed one transect, if more interviews are required, a second transect can be made starting in a different corner. 
    - If the market is circular with all the people buying and selling arranged around the edge with very few in the middle, then the team can start at one point and move around the edge of the circle, interviewing everyone that they meet. 
    - Having completed the transects or circle, it may become clear that some key types of buyers or sellers have been missed e.g. sometimes the commercial traders are very busy and moving quickly in the market place so the team has not managed to meet many during the transect. In this case, they can be purposively tracked down for interview in addition to the 20 people/10% people interviewed in the main market area

<br>

## 1) What fields are contained in the cleaned survey data? {#fields}

- Market survey identifiers: date, location data
- Market info: market type, respondent role (trader or otherwise), number of markets visited

```{r raw_fields, echo = F, warning = F}

# Fields contained in market A data:
colnames(mrktc_info)
```

## 2) How many surveys are there, in total?
- How many surveys were completed?
- How many surveys were completed at each market?
- *Each row of data corresponds to a unique market survey (C)*
- *Each survey is associated with a unique market name, which can be used to group data*

```{r num_mrkts, echo =F, warning=F}

# Check market names are unique:
# mrktc_info %>% distinct(region.final,district.final,ward.final,village.final,market.final) %>% nrow()
# mrktc_info %>% distinct(market.final) %>% nrow()

mrktc_info <- mrktc_info %>%
  mutate(uniqueMrkt = paste(region.final,district.final,ward.final,village.final,market.final, sep = "-"))

num_srvy <- nrow(mrktc_info)
print(paste("There are ", num_srvy, " rows of data corresponding to unique surveys."))

# Distinct market names (can be used as identifier):
num_mrkt <- mrktc_info %>% distinct(uniqueMrkt) %>% nrow()
print(paste("There are ", num_mrkt, " unique markets"))

```

## 3) Surveys per Market {.tabset}

*How many surveys were completed at each Market?*

### Surveys per Market (All)

- According to field design there should be a minimum of 20 surveys conducted at each market.
- This is true for most markets except those in Mtwara, Ruvuma and Lindi
  - Ruvuma and Lindi markets are on boundary/visited due to vicinity to Mtwara. 

```{r srvymrkt, echo = F}

srvyCount <- mrktc_info %>% group_by(region.final, uniqueMrkt) %>% count() 
srvyCount %>% paged_table()

```

### Surveys per Market (<20)

- Markets with fewer than 20 surveys:

```{r srvymrkt20, echo = F}

mrktc_info %>% group_by(region.final, uniqueMrkt) %>% count() %>% filter(n<20) %>% paged_table()
```

### Surveys per Market (Histogram)

- Histogram of number of surveys at each market location

```{r srvyhist, echo = F}

# distribution of surveys at each market
ggplot(srvyCount, aes(x=n))+
  geom_histogram(binwidth = 5, boundary = 0, col = "black", alpha = 0.5)+
  labs(x = "Surveys per market", y = "Count")
```

### Surveys per Market (No Mtwara)

- Histogram of number of surveys at each market location **excluding** informal Mtwara markets

```{r srvyhistNOMtwara, echo = F}

# excluding mtwara:
ggplot(srvyCount %>% filter(region.final != "mtwara"), aes(x=n))+
  geom_histogram(binwidth = 5, boundary = 0, col = "black", alpha = 0.5)+
  labs(x = "Surveys per market", y = "Count")
```


### Market Surveys - by Region (boxplot)
```{r salesRegBox, echo = F, warning = F}

# function for number of observations
give.n <- function(x){
  return(c(y = max(x)*1.1, label = length(x)))
  # experiment with the multiplier to find the perfect position
}

# plot
# median number of surveys at each market, grouped by region:

ggplot(srvyCount,
       # reorder(Species, Sepal.Width, FUN = median)
       aes(x=reorder(region.final,-n,FUN=median, desc.=F), y=n))+
  geom_boxplot(aes(fill = region.final), alpha = 0.5)+
  geom_jitter(position = position_dodge(width = 0))+
  geom_hline(yintercept = 20, linetype = "dashed")+
  scale_fill_manual(values = rep(market_pal,2))+
  stat_summary(fun.data = give.n, geom = "text", fun.y = max)+
  labs(x="Region", y = "Surveys per market")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```



## Market Type: {.tabset}

- Each respondent is asked the type of market. This question is also asked in market survey A (all reported as primary market)
- Theoretically all respondents at a given market should respond with the same market type designation
- This is not the case so this data is not very reliable.

**Market Type Definitions**

- Primary market: located close to the place of production or rearing of small ruminants, usually located within villages or small towns.
-	Secondary market: usually found in suburbs, animals are transported some distance from their place of production/rearing to the market.
-	Tertiary or final consumption market: generally located in towns or populated areas to supply urban populations, animals are transported quite a long-distance from their place of production/rearing.

### Market Type (Overall)

```{r mrkt_type, echo = F}
mrktc_info %>% 
  left_join(lkp_mrkttype %>% select(market.type.lkp = Description, market.type = Code), by = "market.type") %>%
  group_by(market.type.lkp) %>% 
    count() %>% 
    paged_table()

```

### Market Type (Regional)

```{r mrkt_typeReg, echo = F}
typeReg_tally <- mrktc_info %>% 
  left_join(lkp_mrkttype %>% select(market.type.lkp = Description, market.type = Code), by = "market.type") %>%
  group_by(region.final, market.type.lkp) %>% 
  count() %>%
  ungroup %>%
  complete(region.final, market.type.lkp,
           fill = list(n = 0)) 

paged_table(typeReg_tally %>% spread(key = market.type.lkp, value = n, fill = 0))

```
### Market Type (Regional) - Hist

```{r mrkt_typeRegplot, echo = F}

ggplot(typeReg_tally, aes(x=region.final, y = n, group = market.type.lkp))+
  geom_col(position = position_dodge(), aes(fill = market.type.lkp), alpha = 0.5, col = "black")

```

<!-- ## Respondent Role: -->

<!-- - Respondent role is reported in Swahili, free-type box -->
<!-- - Translate into English? -->

<!-- ```{r roles, echo = F} -->

<!-- # identify unique roles and concatenate into a string: -->

<!-- roles_lkp <- mrktc_info %>%  -->
<!--   distinct(respondent.role) %>% -->
<!--   mutate(respondent.role = tolower(respondent.role), # lowercase -->
<!--           respondent.role = gsub("[[:punct:]]", " ", `respondent.role`), # remove punctuation -->
<!--     "respondent.role" = trimws(`respondent.role`), -->
<!--     "respondent.role" = gsub("\\s+", " ", `respondent.role`)) %>% -->
<!--   pull() %>%  -->
<!--   paste(collapse = "; ") -->

<!-- # Translate using chatGPT? -->

<!-- ``` -->

## Trade & Market Attendance {.tabset}

- Number/proportion of tradespeople attending a market can be useful in determining the "type" of that market.

*The total proportion of tradespeople in the data:*

```{r tradersAll, echo = F, warning = F}
tradeprop <- round((sum(mrktc_info$trader)*100)/nrow(mrktc_info), digits = 2)
print(paste("Overall", tradeprop, "% of respondents identified as Traders (", sum(mrktc_info$trader), "out of", nrow(mrktc_info), "respondents)"))

# Traders total:

mrktc_info %>% 
  group_by(trader) %>% 
  count() %>%
  ungroup() %>%
  mutate(prop = round(n/sum(n), digits = 2)) %>%
  paged_table()

```

### Traders per Market (Hist)

- The number of traders per market:

<div class = "row">
<div class = "column">
```{r mrktTradersFig, echo = F, warning = F}
tradersbymrkt <- mrktc_info %>% 
  group_by(region.final, market.final, trader) %>% 
  count() %>%
  ungroup() %>%
  group_by(market.final) %>%
  mutate(prop = round(n/sum(n), digits = 2))

ggplot(tradersbymrkt %>% filter(trader == 1), aes(x=n))+
  geom_histogram(binwidth = 2, alpha = 0.5, col = "black", position = "dodge")+
  scale_x_continuous(breaks = seq(0,70,10), labels = seq(0,70,10))+
  labs(x = "Number of Traders", y = "Count", title = "All")

```
</div>

<div class = "column">
```{r mrktTraders2Fig, echo = F, warning = F}

ggplot(tradersbymrkt %>% filter(trader == 1, region.final != "mtwara"), aes(x=n))+
  geom_histogram(binwidth = 2, alpha = 0.5, col = "black", position = "dodge")+
  scale_x_continuous(breaks = seq(0,70,10), labels = seq(0,70,10))+
  labs(x = "Number of Traders", y = "Count", title = "Excluding Mtwara")

```
</div>
</div>

### Traders per market (table)

- The number and proportion of traders at each market:

```{r mrktTradersTab, echo = F, warning = F}

paged_table(tradersbymrkt)
```

### Proportion traders per market (hist)

- The proportion of traders at each market:
<div class = "row">
<div class = "column">
```{r mrktTradersPFig, echo = F, warning = F}

ggplot(tradersbymrkt %>% filter(trader == 1), aes(x=prop))+
  geom_histogram(binwidth = 0.05, alpha = 0.5, col = "black", position = "dodge")+
  #scale_x_continuous(breaks = seq(0,70,10), labels = seq(0,70,10))+
  labs(x = "Proportion of Traders", y = "Count", title = "All")
```
</div>
<div class = "column">
```{r mrktTradersP2Fig, echo = F, warning = F}
ggplot(tradersbymrkt %>% filter(trader == 1, region.final != "mtwara"), aes(x=prop))+
  geom_histogram(binwidth = 0.05, alpha = 0.5, col = "black", position = "dodge")+
  #scale_x_continuous(breaks = seq(0,70,10), labels = seq(0,70,10))+
  labs(x = "Proportion of Traders", y = "Count", title = "Excluding Mtwara")

```
</div>
</div>

### Traders per market - by Region

```{r mrktTradeReg, echo = F, warning = F}
ggplot(tradersbymrkt %>% filter(trader == 1), 
       aes(x=reorder(region.final,-prop,FUN=median, desc.=F),y = prop, group = region.final))+
  geom_boxplot(aes(fill = region.final), alpha = 0.5)+
  scale_fill_manual(values = rep(market_pal, 2))+
  labs(x = "Region", y = "Proportion traders per market")+
  theme(legend.position = "none")

```


```{r tradersperregion, include = F}
# Traders by region
# 
# mrktc_info %>% 
#   group_by(region.final, trader) %>% 
#   count() %>%
#   ungroup() %>%
#   group_by(region.final) %>%
#   mutate(prop = round(n/sum(n), digits = 2))
```


## Other Market Attendance {.tabset}

### Other Market Attendance (All)

Attendance at other markets by respondents to buyer-seller questionnaire

<div class = "row">
<div class = "column">
```{r othermrktTab, echo = F, warning = F}

mrktc_info %>% group_by(number.markets.visited) %>% count() %>% paged_table()
```
</div>

<div class = "column">
```{r othermrktFig, echo = F, warning = F}
ggplot(mrktc_info, aes(x=number.markets.visited))+
  geom_histogram(binwidth = 1, alpha = 0.5, col = "black", position = "dodge")+
  scale_x_continuous(breaks = seq(0,10,1), labels = seq(0,10,1))+
  labs(x = "Other markets visited", y = "Count")
```
</div>
</div>

### Other Market Attendance (Trader)

- Market attendance grouped by trader

<div class = "row">
<div class = "column">
```{r othermrktTrader, echo = F, warning = F}
mrktc_info %>% group_by(number.markets.visited, trader) %>% count() %>% paged_table()
```
</div>

<div class = "column">
```{r othermrktTraderPlot, echo = F, warning = F}
ggplot(mrktc_info, aes(x=number.markets.visited, group = trader, fill = as.factor(trader)))+
  geom_histogram(binwidth = 1, alpha = 0.5, col = "black", position = "dodge")+
  scale_x_continuous(breaks = seq(0,10,1), labels = seq(0,10,1))+
  labs(x = "Other markets visited", y = "Count", fill = "Trader")

```
</div>
</div>

### Market attendance by region

```{r mrktReg, echo = F, warning = F}

ggplot(mrktc_info, aes(x=factor(region.final), y = number.markets.visited, fill = as.factor(trader)))+
  geom_boxplot(alpha = 0.5, position = "dodge")+
  labs(x = "Regions", y = "Market Attendance", fill = "Trader")
```

### Market attendance by region (Traders) - boxplot

- Boxplot of number of markets visited, by trader, in each region

```{r mrktRegtrader, echo = F, warning = F}
# Only traders
ggplot(mrktc_info %>% filter(trader==1), 
       aes(x=factor(reorder(region.final, -number.markets.visited, FUN = median, desc.=F)), y = number.markets.visited))+
  geom_boxplot(alpha = 0.5, position = "dodge", fill = "grey")+
  labs(x = "Regions", y = "Number markets visited")

```

### Market attendance by region (Traders) - histogram

- Number markets visited grouped, by trader, in each region

```{r othermrktRegionPlot, echo = F, warning = F}

ggplot(mrktc_info, aes(x=number.markets.visited, group = trader, fill = as.factor(trader)))+
  geom_histogram(binwidth = 1, alpha = 0.5, col = "black", position = "dodge")+
  scale_x_continuous(breaks = seq(0,10,1), labels = seq(0,10,1))+
  labs(x = "Other markets visited", y = "Count", fill = "Trader")+
  facet_wrap(~region.final)

```


<!-- - Comparison of the proportion of traders at a market, and the number of other markets visited.  -->

<!-- ```{r trademrktscatter, echo = F, warning = F} -->
<!-- # Dataframe which contains the proportion of traders, and the median other markets visited for each market: -->
<!-- tradermrkts <- tradersbymrkt %>%  -->
<!--   ungroup() %>% -->
<!--   filter(trader == 1) %>% -->
<!--   left_join( -->
<!--     mrktc_info %>% group_by(region.final, market.final) %>% summarise(median.mrkts.visited = median(number.markets.visited), -->
<!--                                                                       tot.mrkts.visited = sum(number.markets.visited)), -->
<!--     by = c("region.final", "market.final") -->
<!--   ) %>% -->
<!--   select(-c(trader)) %>% -->
<!--   rename("number.traders" = n,  -->
<!--          "proportion.traders" = prop) -->

<!-- ggplot(tradermrkts, aes(x=proportion.traders, y = tot.mrkts.visited))+ -->
<!--   geom_point() -->


<!-- ``` -->


