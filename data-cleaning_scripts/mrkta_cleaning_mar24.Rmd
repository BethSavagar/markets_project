---
title: "Tanzania Market Survey A: Data Cleaning"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)

```

```{r load-data, include = F}

# read in tanzania market data (tanzania_data file contains original ecopprmarketscsvs filtered to Tanzania data only)

mrkta <- read_csv(here("data/tanzania_data/mrkta_generalinfo_tanzania.csv"))

## LOOKUPS ##
mrkta_lkpregion <- read_csv(here("data/ecopprmarketscsvs/mrkta_lkpregion.csv"))
mrkta_lkpward <- read_csv(here("data/ecopprmarketscsvs/mrkta_lkpward.csv"))

```

## Market Survey A Data: First Look

- Market survey A is the key informant interview. 
- There is one row (survey) per market. 
- The survey mostly contains contextual information that is not useful for my analysis
- Market Survey A should be used as a GPS reference for all markets in market survey C
- Also the number of small ruminants bought and sold at each market. 

*From the EcoPPR Field Guide:*

- Key informant interview with the market manager or other key person who is knowledgeable about the market, focusing on the general characteristics of the market. (1 survey per market)
- At each market, the field team will identify and arrange to meet with the market manager/person in-charge to introduce the project and obtain permission to collect data, and then conduct a short interview
<br>

### 1) Refine the Market A survey data to fields of interest:

```{r mrkta_fields, echo = F, warning = F}

# Fields contained in market A data:
colnames(mrkta) %>% kable()

# Select fields of interest: market location, small ruminant sales
mrkta_clean <- mrkta %>%
  left_join(mrkta_lkpward %>% select("Code", ward.name = "Description"),
            by = c(`ward.see.mrkta.lkpward.` = "Code")) %>%
  left_join(mrkta_lkpregion %>% select(Code,"district.region.name" = "Description"),
            by = c(`district.region.see.mrkta.lkpregion.` = "Code")) %>%
  select(
    fid = `fid.see.mrkta.idtable.`,
    date,
    country = `country.see.mrkta.lkpcountry.`,
    district.region.code = `district.region.see.mrkta.lkpregion.`,
    district.region.name,
    ward.code = `ward.see.mrkta.lkpward.`,
    ward.name,
    village,
    market.name = `name.of.market`,
    market.type = `type.of.market.see.mrkta.lkpmrkt.type.`,
    name.of.respondent,
    `1.location.brought.from` = `1.location.sold.from`, # misleading variable name from cleaning script
    `2.location.taken.to.`,
    `3a.no.sheep.sold.per.day`,
    `3b.no.goats.sold.per.day`,
    `4.seasonal.variation.in.trade`,
    `4.if.yes.describe`,
    `gps.coordinates.of.the.market`,
    `unique.row.identifier.uuid.` 
  ) 
```

### 2) Check Market & Village Names

- Clean the District-Ward-Village-Market data fields
- Use Market Survey A as the **master** list for district-ward-village-market & GPS information.

```{r mrkta_cleannames, echo=F,warning=F}
# CLEAN NAME DATA: district/region, ward, market, village

mrkta_clean <- 
  mrkta_clean %>%
  mutate(
    "district.region.name" = tolower(`district.region.name`), # all lower case
    "district.region.name" = gsub("[[:punct:]]", " ", `district.region.name`), # remove punctuation
    "district.region.name" = trimws(`district.region.name`), #trim leading and trailing spaces
    "district.region.name" = gsub("\\s+", ".", `district.region.name`)# replace 1+ spaces with "."
  ) %>%
  mutate(
    "ward.name" = tolower(`ward.name`),
    "ward.name" = gsub("[[:punct:]]", " ", `ward.name`), # remove punctuation
    "ward.name" = trimws(`ward.name`), #trim leading and trailing spaces
    "ward.name" = gsub("\\s+", ".", `ward.name`)# replace 1+ spaces with "."
  ) %>%
  mutate(
    "market.name" = tolower(`market.name`), # lowercase
    "market.name" = gsub("[[:punct:]]", " ", `market.name`), # remove punctuation
    "market.name" = trimws(`market.name`), #trim leading and trailing spaces
    "market.name" = gsub("\\s+", ".", `market.name`)# replace 1+ spaces with "."
  )  %>% 
  mutate(
    "village" = tolower(`village`), # lowercase
    "village" = gsub("[[:punct:]]", " ", `village`), # remove punctuation
    "village" = trimws(`village`),
    "village" = gsub("\\s+", ".", `village`)
  )
  
# head(mrkta_clean, n = 1) %>% kable()
colnames(mrkta_clean) %>% kable()


## Check distinct locations:

uniqmrkts <- mrkta_clean %>% 
  group_by(district.region.code, district.region.name, ward.code, ward.name, village, market.name) %>%
  mutate(dupe = n()>1)

```


```{r savedata, echo=F,warning=F}

# write.csv(mrkta_clean, file = "mrkta_generalinfo_tanzania_CLEAN.csv", row.names = F)

mrkta_gps <- mrkta_clean %>% select(
  fid,
  date,
  country,
  district.region.code,
  district.region.name,
  ward.code,
  ward.name,
  village,
  market.name,
  gps.coordinates.of.the.market,
  unique.row.identifier.uuid.
)

# write.csv(mrkta_clean, file = here("data/data-cleaning_data/mrkta_generalinfo_tanzania_CLEAN.csv"), row.names = F)
# write.csv(mrkta_gps, file = here("data/data-cleaning_data/mrkta_gps_tanzania_CLEAN.csv"), row.names = F)

```


