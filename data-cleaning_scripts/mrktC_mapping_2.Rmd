---
title: "marketC_mapping"
output: html_document
date: "2024-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}

library(sf)
library(here)
library(tidyverse)
library(RColorBrewer)
library(lwgeom)
library(ggpubr)

```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C", "#FFD700", "#1E90FF")
```


# Mapping Market Survey C Locations

- Load in market survey C data (following initial string cleaning)
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load in clean geomatched market survey A data.
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load Tanzania shapefile with ward boundaries
    - `r `"data/shapefiles/tza_admbnda_adm3_20181019.shp"`
    - Source <https://data.humdata.org/dataset/cod-ab-tza?> (ADM L3)

```{r data, include = T, warning = F, echo = F}

# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tza_admbnda_adm1_20181019.shp")) %>% # with region boundaries
   rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
  )

# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tza_admbnda_adm3_20181019.shp")) %>% # with ward boundaries
    rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
    "District_N" = ADM2_EN,
    "District_C" = ADM2_PCODE,
    "Ward_Name"=ADM3_EN,
    "Ward_Code"= ADM3_PCODE
  )

# Market A location data:
mrkta_gps <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_final.csv"))
mrkta_gps_join <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_manual+geomatch.csv")) %>%
  rename(ward.code.manual = ward.code,
         ward.name.manual = ward.name,
         village.manual = village, 
         market.name.manual = market.name.corrected
         )

# Market C location data:
# mrktc_clean3 <- read_csv(file = here("data/data-cleaning_data/mrktc_info_clean3-1.csv"))
mrktc_gps <- read_csv(file = here("data/tanzania_data/mrktc_gps_tanzania_CLEAN1.csv")) %>%
  rename(ward.code.manual = ward.code.3A,
         ward.name.manual = ward.name.3A,
         village.manual = village.3A, 
         market.name.manual = market.name.3A
         ) %>%
  filter(!is.na(gps.coordinates.of.the.market))

mrktc_gps_raw <- read_csv(file = here(
  "data/data-cleaning_data/mrktc_generalinfo_tanzania_CLEAN.csv"
)) %>%
  select(
    fid,
    date,
    date.end,
    date.of.interview,
    country,
    region.code.raw = district.region.code,
    region.name.raw = district.region.name,
    ward.code.raw = ward.code,
    ward.name.raw = ward.name,
    village.raw = village,
    market.name.raw = market.name,
    ward.code.manual = ward.code.3A,
    ward.name.manual = ward.name.3A,
    village.manual = village.3A,
    market.name.manual = market.name.3A,
    gps.coordinates.of.the.market,
    unique.row.identifier.uuid.
  ) %>%
  filter(!is.na(gps.coordinates.of.the.market))

```


## Market A Map
- Market A data, matched to Tanzania shapefile region-district-ward locations
- See `mrktA_mapping.Rmd`

```{r mrktaMap}
# convert mrkta location data to mapping format & map manually cleaned data:

mrkta_mapdata <- mrkta_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)

mrkta_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_map

# Map of market survey locations coloured by region (consistency with Tanzania shapefile)

Regions_Amanual <- mrkta_sf %>% pull(region.geomatch.final) %>% unique() %>% str_to_title()

mrkta_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_Nam %in% Regions_Amanual), aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations (coloured by stringRegion)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_mapByReg

# mrkta-manual string-location data is consistent with tanzania shapefile for REGION of origin. 

# mrkta-manual Descriptive stats:
# mrkta_gps %>% group_by(district.region.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(district.region.name, ward.name) %>% count() %>% filter(n>1) # mamba only appears in ward.name unique list
# mrkta_gps %>% filter(ward.name == "mamba")
# mrkta_gps %>% group_by(district.region.name, ward.name, village) %>% count() 
# mrkta_gps %>% group_by(district.region.name, ward.name, village, market.name.corrected) %>% count() 

```

## Market C Map (1)
- Location of market C surveys, overlaid on market A survey locations

```{r, mrktcMap_manual-cleaning}

mrktc_mapdata <- mrktc_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrktc_sf <- st_as_sf(mrktc_mapdata, coords = c("long","lat"),  crs = 4326) 

mrktC_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrktc_sf, aes(col = district.region.name), size = 1)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+ 
  labs(title = "Market survey C: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrktC_map

mrktCA_map <- ggplot() +
   geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), alpha = 0.5, size = 3)+
   geom_sf(data = mrktc_sf, aes(col = district.region.name),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
   scale_colour_manual(values = market_pal)+
   coord_sf()+
   labs(title = "Market Survey A-geoamtched (circles) and C-manual (triangles) data",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktCA_map

```


```{r datacheck}
# Check consistency between markets in mrkta_gps and mrktc_gps_raw (.manual)
mrkta_gps %>% distinct(region.geomatch.final, ward.geomatch.final, market.manual.final)
mrktc_gps_raw %>% distinct(region.name.raw, ward.name.manual, market.name.manual)

```
1) Market survey C - match to market survey A 
- Use market survey C gps locations to link to market survey A geo-matched data.
 - Each market survey C entry should be linked to a market identified in market survey A data.
 - Compare consistency between raw/manual survey C locations and A-linked survey locations.
 - Compare consistency between raw/manual survey C locations, overlaid on survey A locations
 - Compare consistently between A-linked survey C locations overlaid on survey A location (should be perfect match)


```{r mrktc_linkA}

# Join geomatched location data (from tanzania shapefile) to mrtka location data
mrktc_linkA_gps <- mrktc_gps %>%
  mutate(mrktaID = st_nearest_feature(mrktc_sf, mrkta_sf)) %>% 
  # join matched location data. by rowid (twardID)
  left_join(
    mrkta_mapdata %>%
      mutate(mrktaID = 1:nrow(.)) %>%
      select(
        mrktaID,
        "region.geomatch.final.A" = "region.geomatch.final",
        "district.geomatch.final.A" = "district.geomatch.final",
        "ward.geomatch.final.A" = "ward.geomatch.final",
        "village.manual.final.A" = "village.manual.final" ,
        "market.manual.final.A" = "market.manual.final"
        # "reg.ward.mrkt.final.A" = "reg.ward.mrkt.final"
      ),
    by = c("mrktaID")) %>%
  select(-mrktaID) 

colnames(mrktc_linkA_gps)

mrktc_linkA_mapdata <- mrktc_linkA_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

mrktc_linkA_sf <- st_as_sf(mrktc_linkA_mapdata, coords = c("long","lat"),  crs = 4326) 

## MAP
map_plots <- list()
regions <- mrktc_linkA_gps %>% distinct(region.geomatch.final.A) %>% pull()

for(i in 1:length(regions)){
  
  region_i <- regions[i]
  
  map_plots[[i]] <- ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_linkA_sf %>% filter(region.geomatch.final.A %in% region_i), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_Nam)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

# gridExtra::grid.arrange(grobs = map_plots, ncol = 3)
```

## Regions {.tabset}

### Dodoma

```{r dodomareg}
map_plots[[1]]
```

### Simiyu

```{r simiyureg}
map_plots[[2]]
```

### Mwanza

```{r mwanzareg}
map_plots[[3]]
```

### Katavi

```{r katavireg}
map_plots[[4]]
```

### Morogoro

```{r morogororeg}
map_plots[[5]]
```

### Mtwara

```{r mtwarareg}
map_plots[[6]]
```

### Mbeya

```{r mbeyareg}
map_plots[[7]]
```

### Rukwa

```{r}
map_plots[[8]]
```

### Iringa

```{r}
map_plots[[9]]
```

### Songwe

```{r}
map_plots[[10]]
```

### Njombe

```{r}
map_plots[[11]]
```

### Lindi

```{r}
map_plots[[12]]
```

### Ruvuma

```{r}
map_plots[[13]]
```




###### Check linkA market C locations 


```{r check_linkA}

mrktc_linkA_check <- mrktc_linkA_gps %>%
  left_join(mrktc_gps_raw %>% select(fid, ends_with(".raw")), by = "fid") %>%
  # create a unique field for checking data:
  mutate(
    uniqueMrkt = paste(
    region.geomatch.final.A,
    district.geomatch.final.A,
    # district data not included in survey
    ward.geomatch.final.A,
    village.manual.final.A,
    market.manual.final.A,
    sep = "-"
    )
  ) 


# How many unique markets are found in the linkA location data?

nrow(mrktc_linkA_check)

mrktc_linkA_check %>%
  distinct(region.geomatch.final.A, 
           district.geomatch.final.A,
           ward.geomatch.final.A, 
           village.manual.final.A,
           market.manual.final.A,
           uniqueMrkt)

# 83 unique market location names. 

uniqueMrkt_date_summary <- mrktc_linkA_check %>%
  # review number of survey dates associated with each market:
  group_by(region.geomatch.final.A,
           uniqueMrkt,
           date.of.interview,
           date) %>%
  count() %>% 
  ungroup() %>%
  arrange(uniqueMrkt)
```


2) On a region-by-region basis:
- Use c-geomatchA locations and group by survey date. 
- All surveys for a given market should be completed on the same day
- For surveys which seem to be inconsistent check the original mrktc location names etc. 

## DODOMA: 

```{r dodoma_clean}
regions[1]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "dodoma")
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "dodoma") %>% select(-region.geomatch.final.A)

#   uniqueMrkt                                     date.of.interview date           n
#    <chr>                                          <date>            <date>     <int>
#  1 dodoma-bahi-babayu-kongogo-kongogo             2022-05-11        2022-05-11    42  --> CORRECT
#  2 dodoma-bahi-bahi-bahi.sokoni-bahi              2022-06-02        2022-06-02    44  --> CORRECT
#  3 dodoma-bahi-ibihwa-mnkola-mnkola               2022-05-12        2022-05-12    29  --> CORRECT
#  4 dodoma-bahi-ibugule-nkhome-nkhome              2022-05-16        2022-05-14    48  --> CORRECT
#  5 dodoma-bahi-kigwe-kigwe-kigwe                  2022-05-13        2022-05-13    56  --> CORRECT
#  6 dodoma-bahi-lamaiti-lamaiti-lamaiti            2022-06-07        2022-06-07    45  --> CORRECT
#  7 dodoma-bahi-makanda-makanda-makanda            2022-05-18        2022-05-18    42  --> CORRECT
#  8 dodoma-bahi-msisi-msisi-msisi                  2022-05-23        2022-05-23    29  --> CORRECT
#  9 dodoma-bahi-mundemu-mundemu-mundemu            2022-06-04        2022-06-04    22  --> CORRECT
# 10 dodoma-bahi-nondwa-nondwa-nondwa               2022-05-21        2022-05-21    27  --> CORRECT
# 11 dodoma-bahi-zanka-mayamaya-mayamaya            2022-05-30        2022-05-25     1  --> Checked: Date Error (DoI is correct)
# 12 dodoma-bahi-zanka-mayamaya-mayamaya            2022-05-30        2022-05-30    39  --> CORRECT
# 13 dodoma-dodoma.urban-mpunguzi-mpunguzi-mpunguzi 2022-05-25        2022-05-25    35  --> CORRECT

mrktc_linkA_check %>% 
  filter(uniqueMrkt == "dodoma-bahi-zanka-mayamaya-mayamaya")

# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "dodoma") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()

# Update: 

mrktc_linkA_check2 <- mrktc_linkA_check %>%
  mutate(date.check = NA,
         uniqueMrkt.check = NA,
         date.check = ifelse(region.geomatch.final.A == "dodoma", as.character(date.of.interview), NA),
         uniqueMrkt.check = ifelse(region.geomatch.final.A == "dodoma", uniqueMrkt, NA))

# mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="dodoma") %>% group_by(date.check, uniqueMrkt.check) %>% count()

```
 
 
## simiyu: 

```{r simiyu_clean}
regions[2]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "simiyu") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "simiyu") %>% select(-region.geomatch.final.A)

# Error Codes: "Checked: Date Error"
#
#   uniqueMrkt                                         date.of.interview date           n
#   <chr>                                              <date>            <date>     <int>
# 1 simiyu-bariadi-bariadi-kidinda-kidinda             2022-05-17        2022-05-17    77 --> CORRECT
# 2 simiyu-bariadi-dutwa-igaganulwa-igaganulwa         2022-05-19        2022-05-19    84 --> CORRECT
# 3 simiyu-bariadi-dutwa-igaganulwa-igaganulwa         2022-05-28        2022-05-14     2 ** --> Checked: Location Error (mwasamba-mwasamba)
# 4 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-14        2022-05-14     2 ** --> Checked: Date Error (2022-05-28)
# 5 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-28        2022-05-14    18 ** --> Checked: Date Error (2022-05-28)
# 6 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-28        2022-05-28    79 --> CORRECT
# 7 simiyu-itilima-mwamapalala-mwamapalala-mwamapalala 2022-05-18        2022-05-18    34 --> CORRECT
# 8 simiyu-maswa-lalago-lalago-lalago                  2022-05-16        2022-05-16    45 --> CORRECT


# CHECKS:
# 3 simiyu-bariadi-dutwa-igaganulwa-igaganulwa
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "simiyu-bariadi-dutwa-igaganulwa-igaganulwa") %>%
  arrange(date)
  
# simiyu-bariadi-dutwa-igaganulwa-igaganulwa / 2022-05-28 DoI / 2022-05-14
# Correct to : simiyu-busega-lutubiga-mwasamba-mwasamba / 2022-05-28 DoI / 2022-05-28

########
# 4 simiyu-busega-lutubiga-mwasamba-mwasamba
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "simiyu-busega-lutubiga-mwasamba-mwasamba") %>%
  arrange(date)
  
# 4 simiyu-busega-lutubiga-mwasamba-mwasamba  / 2022-05-14 / 2022-05-14
# 5 simiyu-busega-lutubiga-mwasamba-mwasamba  / 2022-05-28 / 2022-05-14 
# Correct to : simiyu-busega-lutubiga-mwasamba-mwasamba / 2022-05-28 DoI / 2022-05-28

# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "simiyu") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   


# Update all simiyu markets to uniqueMrkt
# Update "simiyu-bariadi-dutwa-igaganulwa-igaganulwa" & date == "2022-05-14" to "simiyu-busega-lutubiga-mwasamba-mwasamba"
# Update all "simiyu-busega-lutubiga-mwasamba-mwasamba" to date "2022-05-28"

mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "simiyu", uniqueMrkt, uniqueMrkt.check),
    uniqueMrkt.check = ifelse(uniqueMrkt == "simiyu-bariadi-dutwa-igaganulwa-igaganulwa" & date == "2022-05-14", "simiyu-busega-lutubiga-mwasamba-mwasamba", uniqueMrkt.check),
    date.check = ifelse(region.geomatch.final.A == "simiyu", as.character(date), date.check),
    date.check = ifelse(uniqueMrkt.check == "simiyu-busega-lutubiga-mwasamba-mwasamba", "2022-05-28", date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="simiyu") %>% group_by(date.check, uniqueMrkt.check) %>% count()
```
 
## Mwanza: 

```{r mwanza_clean}
regions[3]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mwanza") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mwanza") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 3 × 4
#   uniqueMrkt                           date.of.interview date           n
#   <chr>                                <date>            <date>     <int>
# 1 mwanza-kwimba-ngudu-kakola-kakola    2022-05-21        2022-05-21    69 --> CORRECT
# 2 mwanza-magu-nkungulu-ndagalu-kabila  2022-05-23        2022-05-23    79 --> CORRECT
# 3 mwanza-misungwi-masasi-manawa-misasi 2022-05-25        2022-05-25    75 --> CORRECT


# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "mwanza") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()

# Update: All correct no cleaning required.


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "mwanza", uniqueMrkt, uniqueMrkt.check),
    date.check = ifelse(region.geomatch.final.A == "mwanza", as.character(date), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="mwanza") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()

```
 

## Katavi: 

```{r katavi_clean}


  region_i <- "katavi"
  ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_linkA_sf %>% filter(ward.geomatch.final.A == "itenka"), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_Nam)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
regions[4]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "katavi") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "katavi") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#    uniqueMrkt                                date.of.interview date           n
#    <chr>                                     <date>            <date>     <int>
#  1 katavi-mlele-inyonga-kinyonga-inyonga     2022-05-25        2022-05-25    53 --> CORRECT
#  2 katavi-mlele-itenka-itenka.a-itenka       2022-05-30        2022-05-30    40 --> CORRECT
#  3 katavi-mlele-itenka-itenka.a-itenka       2022-06-01        2022-06-01     1 --> Checked: Accept linkA
#  4 katavi-mlele-itenka-itenka.a-itenka       2022-06-03        2022-06-03    10 --> Checked: Location Error (minyagala)
#  5 katavi-mlele-kibaoni-kibaoni-kibaoni      2022-05-31        2022-05-31    30 --> CORRECT
#  6 katavi-mlele-majimoto-kitupa-majimoto.a   2022-05-22        2022-05-22    40 --> CORRECT
#  7 katavi-mlele-mamba-kilda.kona-kilda.kona  2022-05-31        2022-05-31    20 --> CORRECT
#  8 katavi-mlele-usevya-usevya-usevya         2022-05-23        2022-05-23    32 --> CORRECT
#  9 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-03        2022-06-03    37 --> CORRECT
# 10 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-05        2022-06-05     9 --> Checked: Unclear conclusion
# 11 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-03        2022-06-03     2 --> Checked: Unclear conclusion
# 12 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-05        2022-06-05    43 --> CORRECT

# Check "katavi-mlele-itenka-itenka.a-itenka"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka") %>%
  arrange(date)
  
# If date == 2022-06-01, correction to rukwa-kilyamatundu
# If date == 2022-06-03, correction to katavi-mpanda-kabungu-minyagala-minyagala

# check "katavi-mpanda-kabungu-minyagala-minyagala"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-kabungu-minyagala-minyagala") %>%
  arrange(date)
  
# If date == 2022-06-05 looks like correction may be: katavi-mpanda-sibwesa-sibwesa-sibwesa

# check "katavi-mpanda-sibwesa-sibwesa-sibwesa"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-sibwesa-sibwesa-sibwesa") %>%
  arrange(date)
  
# If date == 2022-06-03 looks like correction may be "katavi-mpanda-kabungu-minyagala-minyagala"


# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "katavi") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "katavi", uniqueMrkt, uniqueMrkt.check),
    uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka" & date == "2022-06-03", "katavi-mpanda-kabungu-minyagala-minyagala", uniqueMrkt.check),
    uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mpanda-kabungu-minyagala-minyagala" & date == "2022-06-05", "katavi-mpanda-sibwesa-sibwesa-sibwesa", uniqueMrkt.check),
    uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mpanda-sibwesa-sibwesa-sibwesa" & date == "2022-06-03", "katavi-mpanda-kabungu-minyagala-minyagala", uniqueMrkt.check),
    date.check = ifelse(region.geomatch.final.A == "katavi", as.character(date), date.check),
    date.check = ifelse(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka" & date == "2022-06-01", as.character("2022-05-30"), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="katavi") %>% group_by(date.check, uniqueMrkt.check) %>% count()

```


## Morogoro: 

```{r morogoro_clean}
regions[5]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "morogoro") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "morogoro") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# 
#  1 morogoro-kilombero-idete-idandu-kikurukutu          2022-06-04        2022-06-02    21 --> CORRECT
#  2 morogoro-kilombero-idete-idandu-kikurukutu          2022-06-06        2022-06-02     1 --> Date Error: (date correct, D.o.I incorrect)
#  3 morogoro-kilombero-kiberege-sagamaganga-sagamaganga 2022-06-07        2022-06-06     1 --> Date Error (date incorrect, D.o.I correct)
#  4 morogoro-kilombero-kiberege-sagamaganga-sagamaganga 2022-06-07        2022-06-07    43 --> CORRECT 
#  5 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-01     2 --> Date Error (date incorrect, D.o.I correct)
#  6 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-02     2 --> Date Error (date incorrect, D.o.I correct)
#  7 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-06    18 --> CORRECT 
#  8 morogoro-kilosa-rudewa-gongoni-gongoni              2022-05-31        2022-05-30     1 --> Date Error (date incorrect, D.o.I correct)
#  9 morogoro-kilosa-rudewa-gongoni-gongoni              2022-05-31        2022-05-31    42 --> CORRECT 
# 10 morogoro-mvomero-kanga-mziha-mziha                  2022-05-30        2022-05-29     1 --> Date Error (date incorrect, D.o.I correct)
# 11 morogoro-mvomero-kanga-mziha-mziha                  2022-05-30        2022-05-30    56 --> CORRECT 
# 12 morogoro-ulanga-biro-tanga-tanga                    2022-05-25        2022-05-24     1 --> Date Error (date incorrect, D.o.I correct)
# 13 morogoro-ulanga-biro-tanga-tanga                    2022-05-25        2022-05-25    37 --> CORRECT 
# 14 morogoro-ulanga-iragua-namhanga-mbenja              2022-05-28        2022-05-26     1 --> Date Error (date incorrect, D.o.I correct)
# 15 morogoro-ulanga-iragua-namhanga-mbenja              2022-05-28        2022-05-28    35 --> CORRECT 
# 16 morogoro-ulanga-itete-itete-itete                   2022-06-08        2022-06-08     1 --> Date Error: "2022-06-10"
# 17 morogoro-ulanga-itete-itete-itete                   2022-06-10        2022-06-08     1 --> Date Error (date incorrect, D.o.I correct)
# 18 morogoro-ulanga-itete-itete-itete                   2022-06-10        2022-06-10   106 --> CORRECT 
# 19 morogoro-ulanga-itete-itete-itete                   2022-06-11        2022-06-10     1 --> Date Error (date correct, D.o.I incorrect)
# 20 morogoro-ulanga-lukande-lukande-lukande             2022-05-26        2022-05-26    32 --> CORRECT 
# 21 morogoro-ulanga-mbuga-iputi-iputi                   2022-05-24        2022-05-24    28 --> CORRECT 
# 22 morogoro-ulanga-minepa-mavimba-mavimba              2022-01-02        2022-05-22     1 --> Date Error (2022-05-23 )
# 23 morogoro-ulanga-minepa-mavimba-mavimba              2022-05-23        2022-05-23    48 --> CORRECT 
# 24 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-01        2022-06-01     1 --> Date Error (date correct, D.o.I incorrect)
# 25 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-02        2022-05-31     1 --> Date Error (2022-06-01 )
# 26 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-02        2022-06-01    53 --> CORRECT
# 27 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-08        2022-06-07     1 --> Date Error (2022-05-08 )
# 28 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-08        2022-06-08    92 --> CORRECT
# 29 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-09        2022-06-08     11  --> Date Error (date correct, D.o.I incorrect)


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
    mutate(
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "morogoro", uniqueMrkt, uniqueMrkt.check),
        date.check = ifelse(region.geomatch.final.A == "morogoro", as.character(date), date.check),
        date.check = ifelse(uniqueMrkt == "morogoro-kilombero-idete-idandu-kikurukutu", as.character(date), date.check), #2022-06-02
        date.check = ifelse(uniqueMrkt == "morogoro-kilombero-kiberege-sagamaganga-sagamaganga", as.character(date.of.interview), date.check), #2022-06-07 
        date.check = ifelse(uniqueMrkt == "morogoro-kilombero-mofu-miyomboni-mofu", as.character(date.of.interview), date.check), #2022-06-06 
        date.check = ifelse(uniqueMrkt == "morogoro-kilosa-rudewa-gongoni-gongoni", as.character(date.of.interview), date.check), #2022-05-31  
        date.check = ifelse(uniqueMrkt == "morogoro-mvomero-kanga-mziha-mziha", as.character(date.of.interview), date.check), #2022-05-30
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-biro-tanga-tanga", as.character(date.of.interview), date.check), #2022-05-25 
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-iragua-namhanga-mbenja", as.character(date.of.interview), date.check), #2022-05-28
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-itete-itete-itete", as.character("2022-06-10"), date.check), #"2022-06-10"
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-minepa-mavimba-mavimba", as.character("2022-05-23"), date.check), #"2022-05-23"
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-minepa-mbuyuni-mbuyuni", as.character("2022-06-01"), date.check), #"2022-06-01"
        date.check = ifelse(uniqueMrkt == "morogoro-ulanga-usangule-kiswago-salamiti", as.character("2022-06-08"), date.check) #2022-06-08
    ) 

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="morogoro") %>% group_by(date.check, uniqueMrkt.check) %>% count()

```
 

## Mtwara: 

```{r mtwara_clean}

  region_i <- "mtwara"
  ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_linkA_sf %>% filter(region.geomatch.final.A == region_i), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    # scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_Nam)+
   # coord_sf(ylim = c(-10.9,-10.6), xlim = c(38.6,39.3))+
    coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")


regions[6]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mtwara") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mtwara") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#   uniqueMrkt                                               date.of.interview date           n
#    <chr>                                                    <date>            <date>     <int>
#  1 mtwara-masasi-chikolopola-chikolopola-chikolopola        2022-06-11        2022-06-11     4
#  2 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-01     1
#  3 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-02    41
#  4 mtwara-masasi-chiwale-kivukoni-chiwale                   2022-06-07        2022-06-07    21
#  5 mtwara-masasi-lukuledi-lukuledi-lukuledi                 2022-06-07        2022-06-07    19
#  6 mtwara-masasi-mchauru-mchauru-mchauru                    2022-06-04        2022-06-04    20
#  7 mtwara-masasi-mkundi-majembe-mkundi                      2022-06-06        2022-06-06    20
#  8 mtwara-masasi-mnavira-mnavira-mnavira                    2022-06-11        2022-06-11     4
#  9 mtwara-masasi-mnavira-nakarara-makong.onda               2022-06-04        2022-06-04    20
# 10 mtwara-masasi-mwena-chibwini-mwena                       2022-06-08        2022-06-08     8
# 11 mtwara-masasi-mwena-chibwini-mwena                       2022-06-09        2022-06-09     4
# 12 mtwara-masasi-namalenga-nagaga-namalenga                 2022-06-06        2022-06-06    20
# 13 mtwara-masasi-nanganga-mwongozo-nangoo                   2022-06-08        2022-06-08     8
# 14 mtwara-masasi-nanjota-nanjota-nanjota                    2022-06-03        2022-06-03    28
# 15 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-28        2022-05-28    30
# 16 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-29        2022-05-28    21
# 17 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-30        2022-05-28     1
# 18 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-05-30     1
# 19 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-06-01    32
# 20 mtwara-masasi.township.authority-migongo-nangaya-nangaya 2022-05-26        2022-05-26    10
# 21 mtwara-masasi.township.authority-mkuti-madeco-madeco     2022-05-26        2022-05-26     9
# 22 mtwara-masasi.township.authority-nyasa-upanga-upanga     2022-05-25        2022-05-25     1
# 23 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-29        2022-05-29     1
# 24 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-30        2022-05-30    60
# 25 mtwara-newala-kitangari-kitangari-kitangari              2022-06-10        2022-06-10     4
# 26 mtwara-newala-luchindu-luchingu-luchingu                 2022-06-10        2022-06-10     3
# 27 mtwara-newala-luchindu-tupendane-tulindane               2022-06-10        2022-06-10     4
# 28 mtwara-newala-mtonya-majengo-mtonya                      2022-06-10        2022-06-10     4
# 29 mtwara-newala-mtonya-nangwala-nangwala                   2022-06-10        2022-06-10     4


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
    mutate(
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mtwara", uniqueMrkt, uniqueMrkt.check),
        date.check = ifelse(region.geomatch.final.A == "mtwara", as.character(date), date.check))
```


## Mbeya: 

```{r mbeya_clean}
regions[7]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mbeya") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mbeya") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#    uniqueMrkt                                                    date.of.interview date           n
#    <chr>                                                         <date>            <date>     <int>
#  1 mbeya-chunya-mamba-mamba-shinyanga                            2022-06-14        2022-06-14    72 --> Correct
#  2 mbeya-chunya-mtanila-igangwe-shauri.moyo                      2022-06-12        2022-06-12    67 --> Correct
#  3 mbeya-mbarali-igava-muungano-muungano                         2022-05-28        2022-05-28    44 --> Correct
#  4 mbeya-mbarali-imalilosongwe-imalilosongwe-imalilosongwe       2022-05-29        2022-05-29    70 --> Correct
#  5 mbeya-mbarali-madibira-chalisuka-madibira                     2022-05-26        2022-05-26    39 --> Correct
#  6 mbeya-mbarali-miyombweni-mapogoro-mapogoro                    2022-05-27        2022-05-27    26 --> Correct
#  7 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-05-27        2022-05-27     1 --> mapogoro.
#  8 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-05-29        2022-05-29     7 --> imalilosongwe.
#  9 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-06-04        2022-06-04    52 --> Correct
# 10 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-27        2022-05-27     2 --> mapogoro.
# 11 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-28        2022-05-28    11 --> muungano.
# 12 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-29        2022-05-29     1 --> imalilosongwe.
# 13 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-06-07        2022-06-07    59 --> Correct



mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
    mutate(
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya", uniqueMrkt, uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-26", "mbeya-mbarali-madibira-chalisuka-madibira", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-27", "mbeya-mbarali-miyombweni-mapogoro-mapogoro", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-04", "mbeya-mbarali-rujewa-ihanga-rujewa", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-07", "mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-28", "mbeya-mbarali-igava-muungano-muungano", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == " 2022-05-29", "mbeya-mbarali-imalilosongwe-imalilosongwe-imalilosongwe", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-12", "mbeya-chunya-mtanila-igangwe-shauri.moyo", uniqueMrkt.check),
        uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-14", "mbeya-chunya-mamba-mamba-shinyanga", uniqueMrkt.check),
        date.check = ifelse(region.geomatch.final.A == "mbeya", as.character(date), date.check)
    ) 

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="mbeya") %>% group_by(date.check, uniqueMrkt.check) %>% count()

```


## Rukwa: 

```{r rukwa_clean}
regions[8]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "rukwa") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "rukwa") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 5 × 4
#   uniqueMrkt                                        date.of.interview date           n
#   <chr>                                             <date>            <date>     <int>
# 1 rukwa-nkasi-kate-ntalamila-ntalamila              2022-05-26        2022-05-26     1 --> Incorrect Date
# 2 rukwa-nkasi-kate-ntalamila-ntalamila              2022-05-27        2022-05-27    41
# 3 rukwa-nkasi-nkomolo-isunta-isunta                 2022-06-02        2022-06-02    55
# 4 rukwa-sumbawanga-kipeta-kilyamatundu-kilyamatundu 2022-06-01        2022-06-01    49
# 5 rukwa-sumbawanga-muze-muze-muze                   2022-05-26        2022-05-26    42

mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "rukwa", uniqueMrkt, uniqueMrkt.check),
    date.check = ifelse(region.geomatch.final.A == "rukwa", as.character(date), date.check),
    date.check = ifelse(uniqueMrkt == "rukwa-nkasi-kate-ntalamila-ntalamila" & date == "2022-05-26", as.character("2022-05-27"), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="rukwa") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 
```

## Iringa: 

```{r iringa_clean}
regions[9]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "iringa") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "iringa") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 3 × 4
#   uniqueMrkt                                date.of.interview date           n
#   <chr>                                     <date>            <date>     <int>
# 1 iringa-iringa-itunundu-kimande-kimande    2022-06-03        2022-06-03    54
# 2 iringa-mufindi-ihowanza-ihowanza-ihowanza 2022-06-01        2022-05-31     1 --> incorrect date.
# 3 iringa-mufindi-ihowanza-ihowanza-ihowanza 2022-06-01        2022-06-01    42


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "iringa", uniqueMrkt, uniqueMrkt.check),
    # date of interview field is correct for all locations>>>
    date.check = ifelse(region.geomatch.final.A == "iringa", as.character(date.of.interview), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="iringa") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 

```

## Njombe: 

```{r njombe_clean}
regions[10]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "njombe") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "njombe") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 2 × 4
#   uniqueMrkt                                                 date.of.interview date           n
#   <chr>                                                      <date>            <date>     <int>
# 1 njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe 2022-06-01        2022-06-01     2 --> Correct to iringa ihowanza
# 2 njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe 2022-06-06        2022-06-06    62


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "njombe", uniqueMrkt, uniqueMrkt.check),
    uniqueMrkt.check = ifelse(uniqueMrkt.check == "njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe" & date == "2022-06-01", "iringa-mufindi-ihowanza-ihowanza-ihowanza", uniqueMrkt.check),
    # date of interview field is correct for all locations>>>
    date.check = ifelse(region.geomatch.final.A == "njombe", as.character(date.of.interview), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="njombe") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 

```


## Songwe: 

```{r songwe_clean}
regions[11]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "songwe") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "songwe") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 2 × 4
#   uniqueMrkt                         date.of.interview date           n
#   <chr>                              <date>            <date>     <int>
# 1 songwe-mbozi-iyula-idiwili-idiwili 2022-06-09        2022-06-09    38
# 2 songwe-momba-ivuna-ntungwa-mbao    2022-06-02        2022-06-02    49


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "songwe", uniqueMrkt, uniqueMrkt.check),
    # date of interview field is correct for all locations>>>
    date.check = ifelse(region.geomatch.final.A == "songwe", as.character(date), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="songwe") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 

```




## Lindi: 

```{r lindi_clean}
regions[12]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "lindi") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "lindi") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 1 × 4
#   uniqueMrkt                               date.of.interview date           n
#   <chr>                                    <date>            <date>     <int>
# 1 lindi-nachingwea-ndomoni-ndomoni-ndomoni 2022-06-09        2022-06-09     8


mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "lindi", uniqueMrkt, uniqueMrkt.check),
    # date of interview field is correct for all locations>>>
    date.check = ifelse(region.geomatch.final.A == "lindi", as.character(date.of.interview), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="lindi") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 

```

## Ruvuma: 

```{r ruvuma_clean}
regions[13]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "ruvuma") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "ruvuma") %>% select(-region.geomatch.final.A)
# 
# # A tibble: 1 × 4
#   uniqueMrkt                            date.of.interview date           n
#   <chr>                                 <date>            <date>     <int>
# 1 ruvuma-tunduru-muhuwesi-muhesi-muhesi 2022-06-12        2022-06-12     4

mrktc_linkA_check2 <- mrktc_linkA_check2 %>%
  mutate(
    uniqueMrkt.check = ifelse(region.geomatch.final.A == "ruvuma", uniqueMrkt, uniqueMrkt.check),
    # date of interview field is correct for all locations>>>
    date.check = ifelse(region.geomatch.final.A == "ruvuma", as.character(date.of.interview), date.check))

mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="ruvuma") %>% group_by(date.check, uniqueMrkt.check) %>% count()
mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() 
```

# Clean GPS data:

```{r mrktc_linkA_cleangps}

mrktc_gps_check <- mrktc_linkA_check2 %>% 
  # copy mrktCheck for splitting
  mutate(uniqueMrktSep = uniqueMrkt.check) %>% 
  # split uniqueMrkt variable into component locations: 
  separate(uniqueMrktSep, c("region.check", "district.check", "ward.check", "village.check", "market.check"), sep = "-") %>%
  # check code: 
  select(fid, date, date.check, country, uniqueMrkt.check, contains(".check"), gps.coordinates.of.the.market, unique.row.identifier.uuid.)

```

## NEXT STEPS:
Review number of markets, number of surveys per market etc.


```{r mrktc_linkACheck}

mrktc_mapdata_check <- mrktc_gps_check %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

mrktc_sf_check <- st_as_sf(mrktc_mapdata_check, coords = c("long","lat"),  crs = 4326) 

## MAP
map_checks <- list()
regions <- mrktc_gps_check %>% distinct(region.check) %>% pull()

for(i in 1:length(regions)){
  
  region_i <- regions[i]
  
  map_checks[[i]] <- ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_sf_check %>% filter(region.check %in% region_i), 
            aes(col = ward.check),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_Nam)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

# gridExtra::grid.arrange(grobs = map_plots, ncol = 3)

map_checks[[1]]; map_checks[[2]]; map_checks[[3]];map_checks[[4]]; map_checks[[5]]; # map_checks[[6]]; == mtwara (not cleaned!)
map_checks[[7]]; map_checks[[8]]; map_checks[[9]];map_checks[[10]]; map_checks[[11]]; map_checks[[12]];
map_checks[[13]];


```
