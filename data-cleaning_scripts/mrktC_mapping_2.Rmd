---
title: "marketC_mapping"
output: html_document
date: "2024-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}

library(sf)
library(here)
library(tidyverse)
library(RColorBrewer)
library(lwgeom)
library(ggpubr)

```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C", "#FFD700", "#1E90FF")
```


# Mapping Market Survey C Locations

- Load in market survey C data (following initial string cleaning)
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load in clean geomatched market survey A data.
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load Tanzania shapefile with ward boundaries
    - `r `"data/shapefiles/tza_admbnda_adm3_20181019.shp"`
    - Source <https://data.humdata.org/dataset/cod-ab-tza?> (ADM L3)

```{r data, include = T, warning = F, echo = F}

# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tza_admbnda_adm1_20181019.shp")) %>% # with region boundaries
   rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
  )

# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tza_admbnda_adm3_20181019.shp")) %>% # with ward boundaries
    rename(
    "Country_N"=ADM0_EN,    
    "Country_NSw" = ADM0_SW,
    "Country_C"=ADM0_PCODE,
    "Region_Nam" = ADM1_EN,
    "Region_Cod" = ADM1_PCODE,
    "District_N" = ADM2_EN,
    "District_C" = ADM2_PCODE,
    "Ward_Name"=ADM3_EN,
    "Ward_Code"= ADM3_PCODE
  )

# Market A location data:
mrkta_gps <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_final.csv"))
mrkta_gps_join <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_manual+geomatch.csv")) %>%
  rename(ward.code.manual = ward.code,
         ward.name.manual = ward.name,
         village.manual = village, 
         market.name.manual = market.name.corrected
         )

# Market C location data:
# mrktc_clean3 <- read_csv(file = here("data/data-cleaning_data/mrktc_info_clean3-1.csv"))
mrktc_gps <- read_csv(file = here("data/tanzania_data/mrktc_gps_tanzania_CLEAN1.csv")) %>%
  rename(ward.code.manual = ward.code.3A,
         ward.name.manual = ward.name.3A,
         village.manual = village.3A, 
         market.name.manual = market.name.3A
         ) %>%
  filter(!is.na(gps.coordinates.of.the.market))

mrktc_gps_raw <- read_csv(file = here(
  "data/data-cleaning_data/mrktc_generalinfo_tanzania_CLEAN.csv"
)) %>%
  select(
    fid,
    date,
    date.end,
    date.of.interview,
    country,
    region.code.raw = district.region.code,
    region.name.raw = district.region.name,
    ward.code.raw = ward.code,
    ward.name.raw = ward.name,
    village.raw = village,
    market.name.raw = market.name,
    ward.code.manual = ward.code.3A,
    ward.name.manual = ward.name.3A,
    village.manual = village.3A,
    market.name.manual = market.name.3A,
    gps.coordinates.of.the.market,
    unique.row.identifier.uuid.
  ) %>%
  filter(!is.na(gps.coordinates.of.the.market))

```


## Market A Map
- Market A data, matched to Tanzania shapefile region-district-ward locations
- See `mrktA_mapping.Rmd`

```{r mrktaMap}
# convert mrkta location data to mapping format & map manually cleaned data:

mrkta_mapdata <- mrkta_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)

mrkta_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_map

# Map of market survey locations coloured by region (consistency with Tanzania shapefile)

Regions_Amanual <- mrkta_sf %>% pull(region.geomatch.final) %>% unique() %>% str_to_title()

mrkta_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_Nam %in% Regions_Amanual), aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations (coloured by stringRegion)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_mapByReg

# mrkta-manual string-location data is consistent with tanzania shapefile for REGION of origin. 

# mrkta-manual Descriptive stats:
# mrkta_gps %>% group_by(district.region.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(district.region.name, ward.name) %>% count() %>% filter(n>1) # mamba only appears in ward.name unique list
# mrkta_gps %>% filter(ward.name == "mamba")
# mrkta_gps %>% group_by(district.region.name, ward.name, village) %>% count() 
# mrkta_gps %>% group_by(district.region.name, ward.name, village, market.name.corrected) %>% count() 

```

## Market C Map (1)
- Location of market C surveys, overlaid on market A survey locations

```{r, mrktcMap_manual-cleaning}

mrktc_mapdata <- mrktc_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrktc_sf <- st_as_sf(mrktc_mapdata, coords = c("long","lat"),  crs = 4326) 

mrktC_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrktc_sf, aes(col = district.region.name), size = 1)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+ 
  labs(title = "Market survey C: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrktC_map

mrktCA_map <- ggplot() +
   geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   geom_sf(data = mrkta_sf, aes(col = region.geomatch.final), alpha = 0.5, size = 3)+
   geom_sf(data = mrktc_sf, aes(col = district.region.name),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
   scale_colour_manual(values = market_pal)+
   coord_sf()+
   labs(title = "Market Survey A-geoamtched (circles) and C-manual (triangles) data",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktCA_map

```


```{r datacheck}
# Check consistency between markets in mrkta_gps and mrktc_gps_raw (.manual)
mrkta_gps %>% distinct(region.geomatch.final, ward.geomatch.final, market.manual.final)
mrktc_gps_raw %>% distinct(region.name.raw, ward.name.manual, market.name.manual)

```
1) Market survey C - match to market survey A 
- Use market survey C gps locations to link to market survey A geo-matched data.
 - Each market survey C entry should be linked to a market identified in market survey A data.
 - Compare consistency between raw/manual survey C locations and A-linked survey locations.
 - Compare consistency between raw/manual survey C locations, overlaid on survey A locations
 - Compare consistently between A-linked survey C locations overlaid on survey A location (should be perfect match)


```{r mrktc_linkA}

# Join geomatched location data (from tanzania shapefile) to mrtka location data
mrktc_linkA_gps <- mrktc_gps %>%
  mutate(mrktaID = st_nearest_feature(mrktc_sf, mrkta_sf)) %>% 
  # join matched location data. by rowid (twardID)
  left_join(
    mrkta_mapdata %>%
      mutate(mrktaID = 1:nrow(.)) %>%
      select(
        mrktaID,
        "region.geomatch.final.A" = "region.geomatch.final",
        "district.geomatch.final.A" = "district.geomatch.final",
        "ward.geomatch.final.A" = "ward.geomatch.final",
        "village.manual.final.A" = "village.manual.final" ,
        "market.manual.final.A" = "market.manual.final"
        # "reg.ward.mrkt.final.A" = "reg.ward.mrkt.final"
      ),
    by = c("mrktaID")) %>%
  select(-mrktaID) 

colnames(mrktc_linkA_gps)

mrktc_linkA_mapdata <- mrktc_linkA_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

mrktc_linkA_sf <- st_as_sf(mrktc_linkA_mapdata, coords = c("long","lat"),  crs = 4326) 

## MAP
map_plots <- list()
regions <- mrktc_linkA_gps %>% distinct(region.geomatch.final.A) %>% pull()

for(i in 1:length(regions)){
  
  region_i <- regions[i]
  
  map_plots[[i]] <- ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_linkA_sf %>% filter(region.geomatch.final.A %in% region_i), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_Nam)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

# gridExtra::grid.arrange(grobs = map_plots, ncol = 3)

# map_plots[[1]]; map_plots[[2]]; map_plots[[3]];map_plots[[4]]; map_plots[[5]]; map_plots[[6]];
# map_plots[[7]]; map_plots[[8]]; map_plots[[9]];map_plots[[10]]; map_plots[[11]]; map_plots[[12]];
# map_plots[[13]]; 
  

```
 


###### Check linkA market C locations 


```{r check_linkA}

mrktc_linkA_check <- mrktc_linkA_gps %>%
  left_join(mrktc_gps_raw %>% select(fid, ends_with(".raw")), by = "fid") %>%
  # create a unique field for checking data:
  mutate(
    uniqueMrkt = paste(
    region.geomatch.final.A,
    district.geomatch.final.A,
    # district data not included in survey
    ward.geomatch.final.A,
    village.manual.final.A,
    market.manual.final.A,
    sep = "-"
    )
  ) 


# How many unique markets are found in the linkA location data?

nrow(mrktc_linkA_check)

mrktc_linkA_check %>%
  distinct(region.geomatch.final.A, 
           district.geomatch.final.A,
           ward.geomatch.final.A, 
           village.manual.final.A,
           market.manual.final.A,
           uniqueMrkt)

# 83 unique market location names. 

uniqueMrkt_date_summary <- mrktc_linkA_check %>%
  # review number of survey dates associated with each market:
  group_by(region.geomatch.final.A,
           uniqueMrkt,
           date.of.interview,
           date) %>%
  count() %>% 
  ungroup() %>%
  arrange(uniqueMrkt)
```


2) On a region-by-region basis:
- Use c-geomatchA locations and group by survey date. 
- All surveys for a given market should be completed on the same day
- For surveys which seem to be inconsistent check the original mrktc location names etc. 

## DODOMA: 

```{r dodoma_clean}
regions[1]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "dodoma") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "dodoma") %>% select(-region.geomatch.final.A)

#   uniqueMrkt                                     date.of.interview date           n
#    <chr>                                          <date>            <date>     <int>
#  1 dodoma-bahi-babayu-kongogo-kongogo             2022-05-11        2022-05-11    42  --> CORRECT
#  2 dodoma-bahi-bahi-bahi.sokoni-bahi              2022-06-02        2022-06-02    44  --> CORRECT
#  3 dodoma-bahi-ibihwa-mnkola-mnkola               2022-05-12        2022-05-12    29  --> CORRECT
#  4 dodoma-bahi-ibugule-nkhome-nkhome              2022-05-16        2022-05-14    48  --> CORRECT
#  5 dodoma-bahi-kigwe-kigwe-kigwe                  2022-05-13        2022-05-13    56  --> CORRECT
#  6 dodoma-bahi-lamaiti-lamaiti-lamaiti            2022-06-07        2022-06-07    45  --> CORRECT
#  7 dodoma-bahi-makanda-makanda-makanda            2022-05-18        2022-05-18    42  --> CORRECT
#  8 dodoma-bahi-msisi-msisi-msisi                  2022-05-23        2022-05-23    29  --> CORRECT
#  9 dodoma-bahi-mundemu-mundemu-mundemu            2022-06-04        2022-06-04    22  --> CORRECT
# 10 dodoma-bahi-nondwa-nondwa-nondwa               2022-05-21        2022-05-21    27  --> CORRECT
# 11 dodoma-bahi-zanka-mayamaya-mayamaya            2022-05-30        2022-05-25     1  --> Checked: Date Error (DoI is correct)
# 12 dodoma-bahi-zanka-mayamaya-mayamaya            2022-05-30        2022-05-30    39  --> CORRECT
# 13 dodoma-dodoma.urban-mpunguzi-mpunguzi-mpunguzi 2022-05-25        2022-05-25    35  --> CORRECT

mrktc_linkA_check %>% 
  filter(uniqueMrkt == "dodoma-bahi-zanka-mayamaya-mayamaya") %>%
  View()

# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "dodoma") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()


# Update: 
# -- Can't get this to work?!?!
# -- NB DoI is correct
# mrktc_linkA_check2 <- mrktc_linkA_check %>%
#   mutate(dateCheck = ifelse(uniqueMrkt == "dodoma-bahi-zanka-mayamaya-mayamaya" & date == "2022-05-25"),"2022-05-30", date)
```
 
 
## simiyu: 

```{r simiyu_clean}
regions[2]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "simiyu") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "simiyu") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error"
#
#   uniqueMrkt                                         date.of.interview date           n
#   <chr>                                              <date>            <date>     <int>
# 1 simiyu-bariadi-bariadi-kidinda-kidinda             2022-05-17        2022-05-17    77 --> CORRECT
# 2 simiyu-bariadi-dutwa-igaganulwa-igaganulwa         2022-05-19        2022-05-19    84 --> CORRECT
# 3 simiyu-bariadi-dutwa-igaganulwa-igaganulwa         2022-05-28        2022-05-14     2 ** --> Checked: Location Error (mwasamba-mwasamba)
# 4 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-14        2022-05-14     2 ** --> Checked: Date Error (2022-05-28)
# 5 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-28        2022-05-14    18 ** --> Checked: Date Error (2022-05-28)
# 6 simiyu-busega-lutubiga-mwasamba-mwasamba           2022-05-28        2022-05-28    79 --> CORRECT
# 7 simiyu-itilima-mwamapalala-mwamapalala-mwamapalala 2022-05-18        2022-05-18    34 --> CORRECT
# 8 simiyu-maswa-lalago-lalago-lalago                  2022-05-16        2022-05-16    45 --> CORRECT

mrktc_linkA_check %>% 
  filter(uniqueMrkt == "simiyu-bariadi-dutwa-igaganulwa-igaganulwa") %>%
  arrange(date) %>%
  View()
# simiyu-bariadi-dutwa-igaganulwa-igaganulwa         2022-05-28        2022-05-14
# Correct to : simiyu-busega-lutubiga-mwasamba-mwasamba

mrktc_linkA_check %>% 
  filter(uniqueMrkt == "simiyu-busega-lutubiga-mwasamba-mwasamba") %>%
  arrange(date) %>%
  View()
# Date is incorrect, should be "2022-05-28" for all entries based on DoI and date.end.

# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "simiyu") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()


# Update: 
# 
```
 
## Mwanza: 

```{r mwanza_clean}
regions[3]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mwanza") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mwanza") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 3 × 4
#   uniqueMrkt                           date.of.interview date           n
#   <chr>                                <date>            <date>     <int>
# 1 mwanza-kwimba-ngudu-kakola-kakola    2022-05-21        2022-05-21    69 --> CORRECT
# 2 mwanza-magu-nkungulu-ndagalu-kabila  2022-05-23        2022-05-23    79 --> CORRECT
# 3 mwanza-misungwi-masasi-manawa-misasi 2022-05-25        2022-05-25    75 --> CORRECT


# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "mwanza") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()

# Update: All correct no cleaning required.
```
 

## Katavi: 

```{r katavi_clean}
regions[4]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "katavi") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "katavi") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#    uniqueMrkt                                date.of.interview date           n
#    <chr>                                     <date>            <date>     <int>
#  1 katavi-mlele-inyonga-kinyonga-inyonga     2022-05-25        2022-05-25    53 --> CORRECT
#  2 katavi-mlele-itenka-itenka.a-itenka       2022-05-30        2022-05-30    40 --> CORRECT
#  3 katavi-mlele-itenka-itenka.a-itenka       2022-06-01        2022-06-01     1 --> Checked: Location Error (rukwa-kilyamatundu)
#  4 katavi-mlele-itenka-itenka.a-itenka       2022-06-03        2022-06-03    10 --> Checked: Location Error (minyagala)
#  5 katavi-mlele-kibaoni-kibaoni-kibaoni      2022-05-31        2022-05-31    30 --> CORRECT
#  6 katavi-mlele-majimoto-kitupa-majimoto.a   2022-05-22        2022-05-22    40 --> CORRECT
#  7 katavi-mlele-mamba-kilda.kona-kilda.kona  2022-05-31        2022-05-31    20 --> CORRECT
#  8 katavi-mlele-usevya-usevya-usevya         2022-05-23        2022-05-23    32 --> CORRECT
#  9 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-03        2022-06-03    37 --> CORRECT
# 10 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-05        2022-06-05     9 --> Checked: Unclear conclusion
# 11 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-03        2022-06-03     2 --> Checked: Unclear conclusion
# 12 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-05        2022-06-05    43 --> CORRECT

# Check "katavi-mlele-itenka-itenka.a-itenka"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka") %>%
  arrange(date) %>%
  View()
# If date == 2022-06-01, correction to rukwa-kilyamatundu
# If date == 2022-06-03, correction to katavi-mpanda-kabungu-minyagala-minyagala

# check "katavi-mpanda-kabungu-minyagala-minyagala"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-kabungu-minyagala-minyagala") %>%
  arrange(date) %>%
  View()
# If date == 2022-06-05 looks like correction may be: katavi-mpanda-sibwesa-sibwesa-sibwesa

# check "katavi-mpanda-sibwesa-sibwesa-sibwesa"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-sibwesa-sibwesa-sibwesa") %>%
  arrange(date) %>%
  View()
# If date == 2022-06-03 looks like correction may be "katavi-mpanda-kabungu-minyagala-minyagala"


# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "katavi") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()

# Update: All correct no cleaning required.
```


## Morogoro: 

```{r morogoro_clean}
regions[5]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "morogoro") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "morogoro") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# 
#  1 morogoro-kilombero-idete-idandu-kikurukutu          2022-06-04        2022-06-02    21
#  2 morogoro-kilombero-idete-idandu-kikurukutu          2022-06-06        2022-06-02     1
#  3 morogoro-kilombero-kiberege-sagamaganga-sagamaganga 2022-06-07        2022-06-06     1
#  4 morogoro-kilombero-kiberege-sagamaganga-sagamaganga 2022-06-07        2022-06-07    43
#  5 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-01     2
#  6 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-02     2
#  7 morogoro-kilombero-mofu-miyomboni-mofu              2022-06-06        2022-06-06    18
#  8 morogoro-kilosa-rudewa-gongoni-gongoni              2022-05-31        2022-05-30     1
#  9 morogoro-kilosa-rudewa-gongoni-gongoni              2022-05-31        2022-05-31    42
# 10 morogoro-mvomero-kanga-mziha-mziha                  2022-05-30        2022-05-29     1
# 11 morogoro-mvomero-kanga-mziha-mziha                  2022-05-30        2022-05-30    56
# 12 morogoro-ulanga-biro-tanga-tanga                    2022-05-25        2022-05-24     1
# 13 morogoro-ulanga-biro-tanga-tanga                    2022-05-25        2022-05-25    37
# 14 morogoro-ulanga-iragua-namhanga-mbenja              2022-05-28        2022-05-26     1
# 15 morogoro-ulanga-iragua-namhanga-mbenja              2022-05-28        2022-05-28    35
# 16 morogoro-ulanga-itete-itete-itete                   2022-06-08        2022-06-08     1
# 17 morogoro-ulanga-itete-itete-itete                   2022-06-10        2022-06-08     1
# 18 morogoro-ulanga-itete-itete-itete                   2022-06-10        2022-06-10   106
# 19 morogoro-ulanga-itete-itete-itete                   2022-06-11        2022-06-10     1
# 20 morogoro-ulanga-lukande-lukande-lukande             2022-05-26        2022-05-26    32
# 21 morogoro-ulanga-mbuga-iputi-iputi                   2022-05-24        2022-05-24    28
# 22 morogoro-ulanga-minepa-mavimba-mavimba              2022-01-02        2022-05-22     1
# 23 morogoro-ulanga-minepa-mavimba-mavimba              2022-05-23        2022-05-23    48
# 24 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-01        2022-06-01     1
# 25 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-02        2022-05-31     1
# 26 morogoro-ulanga-minepa-mbuyuni-mbuyuni              2022-06-02        2022-06-01    53
# 27 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-08        2022-06-07     1
# 28 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-08        2022-06-08    92
# 29 morogoro-ulanga-usangule-kiswago-salamiti           2022-06-09        2022-06-08     11

```
 

## Mtwara: 

```{r mtwara_clean}
regions[6]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mtwara") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mtwara") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#   uniqueMrkt                                               date.of.interview date           n
#    <chr>                                                    <date>            <date>     <int>
#  1 mtwara-masasi-chikolopola-chikolopola-chikolopola        2022-06-11        2022-06-11     4
#  2 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-01     1
#  3 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-02    41
#  4 mtwara-masasi-chiwale-kivukoni-chiwale                   2022-06-07        2022-06-07    21
#  5 mtwara-masasi-lukuledi-lukuledi-lukuledi                 2022-06-07        2022-06-07    19
#  6 mtwara-masasi-mchauru-mchauru-mchauru                    2022-06-04        2022-06-04    20
#  7 mtwara-masasi-mkundi-majembe-mkundi                      2022-06-06        2022-06-06    20
#  8 mtwara-masasi-mnavira-mnavira-mnavira                    2022-06-11        2022-06-11     4
#  9 mtwara-masasi-mnavira-nakarara-makong.onda               2022-06-04        2022-06-04    20
# 10 mtwara-masasi-mwena-chibwini-mwena                       2022-06-08        2022-06-08     8
# 11 mtwara-masasi-mwena-chibwini-mwena                       2022-06-09        2022-06-09     4
# 12 mtwara-masasi-namalenga-nagaga-namalenga                 2022-06-06        2022-06-06    20
# 13 mtwara-masasi-nanganga-mwongozo-nangoo                   2022-06-08        2022-06-08     8
# 14 mtwara-masasi-nanjota-nanjota-nanjota                    2022-06-03        2022-06-03    28
# 15 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-28        2022-05-28    30
# 16 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-29        2022-05-28    21
# 17 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-30        2022-05-28     1
# 18 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-05-30     1
# 19 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-06-01    32
# 20 mtwara-masasi.township.authority-migongo-nangaya-nangaya 2022-05-26        2022-05-26    10
# 21 mtwara-masasi.township.authority-mkuti-madeco-madeco     2022-05-26        2022-05-26     9
# 22 mtwara-masasi.township.authority-nyasa-upanga-upanga     2022-05-25        2022-05-25     1
# 23 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-29        2022-05-29     1
# 24 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-30        2022-05-30    60
# 25 mtwara-newala-kitangari-kitangari-kitangari              2022-06-10        2022-06-10     4
# 26 mtwara-newala-luchindu-luchingu-luchingu                 2022-06-10        2022-06-10     3
# 27 mtwara-newala-luchindu-tupendane-tulindane               2022-06-10        2022-06-10     4
# 28 mtwara-newala-mtonya-majengo-mtonya                      2022-06-10        2022-06-10     4
# 29 mtwara-newala-mtonya-nangwala-nangwala                   2022-06-10        2022-06-10     4

```


## Mbeya: 

```{r mbeya_clean}
regions[7]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "mbeya") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mbeya") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#    uniqueMrkt                                                    date.of.interview date           n
#    <chr>                                                         <date>            <date>     <int>
#  1 mbeya-chunya-mamba-mamba-shinyanga                            2022-06-14        2022-06-14    72
#  2 mbeya-chunya-mtanila-igangwe-shauri.moyo                      2022-06-12        2022-06-12    67
#  3 mbeya-mbarali-igava-muungano-muungano                         2022-05-28        2022-05-28    44
#  4 mbeya-mbarali-imalilosongwe-imalilosongwe-imalilosongwe       2022-05-29        2022-05-29    70
#  5 mbeya-mbarali-madibira-chalisuka-madibira                     2022-05-26        2022-05-26    39
#  6 mbeya-mbarali-miyombweni-mapogoro-mapogoro                    2022-05-27        2022-05-27    26
#  7 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-05-27        2022-05-27     1
#  8 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-05-29        2022-05-29     7
#  9 mbeya-mbarali-rujewa-ihanga-rujewa                            2022-06-04        2022-06-04    52
# 10 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-27        2022-05-27     2
# 11 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-28        2022-05-28    11
# 12 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-05-29        2022-05-29     1
# 13 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu 2022-06-07        2022-06-07    59

```


## Rukwa: 

```{r rukwa_clean}
regions[8]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "rukwa") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "rukwa") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 5 × 4
#   uniqueMrkt                                        date.of.interview date           n
#   <chr>                                             <date>            <date>     <int>
# 1 rukwa-nkasi-kate-ntalamila-ntalamila              2022-05-26        2022-05-26     1 --> Incorrect Date
# 2 rukwa-nkasi-kate-ntalamila-ntalamila              2022-05-27        2022-05-27    41
# 3 rukwa-nkasi-nkomolo-isunta-isunta                 2022-06-02        2022-06-02    55
# 4 rukwa-sumbawanga-kipeta-kilyamatundu-kilyamatundu 2022-06-01        2022-06-01    49
# 5 rukwa-sumbawanga-muze-muze-muze                   2022-05-26        2022-05-26    42

```

## Iringa: 

```{r iringa_clean}
regions[9]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "iringa") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "iringa") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 3 × 4
#   uniqueMrkt                                date.of.interview date           n
#   <chr>                                     <date>            <date>     <int>
# 1 iringa-iringa-itunundu-kimande-kimande    2022-06-03        2022-06-03    54
# 2 iringa-mufindi-ihowanza-ihowanza-ihowanza 2022-06-01        2022-05-31     1 --> incorrect date.
# 3 iringa-mufindi-ihowanza-ihowanza-ihowanza 2022-06-01        2022-06-01    42

```

## Njombe: 

```{r njombe_clean}
regions[10]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "njombe") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "njombe") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# A tibble: 2 × 4
#   uniqueMrkt                                                 date.of.interview date           n
#   <chr>                                                      <date>            <date>     <int>
# 1 njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe 2022-06-01        2022-06-01     2 --> Correct to iringa ihowanza
# 2 njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe 2022-06-06        2022-06-06    62

```


## Songwe: 

```{r songwe_clean}
regions[11]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "songwe") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "songwe") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 2 × 4
#   uniqueMrkt                         date.of.interview date           n
#   <chr>                              <date>            <date>     <int>
# 1 songwe-mbozi-iyula-idiwili-idiwili 2022-06-09        2022-06-09    38
# 2 songwe-momba-ivuna-ntungwa-mbao    2022-06-02        2022-06-02    49

```




## Lindi: 

```{r lindi_clean}
regions[12]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "lindi") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "lindi") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
# # A tibble: 1 × 4
#   uniqueMrkt                               date.of.interview date           n
#   <chr>                                    <date>            <date>     <int>
# 1 lindi-nachingwea-ndomoni-ndomoni-ndomoni 2022-06-09        2022-06-09     8

```


## Ruvuma: 

```{r ruvuma_clean}
regions[13]

mrktc_linkA_check %>% filter(region.geomatch.final.A == "ruvuma") %>% View()
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "ruvuma") %>% select(-region.geomatch.final.A)
# 
# # A tibble: 1 × 4
#   uniqueMrkt                            date.of.interview date           n
#   <chr>                                 <date>            <date>     <int>
# 1 ruvuma-tunduru-muhuwesi-muhesi-muhesi 2022-06-12        2022-06-12     4

```














# Review Location Data

```{r checkData}
mrktc_gps %>% colnames()

# unique region-ward combinations in market C survey data
mrktc_manualNames <- mrktc_gps %>% select(district.region.name, ward.name.manual) %>% distinct() %>% arrange(district.region.name, ward.name.manual)

# Are these the same as the survey A manual region-ward combinations ? (they should be)
mrkta_manualNames <- mrkta_gps_join %>% select(district.region.name, ward.name.manual) %>% distinct() %>% arrange(district.region.name, ward.name.manual)

print(paste("market C survey has ", nrow(mrktc_manualNames), "unique region-ward locations.",
            "market A survey has ", nrow(mrkta_manualNames), "unique region-ward locations."))

anti_join(mrkta_manualNames, mrktc_manualNames)
anti_join(mrktc_manualNames, mrkta_manualNames)


# unique region-ward combinations in market C survey data
mrktc_manualNames <- mrktc_gps %>% select(district.region.name, ward.name.manual, market.name.manual) %>% distinct() %>% arrange(district.region.name, ward.name.manual, market.name.manual)

# Are these the same as the survey A manual region-ward combinations ? (they should be)
mrkta_manualNames <- mrkta_gps_join %>% select(district.region.name, ward.name.manual,market.name.manual) %>% distinct() %>% arrange(district.region.name, ward.name.manual,market.name.manual)

print(paste("market C survey has ", nrow(mrktc_manualNames), "unique region-ward locations.",
            "market A survey has ", nrow(mrkta_manualNames), "unique region-ward locations."))

anti_join(mrkta_manualNames, mrktc_manualNames)
anti_join(mrktc_manualNames, mrkta_manualNames)


# Join geomatched locatiion data to mrkt survey C by the manually matched location data (equal between A and C)
mrktc_gps_geomatch <- mrktc_gps %>% 
  left_join(mrkta_gps_join %>% 
              select(district.region.name, ward.name.manual, market.name.manual, reg.ward.mrkt.final, ends_with("geomatch")),
            by = c("district.region.name", "ward.name.manual","market.name.manual"))

# what to do about unmatched rows: anti_join(mrktc_manualNames, mrkta_manualNames) ??


# In geomatched data, are unique markets associated with 1 survey date?
mrktc_gps_geomatch %>% distinct(region.name.geomatch, ward.name.geomatch, market.name.manual)
mrktc_gps_geomatch %>% distinct(reg.ward.mrkt.final)

mrktc_gps_geomatch %>% group_by(reg.ward.mrkt.final, date) %>% count() %>% View()

# for markets associated with more than 1 date, check full mrktc_info data? Use count data to identify typos (where only 1 survey completed on that date, so probable data entry error)

```




####################################



# Market Maps (1) : Manually Cleaned

## Market A Map - Manually Cleaned.
- Market A string-location data manually cleaned (see : `r source(here("data-cleaning_scripts/mrkta_cleaning-script.Rmd"))` )
- Market A map survey locations data consistent with regional tanzania map for all surveys *except* survey in Ruvuma (yellow), labelled as Rukwa. 
```{r mrktaMap}
# convert mrkta location data to mapping format & map manually cleaned data:

mrkta_mapdata <- mrkta_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)

mrkta_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = district.region.name), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_map

# Map of market survey locations coloured by region (consistency with Tanzania shapefile)

Regions_Amanual <- mrkta_sf %>% pull(district.region.name) %>% unique() %>% str_to_title()

mrkta_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_Nam %in% Regions_Amanual), aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = district.region.name), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations (coloured by stringRegion)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_mapByReg

# mrkta-manual string-location data is consistent with tanzania shapefile for REGION of origin. 

# mrkta-manual Descriptive stats:
# mrkta_gps %>% group_by(district.region.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(district.region.name, ward.name) %>% count() %>% filter(n>1) # mamba only appears in ward.name unique list
# mrkta_gps %>% filter(ward.name == "mamba")
# mrkta_gps %>% group_by(district.region.name, ward.name, village) %>% count() 
# mrkta_gps %>% group_by(district.region.name, ward.name, village, market.name.corrected) %>% count() 

```

## Market C Map - manually cleaned. 
- Manual cleaning, market C cross-referenced with market A (not geo-matched)

```{r, mrktcMap_manual-cleaning}

mrktc_mapdata <- mrktc_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  arrange(gps.coordinates.of.the.market) %>% 
  filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrktc_sf <- st_as_sf(mrktc_mapdata, coords = c("long","lat"),  crs = 4326) 

mrktC_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrktc_sf, aes(col = district.region.name), size = 1)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+ 
  labs(title = "Market survey C: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrktC_map

mrktC3andA_map <- ggplot() +
   geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   geom_sf(data = mrkta_sf, aes(col = district.region.name), alpha = 0.5, size = 3)+
   geom_sf(data = mrktc_sf, aes(col = district.region.name),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
   scale_colour_manual(values = market_pal)+
   coord_sf()+
   labs(title = "Market Survey A (circles) and C (triangles) - manually cleaned location data",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktC3andA_map

```

# Market C Map 2 - market C geo-matched to market A
- For each Market Survey C location, match to the closest Market Survey A location

```{r mrktcMap_C-A-matched}

mrktCtoAmatch <- mrktc_mapdata %>%
  mutate(mrktaID = st_nearest_feature(mrktc_sf, mrkta_sf)) %>% 
  left_join(
    mrkta_mapdata %>%
      mutate(mrktaID = 1:nrow(.)) %>%
      select(
        mrktaID,
        "district.region.code.A" = "district.region.code",
        "district.region.name.A" = "district.region.name",
        "ward.code.A" = "ward.code",
        "ward.name.A" = "ward.name" ,
        "village.A" = "village",
        "market.name.A" = "market.name.corrected"
      ),
    by = c("mrktaID"))


mrktCtoAmatch_gps <- mrktCtoAmatch %>%
  select(
      country,
      ends_with(".A"),
      lat,
      long,
      gps.coordinates.of.the.market
    )
  
mrktCtoAmatch_sf <- st_as_sf(mrktCtoAmatch_gps, coords = c("long","lat"),  crs = 4326)

mrktCAmatched_map <- ggplot() +
   geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   geom_sf(data = mrkta_sf, aes(col = district.region.name), alpha = 0.5, size = 3)+
   geom_sf(data = mrktCtoAmatch_sf, aes(col = district.region.name.A),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+
   scale_colour_manual(values = market_pal)+
   coord_sf()+
   labs(title = "Market Survey A (circles) and C (triangles) - market locations",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktCAmatched_map


###################
# PLOTS BY REGION #
###################
# mrkta_sf <- mrkta_sf %>% mutate(mrktID = paste(ward.name,village,market.name.corrected, sep = "-"))
# mrktCtoAmatch_sf <- mrktCtoAmatch_sf %>% mutate(mrktID = paste(ward.name.A,village.A,market.name.A, sep = "-"))
# 
# districts <- mrktc_sf %>% distinct(district.region.name) %>% pull()
# Districts <- str_to_title(districts)
# 
# map_plots <- list()
# for (i in 1:length(districts)) {
#   
#   District_i <- Districts[i]
#   district_i <- districts[i]
#   
#   map_plots[[i]] <- ggplot() +
#     geom_sf(data = tregs_shp %>% filter(Region_Nam == District_i), fill = NA) +
#     geom_sf(data = mrkta_sf %>% filter(district.region.name == district_i), aes(col = mrktID), alpha = 0.5, size = 3)+
#     geom_sf(data = mrktCtoAmatch_sf %>% filter(district.region.name.A == district_i), aes(col = mrktID), shape = 17, size = 1)+
#     scale_colour_brewer(palette = "Paired")+
#     facet_wrap(~district.region.name)+
#     coord_sf()+
#     theme_bw()
# }
# 
# map_plots[[1]] <- ggplot() +
#   geom_sf(data = tregs_shp %>% filter(Region_Nam == "Mtwara"), fill = NA) +
#   geom_sf(data = mrkta_sf %>% filter(district.region.name == "mtwara"), col = "black", alpha = 0.5, size = 3)+
#   geom_sf(data = mrktCtoAmatch_sf %>% filter(district.region.name.A == "mtwara"), col = "red", shape = 17, size = 1)+
#   # scale_colour_brewer(palette = "Paired")+
#   facet_wrap(~district.region.name)+
#   coord_sf()+
#   theme_bw()
# 
# map_plots[[1]]; map_plots[[2]]; map_plots[[3]]; map_plots[[4]]; map_plots[[5]]; map_plots[[6]]; map_plots[[7]]; 
# map_plots[[8]]; map_plots[[9]]; map_plots[[10]]; map_plots[[11]]

```
# Market Maps (2): Geo-matched Locations


# Market A Map 2.1: 
- Market A geo-matched to Tanzania Administrative Levels

```{r mrktcMap_A-Ward-matched}
sf_use_s2(FALSE)
mrkta_sf2 <- st_transform(mrkta_sf, crs = st_crs(twards_shp))

twards_shp <- twards_shp %>%
  mutate("District_N" = tolower(gsub(" ", ".", District_N)),
        "Region_Nam" = tolower(gsub(" ",".",Region_Nam)),
        "Ward_Name" = tolower(gsub(" ",".",Ward_Name))
        )

mrktAtwards_match <- mrkta_mapdata %>%
  mutate(twardID = st_nearest_feature(mrkta_sf2,twards_shp)) %>% 
  left_join(
    twards_shp %>%
      mutate(twardID = 1:nrow(.)) %>%
      select(
        twardID,
        "region.name.twards" = "Region_Nam",
        "district.name.twards" = "District_N",
        "ward.name.twards" = "Ward_Name" ,
      ),
    by = c("twardID"))
# mrktCtwards_match %>% group_by(region.name.twards, district.name.twards) %>% count() %>% View()


mrktAtwards_match_gps <- mrktAtwards_match %>%
  select(
      country,
      region.name.twards,
      district.name.twards,
      ward.name.twards,
      district.region.name.A = district.region.name,
      ward.name.A = ward.name,
      village.A = village,
      market.name.A = market.name.corrected,
      lat,
      long,
      gps.coordinates.of.the.market
    ) %>% 
  mutate(region.district.name.twards = paste(region.name.twards, district.name.twards, sep = "-"))

mrktAtwards_match_sf <- st_as_sf(mrktAtwards_match_gps, coords = c("long","lat"),  crs = 4326)


##################################
# Geo-matched Map, check Regions #
##################################

## Region: id regions with surveyed markets:
regions <- mrktAtwards_match_sf %>% distinct(region.name.twards) %>% pull()
Regions <- str_to_title(regions)

mrktAtwards_match_map <- ggplot() +
  geom_sf(data = tregs_shp, fill = NA, linewidth = 0.1) +

   geom_sf(data = twards_shp %>% filter(Region_Nam %in% regions), aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   # geom_sf(data = mrkta_sf, aes(col = district.region.name), alpha = 0.5, size = 3)+
  geom_sf(data = mrktAtwards_match_sf, aes(col = region.name.twards), alpha = 0.5, size = 3)+
  geom_sf(data = mrktAtwards_match_sf, aes(col = district.region.name.A),  shape = 17, size = 1.5)+
   scale_colour_manual(values = rep(market_pal,9))+
   coord_sf()+
   labs(title = "Market Survey A locations: ward-matched (circle) and manual (triangle)",
        fill = "Tanzania region",
        col = "Market region")+
  #theme(legend.position = "none") #+
  theme(legend.position = "bottom", legend.box = "horizontal")
 
mrktAtwards_match_map

#########################################
# Geo-matched Map, check Ward by Region #
#########################################

## Region: id wards with surveyed markets:
wardlist <- mrktAtwards_match %>% select(ward.name.twards) %>% distinct() %>% pull()

map_plots <- list()
for (i in 1:length(regions)) {

  Region_i <- Regions[i]
  region_i <- regions[i]
  
  # For region (i) id wards with surveyed markets according to geo-matched data 
  wardlist_i <- mrktAtwards_match %>% 
    filter(region.name.twards == region_i) %>% 
    select(ward.name.twards) %>% 
    distinct() %>% pull()
  
  map_plots[[i]] <- ggplot() +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i), fill = NA) +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i,
                                         Ward_Name %in% wardlist_i), 
            aes(fill = Ward_Name, alpha = 0.5)) +

    geom_sf(data = mrktAtwards_match_sf %>% filter(region.name.twards == region_i),
            aes(col = ward.name.twards),  alpha = 0.5, size = 3)+
    # geom_sf(data = mrktAtwards_match_sf %>% filter(region.name.twards == region_i), 
    #         aes(col = ward.name.A),  shape = 17, size = 1.5)+
    # geom_sf(data = mrktCtwards_match_sf%>% filter(region.name.twards == region_i), aes(col = ward.name.3A),  shape = 17, size = 1.5)+
    scale_fill_manual(values = rep(market_pal,10))+    
    scale_colour_manual(values = rep(market_pal,10))+
    facet_wrap(~region.name.twards)+
    coord_sf()+
    theme(legend.position = "bottom")
}

map_plots[[1]]; map_plots[[2]]; map_plots[[3]]; map_plots[[4]]; map_plots[[5]]; map_plots[[6]]; map_plots[[7]];
map_plots[[8]]; map_plots[[9]]; map_plots[[10]]; map_plots[[11]]; map_plots[[12]]; map_plots[[13]]
```

# Market C Map 2.2: 
- Market C geo-matched to Tanzania Administrative Levels


```{r mrktcMap_C-geomatched}
sf_use_s2(FALSE)
mrktc_sf2 <- st_transform(mrktc_sf, crs = st_crs(twards_shp))

twards_shp <- twards_shp %>%
  mutate("District_N" = tolower(gsub(" ", ".", District_N)),
        "Region_Nam" = tolower(gsub(" ",".",Region_Nam)),
        "Ward_Name" = tolower(gsub(" ",".",Ward_Name))
        )

mrktCtwards_match <- mrktc_mapdata %>%
  mutate(twardID = st_nearest_feature(mrktc_sf2,twards_shp)) %>% 
  left_join(
    twards_shp %>%
      mutate(twardID = 1:nrow(.)) %>%
      select(
        twardID,
        "region.name.twards" = "Region_Nam",
        "district.name.twards" = "District_N",
        "ward.name.twards" = "Ward_Name" ,
      ),
    by = c("twardID"))
# mrktCtwards_match %>% group_by(region.name.twards, district.name.twards) %>% count() %>% View()

mrktCtwards_match_gps <- mrktCtwards_match %>%
  select(
      country,
      region.name.twards,
      district.name.twards,
      ward.name.twards,
      district.region.name.3A = district.region.name,
      ward.name.3A,
      village.3A,
      market.name.3A,
      lat,
      long,
      gps.coordinates.of.the.market
    ) %>% 
  mutate(region.district.name.twards = paste(region.name.twards, district.name.twards, sep = "-"))
  
mrktCtwards_match_sf <- st_as_sf(mrktCtwards_match_gps, coords = c("long","lat"),  crs = 4326)


##################################
# Geo-matched Map, check Regions #
##################################

## Region: id regions with surveyed markets:
regions <- mrktCtwards_match_sf %>% distinct(region.name.twards) %>% pull()
Regions <- str_to_title(regions)

mrktCtwards_match_sf <- st_as_sf(mrktCtwards_match_gps, coords = c("long","lat"),  crs = 4326)

mrktCtwards_match_map <- ggplot() +
  geom_sf(data = tregs_shp, fill = NA, linewidth = 0.1) +

   geom_sf(data = twards_shp %>% filter(Region_Nam %in% regions), aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   # geom_sf(data = mrktc_sf, aes(col = district.region.name), alpha = 0.5, size = 3)+
  geom_sf(data = mrktCtwards_match_sf, aes(col = region.name.twards), alpha = 0.5, size = 3)+
  geom_sf(data = mrktCtwards_match_sf, aes(col = district.region.name.3A),  shape = 17, size = 1.5)+
   scale_colour_manual(values = rep(market_pal,9))+
   coord_sf()+
   labs(title = "Market Survey C locations: ward-matched (circle) and manual (triangle)",
        fill = "Tanzania region",
        col = "Market region")+
  #theme(legend.position = "none") #+
  theme(legend.position = "bottom", legend.box = "horizontal")
 
mrktCtwards_match_map
```

```{r, mrktcMap_C-geomatchedWards}
#########################################
# Geo-matched Map, check Ward by Region #
#########################################

## Region: id wards with surveyed markets:
wardlist <- mrktCtwards_match %>% select(ward.name.twards) %>% distinct() %>% pull()

map_plots <- list()
for (i in 1:length(regions)) {

  Region_i <- Regions[i]
  region_i <- regions[i]
  
  # For region (i) id wards with surveyed markets according to geo-matched data 
  wardlist_i <- mrktCtwards_match %>% 
    filter(region.name.twards == region_i) %>% 
    select(ward.name.twards) %>% 
    distinct() %>% pull()
  
  map_plots[[i]] <- ggplot() +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i), fill = NA) +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i,
                                         Ward_Name %in% wardlist_i), 
            aes(fill = Ward_Name, alpha = 0.5)) +

    geom_sf(data = mrktCtwards_match_sf %>% filter(region.name.twards == region_i), aes(col = ward.name.twards),  alpha = 0.5, size = 3)+
    # geom_sf(data = mrktCtwards_match_sf %>% filter(region.name.twards == region_i), aes(col = ward.name.3A),  shape = 17, size = 1.5)+
  #   geom_sf(data = mrktCtwards_match_sf %>% filter(region.name.twards == region_i)%>% filter(region.name.twards == region_i), aes(col = region.name.twards), alpha = 0.5, size = 3)+
  # geom_sf(data = mrktCtwards_match_sf %>% filter(region.name.twards == region_i), aes(col = district.region.name.3A),  shape = 17, size = 1.5)+
    scale_fill_manual(values = rep(market_pal,10))+    
    scale_colour_manual(values = rep(market_pal,10))+
    facet_wrap(~region.name.twards)+
    coord_sf()+
    theme(legend.position = "bottom")
}

map_plots[[1]]; map_plots[[2]]; map_plots[[3]]; map_plots[[4]]; map_plots[[5]]; map_plots[[6]]; map_plots[[7]];
map_plots[[8]]; map_plots[[9]]; map_plots[[10]]; map_plots[[11]]; map_plots[[12]]; map_plots[[13]]
```


```{r mrktcMap_C+A}

##################################
# Geo-matched Map, check Regions #
##################################

## Region: id regions with surveyed markets:
regions <- mrktCtwards_match_sf %>% distinct(region.name.twards) %>% pull()
Regions <- str_to_title(regions)

mrktCtwards_match_sf <- st_as_sf(mrktCtwards_match_gps, coords = c("long","lat"),  crs = 4326)

mrktAC_geomatch_map <- ggplot() +
  geom_sf(data = tregs_shp, fill = NA, linewidth = 0.1) +

   geom_sf(data = twards_shp %>% filter(Region_Nam %in% regions), aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   # geom_sf(data = mrktc_sf, aes(col = district.region.name), alpha = 0.5, size = 3)+
  geom_sf(data = mrktAtwards_match_sf, aes(col = region.name.twards), alpha = 0.5, size = 3)+
  geom_sf(data = mrktCtwards_match_sf, aes(col = region.name.twards),  shape = 17, size = 1.5)+
   scale_colour_manual(values = rep(market_pal,9))+
   coord_sf()+
   labs(title = "Geo-matched locations: Market A (circle) and Market C (triangle)",
        fill = "Tanzania region",
        col = "Market region")+
  #theme(legend.position = "none") #+
  theme(legend.position = "bottom", legend.box = "horizontal")
 
mrktAC_geomatch_map

```

```{r mrktcMap_C-Ward-matched2}

##################
# PLOTS BY WARD #
##################

map_plots <- list()
for (i in 1:length(regions)) {

  Region_i <- Regions[i]
  region_i <- regions[i]
  wardlist_i <- mrktCtwards_match %>% filter(region.name.twards == region_i) %>% select(ward.name.twards) %>% distinct() %>% pull()
  
  map_plots[[i]] <- ggplot() +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i), fill = NA) +
    geom_sf(data = twards_shp %>% filter(Region_Nam == region_i,
                                         Ward_Name %in% wardlist_i), aes(fill = Ward_Name, alpha = 0.5)) +

    geom_sf(data = mrktAtwards_match_sf%>% filter(region.name.twards == region_i), aes(col = ward.name.twards),  alpha = 0.5, size = 3)+
    geom_sf(data = mrktCtwards_match_sf%>% filter(region.name.twards == region_i), aes(col = ward.name.twards),  shape = 17, size = 1.5)+
    scale_fill_manual(values = rep(market_pal,10))+    
    scale_colour_manual(values = rep(market_pal,10))+
    facet_wrap(~region.name.twards)+
    coord_sf()+
    theme(legend.position = "bottom")
}

map_plots[[1]]; map_plots[[2]]; map_plots[[3]]; map_plots[[4]]; map_plots[[5]]; map_plots[[6]]; map_plots[[7]];
map_plots[[8]]; map_plots[[9]]; map_plots[[10]]; map_plots[[11]]; map_plots[[12]]; map_plots[[13]]

```

# Maps 3: C to geomathced A


```{r }

mrktCtoAmatch2 <- mrktCtwards_match_gps %>%
  mutate(mrktaID = st_nearest_feature(mrktCtwards_match_sf, mrktAtwards_match_sf)) %>% 
  left_join(
    mrktAtwards_match_gps %>%
      mutate(mrktaID = 1:nrow(.)) %>%
      select(
        mrktaID,
        # district.region.name.A,
        # ward.name.A,
        # village.A,
        # market.name.A,  
        "region.name.twards.A"=region.name.twards,
       "district.name.twards.A"= district.name.twards,
        "ward.name.twards.A"=ward.name.twards
      ),
    by = c("mrktaID"))


mrktCtoAmatch_gps2 <- mrktCtoAmatch2 %>%
  select(
      country,
      ends_with("twards.A"),
      lat,
      long,
      gps.coordinates.of.the.market
    )
  
mrktCtoAmatch_sf2 <- st_as_sf(mrktCtoAmatch_gps2, coords = c("long","lat"),  crs = 4326)

mrktCAmatched_map2 <- ggplot() +
   geom_sf(data = tregs_shp, aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  # market A locations
   geom_sf(data = mrktAtwards_match_sf, aes(col = region.name.twards), alpha = 0.5, size = 3)+
  # market C locations closest to market A locations
   geom_sf(data = mrktCtoAmatch_sf2, aes(col = region.name.twards.A),  shape = 17, size = 1.5)+
    geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+

   scale_colour_manual(values = rep(market_pal,9))+
   coord_sf()+
   labs(title = "Market Survey A (circles) and C (triangles) - C matched to geo-A",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktCAmatched_map2


ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_Nam %in% c("lindi", "mtwara")), aes(fill = Region_Nam), linewidth = 0.1) +
   scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  # market A locations
   geom_sf(data = mrktAtwards_match_sf%>% filter(region.name.twards %in% c("lindi", "mtwara")), aes(col = region.name.twards), alpha = 0.5, size = 3)+
  # market C locations closest to market A locations
   geom_sf(data = mrktCtoAmatch_sf2%>% filter(region.name.twards.A %in% c("lindi", "mtwara")), aes(col = region.name.twards.A),  shape = 17, size = 1.5)+
   scale_colour_manual(values = rep(market_pal,9))+
   coord_sf(xlim = c(38,39.5), ylim = c(-10,-11.5))+
   labs(title = "Market Survey A (circles) and C (triangles) - C matched to geo-A",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
```
