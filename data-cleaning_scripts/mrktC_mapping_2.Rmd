---
title: "marketC_mapping"
output: html_document
date: "2024-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}

library(sf)
library(here)
library(tidyverse)
library(RColorBrewer)
library(lwgeom)
library(ggpubr)

```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C", "#FFD700", "#1E90FF")
```


# Mapping Market Survey C Locations

- Load in market survey C data (following initial string cleaning)
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load in clean geomatched market survey A data.
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load Tanzania shapefile with ward boundaries
    - `r `"data/shapefiles/tza_admbnda_adm3_20181019.shp"`
    - Source <https://data.humdata.org/dataset/cod-ab-tza?> (ADM L3)

```{r data, include = F, warning = F, echo = F}

# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tzshp_final/tregs_final.shp")) # with region boundaries
  
# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tzshp_final/twards_final.shp"))# with ward boundaries

# Market A location data:
mrkta_gps <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_final.csv"))
# Market A locations gps lookup:
# mrkta_gps_manualgeomatchlkp <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_manualgeomatchlkp.csv"))

# Market C location data:
# - with manually cleaned location names (based on survey A named data)
# market C surveys with gps locations for geomatching:
mrktc_gps <- read_csv(file = here("data/tanzania_data/mrktc_gps_tanzania_CLEAN1.csv")) %>%
  rename(ward.code.manual = ward.code.3A,
         ward.name.manual = ward.name.3A,
         village.manual = village.3A, 
         market.name.manual = market.name.3A
         ) %>%
  filter(!is.na(gps.coordinates.of.the.market))

# market C surveys with NO gps locations for manual matching (to survey A):
mrktc_nogps <- read_csv(file = here("data/tanzania_data/mrktc_gps_tanzania_CLEAN1.csv")) %>%
  rename(ward.code.manual = ward.code.3A,
         ward.name.manual = ward.name.3A,
         village.manual = village.3A, 
         market.name.manual = market.name.3A
         ) %>%
  filter(is.na(gps.coordinates.of.the.market))

# For checking linked data:
mrktc_gps_raw <- read_csv(file = here(
  "data/data-cleaning_data/mrktc_generalinfo_tanzania_CLEAN.csv"
)) %>%
  select(
    fid,
    date,
    date.end,
    date.of.interview,
    country,
    region.code.raw = district.region.code,
    region.name.raw = district.region.name,
    ward.code.raw = ward.code,
    ward.name.raw = ward.name,
    village.raw = village,
    market.name.raw = market.name,
    ward.code.manual = ward.code.3A,
    ward.name.manual = ward.name.3A,
    village.manual = village.3A,
    market.name.manual = market.name.3A,
    gps.coordinates.of.the.market,
    unique.row.identifier.uuid.
  ) 

```

## Market A Maps: 

- Market A data, matched to Tanzania shapefile region-district-ward locations
- See `mrktA_mapping.Rmd`

```{r mrktaMap, warning = F}
# convert mrkta location data to mapping format & map manually cleaned data:

mrkta_mapdata <- mrkta_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)
```

```{r mrktaMapReg, echo = F, warning = F}
# Map of market survey locations coloured by region (consistency with Tanzania shapefile)

Regions_Amanual <- mrkta_sf %>% pull(region) %>% unique()

mrkta_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_N %in% Regions_Amanual), aes(fill = Region_N), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = region), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_N), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations (coloured by stringRegion)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_mapByReg

```

## Market Survey C Map (1): {.tabset}

### C survey locations only
- Market **Survey C** survey locations (manually cleaned), overlaid on Market **Survey A** locations (geo-matched)

```{r mrktcManual_only, warning = F}

mrktc_mapdata <- mrktc_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

# for now ignore rows which have na in lat or long:
mrktc_sf <- st_as_sf(mrktc_mapdata, coords = c("long","lat"),  crs = 4326) 

mrktC_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = Region_N), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrktc_sf, aes(col = district.region.name), size = 1)+
  geom_sf_text(data = tregs_shp, aes(label = Region_N), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+ 
  labs(title = "Market Survey C: survey locations (manual)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

mrktC_map
```

### C linked to A (manually)

```{r mrktcManual_overA, warning = F}
mrktCA_map <- ggplot() +
   geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(Region_N %in% Regions_Amanual), aes(fill = Region_N), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
   # scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
   geom_sf(data = mrkta_sf, aes(col = region), alpha = 0.5, size = 3)+
   geom_sf(data = mrktc_sf, aes(col = district.region.name),  shape = 17, size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = Region_N), size = 2)+
   scale_colour_manual(values = market_pal)+
   coord_sf()+
   labs(title = "Market Survey C (manual) over Market Survey A (geomatched)",
        fill = "Tanzania region",
        col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")
 
mrktCA_map

```


```{r datacheck, eval = F}
# Check consistency between markets in mrkta_gps and mrktc_gps_raw (.manual)
mrkta_gps %>% distinct(region.geomatch.final, ward.geomatch.final, market.manual.final)
mrktc_gps_raw %>% distinct(region.name.raw, ward.name.manual, market.name.manual)

```


## Market Survey C Clean (1): geo-link A

Use market survey C gps locations to link to market survey A geo-matched data.

 - Each market survey C entry should be linked to a market identified in market survey A data.
 - Linked market survey C locations to nearest market survey A locations

```{r mrktc_linkA}

# Join geomatched location data (from tanzania shapefile) to mrtka location data
mrktc_linkA_gps <- mrktc_gps %>%
  mutate(mrktaID = st_nearest_feature(mrktc_sf, mrkta_sf)) %>% 
  # join matched location data. by rowid (twardID)
  left_join(
    mrkta_mapdata %>%
      mutate(mrktaID = 1:nrow(.)) %>%
      select(
        mrktaID,
        "date.A" = date,
        "region.geomatch.final.A" = "region",
        "district.geomatch.final.A" = "district",
        "district20.geomatch.final.A" = "district20",
        "ward.geomatch.final.A" = "ward",
        "village.manual.final.A" = "village" ,
        "market.manual.final.A" = "market"
        # "reg.ward.mrkt.final.A" = "reg.ward.mrkt.final"
      ),
    by = c("mrktaID")) %>%
  select(-mrktaID) 

colnames(mrktc_linkA_gps)

mrktc_linkA_mapdata <- mrktc_linkA_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

mrktc_linkA_sf <- st_as_sf(mrktc_linkA_mapdata, coords = c("long","lat"),  crs = 4326) 

## MAP
map_plots <- list()
regions <- mrktc_linkA_gps %>% distinct(region.geomatch.final.A) %>% pull()

for(i in 1:length(regions)){
  
  region_i <- regions[i]
  
  map_plots[[i]] <- ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_N %in% region_i), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region %in% region_i), 
            aes(col = ward), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_linkA_sf %>% filter(region.geomatch.final.A %in% region_i), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_N)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

# gridExtra::grid.arrange(grobs = map_plots, ncol = 3)
```
## Market Survey C Map (2): geo-link A {.tabset}

- Market survey C locations linked to nearest market survey A location
- Should be a perfect match for C and A location data: 


### Dodoma

```{r dodomareg}
map_plots[[1]]
```

### Simiyu

```{r simiyureg}
map_plots[[2]]
```

### Mwanza

```{r mwanzareg}
map_plots[[3]]
```

### Katavi

```{r katavireg}
map_plots[[4]]
```

### Morogoro

```{r morogororeg}
map_plots[[5]]
```

### Mtwara

```{r mtwarareg}
map_plots[[6]]
```

### Mbeya

```{r mbeyareg}
map_plots[[7]]
```

### Rukwa

```{r}
map_plots[[8]]
```

### Iringa

```{r}
map_plots[[9]]
```

### Songwe

```{r}
map_plots[[10]]
```

### Njombe

```{r}
map_plots[[11]]
```

### Lindi

```{r}
map_plots[[12]]
```

### Ruvuma

```{r}
map_plots[[13]]
```


## Market Survey C Clean (2): check geo-link A data. {.tabset}

For each region, check consistency between:

  - geolinkA survey locations, date-of-survey and raw location data. 
  - Each survey in a given location should occur on the same date.
  - Where there are inconsistencies in geolinkA data and survey dates, check raw & manual data matching to check.

```{r check_linkA, warning = F, echo = F}

mrktc_linkA_matched <- mrktc_linkA_gps %>% 
  filter(date == date.A | date.end == date.A | date.of.interview == date.A)
  

mrktc_linkA_matched_sf <- mrktc_linkA_sf %>% 
  filter(date == date.A | date.end == date.A | date.of.interview == date.A)

# 
# 
# ## MAP
# map_plots <- list()
# regions <- mrktc_linkA_matched %>% distinct(region.geomatch.final.A) %>% pull()
# 
# for(i in 1:length(regions)){
#     
#     region_i <- regions[i]
#     
#     map_plots[[i]] <- ggplot() +
#         geom_sf(data = twards_shp %>% filter(Region_N %in% region_i), linewidth = 0.1) +
#         geom_sf(data = mrkta_sf %>% filter(region %in% region_i), 
#                 aes(col = ward), alpha = 0.5, size = 3)+
#         geom_sf(data = mrktc_linkA_matched_sf %>% filter(region.geomatch.final.A %in% region_i), 
#                 aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
#         scale_colour_manual(values = rep(market_pal,2))+
#         facet_wrap(~Region_N)+
#         coord_sf()+
#         labs(col = "Ward of market"
#              #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
#         )+
#         theme(legend.position = "right", legend.box = "horizontal")
#     
# }
# 
# map_plots[[1]]; map_plots[[2]]; map_plots[[3]]; map_plots[[4]]; map_plots[[5]]; 
# map_plots[[6]]; map_plots[[7]]; map_plots[[8]]; map_plots[[9]]; map_plots[[10]]; 
# map_plots[[11]]; map_plots[[12]]; map_plots[[13]]

# Check rukwa: 
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "rukwa", ward.geomatch.final.A == "kate") %>% View()
# happy with the match

# Mtwara queries, the following wards associated with more than 1 market, in some cases there is no corresponding A survey - will need to id and trim these surveys out of the dataframe in due course. 
# Jida (chanikanguo) / Chiungutwa (mbuyuni) / Migongo - all matched ok

# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mbeya", ward.geomatch.final.A == "imalilosongwe") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "mkuti") %>% View() # GOOD
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "mtonya") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "luchindu") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "jida") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "migongo") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "chiungutwa") %>% View()
# mrktc_linkA_matched %>% filter(region.geomatch.final.A == "mtwara", ward.geomatch.final.A == "mwena") %>% View()



mrktc_linkA_raw <- mrktc_linkA_gps %>%
  left_join(mrktc_gps_raw %>% select(fid, ends_with(".raw")), by = "fid") %>%
  select(
    fid, 
    date, 
    date.end, 
    date.of.interview,
    
    # manually cleaned C locations
    region.name.manual = "district.region.name",
    ward.name.manual,
    village.manual,
    market.name.manual,
    
    # geomatched C to A locations
    date.A,
    region.geomatch.final.A,
    district.geomatch.final.A,
    district20.geomatch.final.A,
    ward.geomatch.final.A,
    village.manual.final.A,
    market.manual.final.A,
    
    # raw C locations
    region.raw = "region.name.raw", 
    ward.name.raw = "ward.name.raw",
    village.raw,
    market.raw = "market.name.raw",
    
    gps.coordinates.of.the.market
  ) %>%
  mutate(
    unique.manual = paste(region.name.manual, ward.name.manual, village.manual, market.name.manual, sep = "-"),
    unique.A = paste(region.geomatch.final.A,district.geomatch.final.A,ward.geomatch.final.A,village.manual.final.A,market.manual.final.A, sep = "-"), 
    unique.raw = paste(region.raw,ward.name.raw,village.raw,market.raw, sep = "-")
  )


```

### Dodoma: 

```{r dodoma_clean, eval = F}

regions[1]

# Check plot: no inconsistency

map_plots[[1]] # all looks good on the plot

# Check location & date:

mrktc_linkA_raw %>% 
  filter(region.geomatch.final.A == "dodoma") %>%
  filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
  distinct(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
  View()

# 1 inconsistency

# A tibble: 1 × 6
#   date       date.end   date.of.interview unique.manual                date.A     unique.A                         
#   <date>     <date>     <date>            <chr>                        <date>     <chr>                            
# 1 2022-06-02 2022-06-03 2022-06-02        dodoma-bahi-bahi.sokoni-bahi 2022-06-01 dodoma-bahi-bahi-bahi.sokoni-bahi

# Accept market A date as correct




```

 
### Simiyu: 

```{r simiyu_clean, eval = F}
region_i <- regions[2]
map_plots[[2]]
# Map looks consistent


# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check)


# # A tibble: 9 × 8
# # Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [9]
#   date       date.end   date.of.interview unique.manual                              date.A     unique.A                                  n check
#   <date>     <date>     <date>            <chr>                                      <date>     <chr>                                 <int> <chr>
# 1 2022-05-19 2022-05-19 2022-05-19        simiyu-dutwa-igaganulwa-igaganulwa         2022-05-19 simiyu-bariadi-dutwa-igaganulwa-dutwa    84 match
# 2 2022-05-17 2022-05-17 2022-05-17        simiyu-kidinda-kidinda-kidinda             2022-05-17 simiyu-bariadi-bariadi-kidinda-kidin…    77 match
# 3 2022-05-16 2022-05-16 2022-05-16        simiyu-lalago-lalago-lalago                2022-05-16 simiyu-maswa-lalago-lalago-lalago        45 match
# 4 2022-05-18 2022-05-18 2022-05-18        simiyu-mwamapalala-mwamapalala-mwamapalala 2022-05-18 simiyu-itilima-mwamapalala-mwamapala…    34 match
# 5 2022-05-14 2022-05-23 2022-05-14        simiyu-mwasamba-mwasamba-mwasamba          2022-05-14 simiyu-busega-lutubiga-mwasamba-mwas…     1 match
# 6 2022-05-14 2022-05-28 2022-05-14        simiyu-mwasamba-mwasamba-mwasamba          2022-05-14 simiyu-busega-lutubiga-mwasamba-mwas…     1 match
# 7 2022-05-14 2022-05-28 2022-05-28        simiyu-mwasamba-mwasamba-mwasamba          2022-05-14 simiyu-busega-lutubiga-mwasamba-mwas…    18 match
# 8 2022-05-14 2022-05-28 2022-05-28        simiyu-mwasamba-mwasamba-mwasamba          2022-05-19 simiyu-bariadi-dutwa-igaganulwa-dutwa     2 unma… INCORRECT - mwasamba
# 9 2022-05-28 2022-05-28 2022-05-28        simiyu-mwasamba-mwasamba-mwasamba          2022-05-14 simiyu-busega-lutubiga-mwasamba-mwas…    79 unma… CORRECT - accept A


ggplot() +
  geom_sf(data = twards_shp %>% filter(Region_N %in% region_i), linewidth = 0.1) +
  geom_sf(data = mrkta_sf %>% filter(region %in% region_i), aes(col = ward), alpha = 0.5, size = 3)+
  geom_sf(data = mrktc_linkA_sf %>% 
            filter(region.geomatch.final.A %in% region_i,
                   ward.geomatch.final.A == "dutwa",
                   date.A == "2022-05-19"), 
            aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_N)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")


```

<!-- ```{r simiyuUpdate, warning = F, results = "hide"} -->

<!-- # Update all simiyu markets to uniqueMrkt -->
<!-- # Update "simiyu-bariadi-dutwa-igaganulwa-igaganulwa" & date == "2022-05-14" to "simiyu-busega-lutubiga-mwasamba-mwasamba" -->
<!-- # Update all "simiyu-busega-lutubiga-mwasamba-mwasamba" to date "2022-05-28" -->

<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "simiyu", uniqueMrkt, uniqueMrkt.check), -->
<!--     date.check = ifelse(region.geomatch.final.A == "simiyu", as.character(date), date.check), -->
<!--     date.check = ifelse(uniqueMrkt.check == "simiyu-bariadi-dutwa-igaganulwa-igaganulwa", "2022-05-19", date.check), -->
<!--     date.check = ifelse(uniqueMrkt.check == "simiyu-busega-lutubiga-mwasamba-mwasamba", "2022-05-28", date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="simiyu") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- ``` -->

### Mwanza: 

```{r mwanza_clean, eval = F}
region_i <- regions[3]
map_plots[[3]]
# Map looks consistent


# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check)

# Perfect

# # A tibble: 3 × 8
# # Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [3]
#   date       date.end   date.of.interview unique.manual                date.A     unique.A                                 n check
#   <date>     <date>     <date>            <chr>                        <date>     <chr>                                <int> <chr>
# 1 2022-05-23 2022-05-23 2022-05-23        mwanza-kabila-ndagalu-kabila 2022-05-23 mwanza-magu-nkungulu-ndagalu-kabila     79 match
# 2 2022-05-25 2022-05-25 2022-05-25        mwanza-misasi-manawa-misasi  2022-05-25 mwanza-misungwi-masasi-manawa-misasi    75 match
# 3 2022-05-21 2022-05-21 2022-05-21        mwanza-ngudu-kakola-kakola   2022-05-21 mwanza-kwimba-ngudu-kakola-dutwa        69 match

# Update: All correct no cleaning required.
```

<!-- ```{r mwanzaUpdate, warning =F, results = "hide"} -->

<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "mwanza", uniqueMrkt, uniqueMrkt.check), -->
<!--     date.check = ifelse(region.geomatch.final.A == "mwanza", as.character(date), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="mwanza") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count() -->

<!-- ``` -->


### Katavi: 

```{r katavi_clean, eval = F}
region_i <- regions[4]
map_plots[[4]]


# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check)

# A tibble: 26 × 8
# Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [26]
   date       date.end   date.of.interview unique.manual                          date.A     unique.A                                      n check  
   <date>     <date>     <date>            <chr>                                  <date>     <chr>                                     <int> <chr>  
 1 2022-05-25 2022-05-25 2022-05-25        katavi-inyonga-kinyonga-inyonga        2022-05-25 katavi-mlele-inyonga-kinyonga-inyonga        13 match  
 2 2022-05-25 2022-05-26 2022-05-25        katavi-inyonga-kinyonga-inyonga        2022-05-25 katavi-mlele-inyonga-kinyonga-inyonga        40 match  
 3 2022-05-30 2022-05-30 2022-05-30        katavi-itenka-itenka.a-itenka          2022-05-30 katavi-mlele-itenka-itenka.a-itenka          13 match  
 4 2022-05-30 2022-05-31 2022-05-30        katavi-itenka-itenka.a-itenka          2022-05-30 katavi-mlele-itenka-itenka.a-itenka          14 match  
 5 2022-05-30 2022-06-01 2022-05-30        katavi-itenka-itenka.a-itenka          2022-05-30 katavi-mlele-itenka-itenka.a-itenka           5 match  
 6 2022-05-30 2022-06-02 2022-05-30        katavi-itenka-itenka.a-itenka          2022-05-30 katavi-mlele-itenka-itenka.a-itenka           8 match  
 7 2022-05-31 2022-06-01 2022-05-31        katavi-kibaoni-kibaoni-kibaoni         2022-05-31 katavi-mlele-kibaoni-kibaoni-kibaoni         16 match  
 8 2022-05-31 2022-06-03 2022-05-31        katavi-kibaoni-kibaoni-kibaoni         2022-05-31 katavi-mlele-kibaoni-kibaoni-kibaoni         11 match  
 9 2022-05-31 2022-06-05 2022-05-31        katavi-kibaoni-kibaoni-kibaoni         2022-05-31 katavi-mlele-kibaoni-kibaoni-kibaoni          3 match  
10 2022-05-22 2022-05-22 2022-05-22        katavi-majimoto-kitupa-majimoto.a      2022-05-22 katavi-mlele-majimoto-kitupa-majimoto        38 match  
11 2022-05-22 2022-06-01 2022-05-22        katavi-majimoto-kitupa-majimoto.a      2022-05-22 katavi-mlele-majimoto-kitupa-majimoto         2 match  
12 2022-05-31 2022-05-31 2022-05-31        katavi-mamba-kilda.kona-kilda.kona     2022-05-31 katavi-mlele-mamba-kilda.kona-kilda.kona     20 match  
13 2022-06-03 2022-06-03 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-06-03 katavi-mpanda-kabungu-minyagala-minyagala     7 match  
14 2022-06-03 2022-06-05 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-06-03 katavi-mpanda-kabungu-minyagala-minyagala    15 match  
15 2022-06-03 2022-06-05 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-06-05 katavi-mpanda-sibwesa-sibwesa-sibwesa         2 match  
16 2022-06-03 2022-06-10 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-06-03 katavi-mpanda-kabungu-minyagala-minyagala     3 match  
17 2022-06-03 2022-06-20 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-06-03 katavi-mpanda-kabungu-minyagala-minyagala    12 match  
18 2022-06-05 2022-06-07 2022-06-05        katavi-sibwesa-minyagala-minyagala     2022-06-05 katavi-mpanda-sibwesa-sibwesa-sibwesa        15 match  
19 2022-06-05 2022-06-11 2022-06-05        katavi-sibwesa-minyagala-minyagala     2022-06-05 katavi-mpanda-sibwesa-sibwesa-sibwesa         6 match  
20 2022-06-05 2022-06-20 2022-06-05        katavi-sibwesa-minyagala-minyagala     2022-06-05 katavi-mpanda-sibwesa-sibwesa-sibwesa        22 match  
21 2022-06-03 2022-06-03 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-05-30 katavi-mlele-itenka-itenka.a-itenka           1 unmatch
22 2022-06-03 2022-06-05 2022-06-03        katavi-sibwesa-minyagala-minyagala     2022-05-30 katavi-mlele-itenka-itenka.a-itenka           9 unmatch
23 2022-06-05 2022-06-11 2022-06-05        katavi-sibwesa-minyagala-minyagala     2022-06-03 katavi-mpanda-kabungu-minyagala-minyagala     9 unmatch
24 2022-05-23 2022-05-23 2022-05-23        katavi-usevya-usevya-usevya            2022-05-23 katavi-mlele-usevya-usevya-usevya            17 match  
25 2022-05-23 2022-05-24 2022-05-23        katavi-usevya-usevya-usevya            2022-05-23 katavi-mlele-usevya-usevya-usevya            15 match  
26 2022-06-01 2022-06-05 2022-06-01        rukwa-kipeta-kilyamatundu-kilyamatundu 2022-05-30 katavi-mlele-itenka-itenka.a-itenka           1 unmatch


mrktc_linkA_check %>% filter(region.geomatch.final.A == "katavi") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "katavi") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#    uniqueMrkt                                date.of.interview date           n
#    <chr>                                     <date>            <date>     <int>
#  1 katavi-mlele-inyonga-kinyonga-inyonga     2022-05-25        2022-05-25    53 --> CORRECT
#  2 katavi-mlele-itenka-itenka.a-itenka       2022-05-30        2022-05-30    40 --> CORRECT
#  3 katavi-mlele-itenka-itenka.a-itenka       2022-06-01        2022-06-01     1 --> Checked: Accept linkA
#  4 katavi-mlele-itenka-itenka.a-itenka       2022-06-03        2022-06-03    10 --> Checked: Location Error (minyagala)
#  5 katavi-mlele-kibaoni-kibaoni-kibaoni      2022-05-31        2022-05-31    30 --> CORRECT
#  6 katavi-mlele-majimoto-kitupa-majimoto.a   2022-05-22        2022-05-22    40 --> CORRECT
#  7 katavi-mlele-mamba-kilda.kona-kilda.kona  2022-05-31        2022-05-31    20 --> CORRECT
#  8 katavi-mlele-usevya-usevya-usevya         2022-05-23        2022-05-23    32 --> CORRECT
#  9 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-03        2022-06-03    37 --> CORRECT
# 10 katavi-mpanda-kabungu-minyagala-minyagala 2022-06-05        2022-06-05     9 --> Checked: Unclear conclusion
# 11 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-03        2022-06-03     2 --> Checked: Unclear conclusion
# 12 katavi-mpanda-sibwesa-sibwesa-sibwesa     2022-06-05        2022-06-05    43 --> CORRECT

# Check "katavi-mlele-itenka-itenka.a-itenka"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka") %>%
  arrange(date)
  
# If date == 2022-06-01, correction to rukwa-kilyamatundu
# If date == 2022-06-03, correction to katavi-mpanda-kabungu-minyagala-minyagala

# check "katavi-mpanda-kabungu-minyagala-minyagala"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-kabungu-minyagala-minyagala") %>%
  arrange(date)
  
# If date == 2022-06-05 looks like correction may be: katavi-mpanda-sibwesa-sibwesa-sibwesa

# check "katavi-mpanda-sibwesa-sibwesa-sibwesa"
mrktc_linkA_check %>% 
  filter(uniqueMrkt == "katavi-mpanda-sibwesa-sibwesa-sibwesa") %>%
  arrange(date)
  
# If date == 2022-06-03 looks like correction may be "katavi-mpanda-kabungu-minyagala-minyagala"


# DOUBLE CHECKING: 
# mrktc_linkA_check %>%
#   filter(region.geomatch.final.A == "katavi") %>%
#   distinct(
#     region.name.raw,
#     ward.name.raw,
#     village.raw,
#     market.name.raw,
#     uniqueMrkt
#   ) %>%
#   View()
```

<!-- ```{r kataviUpdate, warning =F, results = "hide"} -->
<!-- # Map Check -->
<!-- region_i <- "katavi" -->
<!-- ggplot() + -->
<!--   geom_sf(data = twards_shp %>% filter(Region_N %in% str_to_title(region_i)), linewidth = 0.1) + -->
<!--   geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i),  -->
<!--           aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+ -->
<!--   geom_sf(data = mrktc_linkA_sf %>% filter(ward.geomatch.final.A == "itenka"),  -->
<!--           aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+ -->
<!--   scale_colour_manual(values = rep(market_pal,2))+ -->
<!--   facet_wrap(~Region_N)+ -->
<!--   coord_sf()+ -->
<!--   labs(col = "Ward of market" -->
<!--       #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data", -->
<!--       )+ -->
<!--   theme(legend.position = "right", legend.box = "horizontal") -->

<!-- # Update -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "katavi", uniqueMrkt, uniqueMrkt.check), -->
<!--     uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka" & date == "2022-06-03", "katavi-mpanda-kabungu-minyagala-minyagala", uniqueMrkt.check), -->
<!--     uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mpanda-kabungu-minyagala-minyagala" & date == "2022-06-05", "katavi-mpanda-sibwesa-sibwesa-sibwesa", uniqueMrkt.check), -->
<!--     uniqueMrkt.check = ifelse(uniqueMrkt == "katavi-mpanda-sibwesa-sibwesa-sibwesa" & date == "2022-06-03", "katavi-mpanda-kabungu-minyagala-minyagala", uniqueMrkt.check), -->
<!--     date.check = ifelse(region.geomatch.final.A == "katavi", as.character(date), date.check), -->
<!--     date.check = ifelse(uniqueMrkt == "katavi-mlele-itenka-itenka.a-itenka" & date == "2022-06-01", as.character("2022-05-30"), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="katavi") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->

<!-- ``` -->


### Morogoro: 

```{r morogoro_clean, eval = F}
region_i <- regions[5]
map_plots[[5]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")

# A tibble: 2 × 8
# Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [2]
#   date       date.end   date.of.interview unique.manual                      date.A     unique.A                                   n check  
#   <date>     <date>     <date>            <chr>                              <date>     <chr>                                  <int> <chr>  
# 1 2022-05-31 2022-06-04 2022-06-02        morogoro-minepa-mbuyuni-mbuyuni    2022-06-01 morogoro-ulanga-minepa-mbuyuni-mbuyuni     1 unmatch --> CORRECT (accept A)
# 2 2022-06-08 2022-06-09 2022-06-08        morogoro-salamiti-kiswago-salamiti 2022-06-10 morogoro-ulanga-itete-itete-itete          1 unmatch --> INCORRECT (= salamiti)

```

<!-- ```{r morogoroUpdate, warning = F, results = "hide"} -->

<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--     mutate( -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "morogoro", uniqueMrkt, uniqueMrkt.check), -->
<!--         date.check = ifelse(region.geomatch.final.A == "morogoro", as.character(date), date.check), -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-kilombero-idete-idandu-kikurukutu", as.character(date), date.check), #2022-06-02 -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-kilombero-kiberege-sagamaganga-sagamaganga", as.character(date.of.interview), date.check), #2022-06-07  -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-kilombero-mofu-miyomboni-mofu", as.character(date.of.interview), date.check), #2022-06-06  -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-kilosa-rudewa-gongoni-gongoni", as.character(date.of.interview), date.check), #2022-05-31   -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-mvomero-kanga-mziha-mziha", as.character(date.of.interview), date.check), #2022-05-30 -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-biro-tanga-tanga", as.character(date.of.interview), date.check), #2022-05-25  -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-iragua-namhanga-mbenja", as.character(date.of.interview), date.check), #2022-05-28 -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-itete-itete-itete", as.character("2022-06-10"), date.check), #"2022-06-10" -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-minepa-mavimba-mavimba", as.character("2022-05-23"), date.check), #"2022-05-23" -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-minepa-mbuyuni-mbuyuni", as.character("2022-06-01"), date.check), #"2022-06-01" -->
<!--         date.check = ifelse(uniqueMrkt == "morogoro-ulanga-usangule-kiswago-salamiti", as.character("2022-06-08"), date.check) #2022-06-08 -->
<!--     )  -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="morogoro") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->

<!-- ``` -->


### Mtwara: 

```{r mtwara_clean, eval = F, }
region_i <- regions[6]
map_plots[[6]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")


mrktc_linkA_check %>% filter(region.geomatch.final.A == "mtwara") 
uniqueMrkt_date_summary %>% filter(region.geomatch.final.A == "mtwara") %>% select(-region.geomatch.final.A)
# 
# Error Codes: "Checked: Date Error", "Checked: Location Error"
#   uniqueMrkt                                               date.of.interview date           n
#    <chr>                                                    <date>            <date>     <int>
#  1 mtwara-masasi-chikolopola-chikolopola-chikolopola        2022-06-11        2022-06-11     4
#  2 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-01     1
#  3 mtwara-masasi-chiungutwa-chiungutwa-chiungutwa           2022-06-02        2022-06-02    41
#  4 mtwara-masasi-chiwale-kivukoni-chiwale                   2022-06-07        2022-06-07    21
#  5 mtwara-masasi-lukuledi-lukuledi-lukuledi                 2022-06-07        2022-06-07    19
#  6 mtwara-masasi-mchauru-mchauru-mchauru                    2022-06-04        2022-06-04    20
#  7 mtwara-masasi-mkundi-majembe-mkundi                      2022-06-06        2022-06-06    20
#  8 mtwara-masasi-mnavira-mnavira-mnavira                    2022-06-11        2022-06-11     4
#  9 mtwara-masasi-mnavira-nakarara-makong.onda               2022-06-04        2022-06-04    20
# 10 mtwara-masasi-mwena-chibwini-mwena                       2022-06-08        2022-06-08     8
# 11 mtwara-masasi-mwena-chibwini-mwena                       2022-06-09        2022-06-09     4
# 12 mtwara-masasi-namalenga-nagaga-namalenga                 2022-06-06        2022-06-06    20
# 13 mtwara-masasi-nanganga-mwongozo-nangoo                   2022-06-08        2022-06-08     8
# 14 mtwara-masasi-nanjota-nanjota-nanjota                    2022-06-03        2022-06-03    28
# 15 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-28        2022-05-28    30
# 16 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-29        2022-05-28    21
# 17 mtwara-masasi.township.authority-jida-mtandi.b-mtandi    2022-05-30        2022-05-28     1
# 18 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-05-30     1
# 19 mtwara-masasi.township.authority-marika-mumbaka-mumbaka  2022-06-01        2022-06-01    32
# 20 mtwara-masasi.township.authority-migongo-nangaya-nangaya 2022-05-26        2022-05-26    10
# 21 mtwara-masasi.township.authority-mkuti-madeco-madeco     2022-05-26        2022-05-26     9
# 22 mtwara-masasi.township.authority-nyasa-upanga-upanga     2022-05-25        2022-05-25     1
# 23 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-29        2022-05-29     1
# 24 mtwara-nanyumbu-nanyumbu-maneme-nanyumbu                 2022-05-30        2022-05-30    60
# 25 mtwara-newala-kitangari-kitangari-kitangari              2022-06-10        2022-06-10     4
# 26 mtwara-newala-luchindu-luchingu-luchingu                 2022-06-10        2022-06-10     3
# 27 mtwara-newala-luchindu-tupendane-tulindane               2022-06-10        2022-06-10     4
# 28 mtwara-newala-mtonya-majengo-mtonya                      2022-06-10        2022-06-10     4
# 29 mtwara-newala-mtonya-nangwala-nangwala                   2022-06-10        2022-06-10     4
```


<!-- ```{r mtwaraUpdate, warning = F, results = "hide"} -->
<!-- region_i <- "mtwara" -->
<!-- ggplot() + -->
<!--   geom_sf(data = twards_shp %>% filter(Region_N %in% str_to_title(region_i)), linewidth = 0.1) + -->
<!--   geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i),  -->
<!--           aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+ -->
<!--   geom_sf(data = mrktc_linkA_sf %>% filter(region.geomatch.final.A == region_i),  -->
<!--           aes(col = ward.geomatch.final.A),  shape = 17, size = 1.5)+ -->
<!--   # scale_colour_manual(values = rep(market_pal,2))+ -->
<!--   facet_wrap(~Region_N)+ -->
<!--   # coord_sf(ylim = c(-10.9,-10.6), xlim = c(38.6,39.3))+ -->
<!--   coord_sf()+ -->
<!--   labs(col = "Ward of market" #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data", -->
<!--       )+ -->
<!--   theme(legend.position = "right", legend.box = "horizontal") -->

<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--     mutate( -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mtwara", uniqueMrkt, uniqueMrkt.check), -->
<!--         date.check = ifelse(region.geomatch.final.A == "mtwara", as.character(date), date.check)) -->
<!-- ``` -->

### Mbeya: 

```{r mbeya_clean, eval = F, results = "hide"}
region_i <- regions[7]
map_plots[[7]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")


# # A tibble: 5 × 8
# # Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [5]
#   date       date.end   date.of.interview unique.manual                                   date.A     unique.A                                                       n check
#   <date>     <date>     <date>            <chr>                                           <date>     <chr>                                                      <int> <chr>
# 1 2022-05-28 2022-05-28 2022-05-28        mbeya-igava-muungano-muungano                   2022-06-07 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.us…    11 unma… --> INCORRECT (muungano)
# 2 2022-05-29 2022-05-29 2022-05-29        mbeya-imalilosongwe-imalilosongwe-imalilosongwe 2022-06-04 mbeya-mbarali-rujewa-ihanga-rujewa                             7 unma… --> INCORRECT (imalilosongwe)
# 3 2022-05-29 2022-05-29 2022-05-29        mbeya-imalilosongwe-imalilosongwe-imalilosongwe 2022-06-07 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.us…     1 unma… --> INCORRECT (imalilosongwe)
# 4 2022-05-27 2022-05-27 2022-05-27        mbeya-mapogoro-mapogoro-mapogoro                2022-06-04 mbeya-mbarali-rujewa-ihanga-rujewa                             1 unma… --> INCORRECT (mapogoro)
# 5 2022-05-27 2022-05-27 2022-05-27        mbeya-mapogoro-mapogoro-mapogoro                2022-06-07 mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.us…     2 unma… --> INCORRECT (mapogoro)

```

<!-- ```{r mbeyaUpdate, warning =F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--     mutate( -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya", uniqueMrkt, uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-26", "mbeya-mbarali-madibira-chalisuka-madibira", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-27", "mbeya-mbarali-miyombweni-mapogoro-mapogoro", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-04", "mbeya-mbarali-rujewa-ihanga-rujewa", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-07", "mbeya-mbarali-utengule.usangu-utengule.usangu-utengule.usangu", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-05-28", "mbeya-mbarali-igava-muungano-muungano", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == " 2022-05-29", "mbeya-mbarali-imalilosongwe-imalilosongwe-imalilosongwe", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-12", "mbeya-chunya-mtanila-igangwe-shauri.moyo", uniqueMrkt.check), -->
<!--         uniqueMrkt.check = ifelse(region.geomatch.final.A == "mbeya" & date == "2022-06-14", "mbeya-chunya-mamba-mamba-shinyanga", uniqueMrkt.check), -->
<!--         date.check = ifelse(region.geomatch.final.A == "mbeya", as.character(date), date.check) -->
<!--     )  -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="mbeya") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->

<!-- ``` -->

### Rukwa: 

```{r rukwa_clean, eval = F, results = "hide"}
region_i <- regions[8]
map_plots[[8]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")

# All matched 
```

<!-- ```{r rukwaUpdate, warning=F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "rukwa", uniqueMrkt, uniqueMrkt.check), -->
<!--     date.check = ifelse(region.geomatch.final.A == "rukwa", as.character(date), date.check), -->
<!--     date.check = ifelse(uniqueMrkt == "rukwa-nkasi-kate-ntalamila-ntalamila" & date == "2022-05-26", as.character("2022-05-27"), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="rukwa") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->
<!-- ``` -->

### Iringa: 

```{r iringa_clean, eval =F}

region_i <- regions[9]
map_plots[[9]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")

# All matched 
```

<!-- ```{r iringaUpdate, warning=F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "iringa", uniqueMrkt, uniqueMrkt.check), -->
<!--     # date of interview field is correct for all locations>>> -->
<!--     date.check = ifelse(region.geomatch.final.A == "iringa", as.character(date.of.interview), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="iringa") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->

<!-- ``` -->

### Songwe: 

```{r songwe_clean, eval =F}

region_i <- regions[10]
map_plots[[10]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")


# All matched

```


<!-- ```{r songweUpdate, warning =F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "songwe", uniqueMrkt, uniqueMrkt.check), -->
<!--     # date of interview field is correct for all locations>>> -->
<!--     date.check = ifelse(region.geomatch.final.A == "songwe", as.character(date), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="songwe") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->

<!-- ``` -->



### Njombe: 

```{r njombe_clean, eval =F}

region_i <- regions[11]
map_plots[[11]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")

# # A tibble: 1 × 8
# # Groups:   date, date.end, date.of.interview, unique.manual, date.A, unique.A [1]
#   date       date.end   date.of.interview unique.manual                     date.A     unique.A                                                       n check  
#   <date>     <date>     <date>            <chr>                             <date>     <chr>                                                      <int> <chr>  
# 1 2022-06-01 2022-06-01 2022-06-01        iringa-ihowanza-ihowanza-ihowanza 2022-06-06 njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe     2 unmatch

# INCORRECT --> Ihowanza

```

<!-- ```{r njombeUpdate, warning =F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "njombe", uniqueMrkt, uniqueMrkt.check), -->
<!--     uniqueMrkt.check = ifelse(uniqueMrkt.check == "njombe-wanging.ombe-wanging.ombe-wanging.ombe-wanging.ombe" & date == "2022-06-01", "iringa-mufindi-ihowanza-ihowanza-ihowanza", uniqueMrkt.check), -->
<!--     # date of interview field is correct for all locations>>> -->
<!--     date.check = ifelse(region.geomatch.final.A == "njombe", as.character(date.of.interview), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="njombe") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->

<!-- ``` -->

### Lindi: 

```{r lindi_clean, eval =F}

region_i <- regions[12]
map_plots[[12]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")

# All matched

```

<!-- ```{r lindiUpdate, warning=F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "lindi", uniqueMrkt, uniqueMrkt.check), -->
<!--     # date of interview field is correct for all locations>>> -->
<!--     date.check = ifelse(region.geomatch.final.A == "lindi", as.character(date.of.interview), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="lindi") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->

<!-- ``` -->

### Ruvuma: 

```{r ruvuma_clean, eval =F}


region_i <- regions[13]
map_plots[[13]]
# Check location & date:

mrktc_linkA_raw %>% 
    filter(region.geomatch.final.A == region_i) %>%
    # filter(!(date == date.A | date.end == date.A | date.of.interview == date.A)) %>%
    group_by(date,date.end,date.of.interview, unique.manual, date.A, unique.A) %>%
    count() %>%
    mutate(check = if_else((date == date.A | date.end == date.A | date.of.interview == date.A), "match", "unmatch")) %>%
    arrange(unique.manual, check) %>%
  filter(check == "unmatch")


# All matched!
```

<!-- ```{r ruvumaUpdate, warning = F, results = "hide"} -->
<!-- mrktc_linkA_check2 <- mrktc_linkA_check2 %>% -->
<!--   mutate( -->
<!--     uniqueMrkt.check = ifelse(region.geomatch.final.A == "ruvuma", uniqueMrkt, uniqueMrkt.check), -->
<!--     # date of interview field is correct for all locations>>> -->
<!--     date.check = ifelse(region.geomatch.final.A == "ruvuma", as.character(date.of.interview), date.check)) -->

<!-- mrktc_linkA_check2 %>% filter(region.geomatch.final.A=="ruvuma") %>% group_by(date.check, uniqueMrkt.check) %>% count() -->
<!-- mrktc_linkA_check2 %>% group_by(date.check, uniqueMrkt.check) %>% count()  -->
<!-- ``` -->








## Market Survey C Clean (3): Clean GPS Data

Use cleaned survey C (geo-linked A) locations to update market survey C gps data. 

```{r mrktc_linkA_cleangps, warning = F}

mrktc_gps_check <- mrktc_linkA_check2 %>% 
  # copy mrktCheck for splitting
  mutate(uniqueMrktSep = uniqueMrkt.check) %>% 
  # split uniqueMrkt variable into component locations: 
  separate(uniqueMrktSep, c("region.check", "district.check", "ward.check", "village.check", "market.check"), sep = "-") %>%
  # check code: 
  select(fid, date, date.check, country, uniqueMrkt.check, contains(".check"), gps.coordinates.of.the.market, unique.row.identifier.uuid.)

```


```{r mrktc_linkACheck, warning = F}

mrktc_mapdata_check <- mrktc_gps_check %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2])
  # arrange(gps.coordinates.of.the.market) %>% 
  # filter(!is.na(lat), !is.na(long))

mrktc_sf_check <- st_as_sf(mrktc_mapdata_check, coords = c("long","lat"),  crs = 4326) 

## MAP
map_checks <- list()
regions <- mrktc_gps_check %>% distinct(region.check) %>% pull()

for(i in 1:length(regions)){
  
  region_i <- regions[i]
  
  map_checks[[i]] <- ggplot() +
   geom_sf(data = twards_shp %>% filter(Region_N %in% str_to_title(region_i)), linewidth = 0.1) +
    geom_sf(data = mrkta_sf %>% filter(region.geomatch.final %in% region_i), 
            aes(col = ward.geomatch.final), alpha = 0.5, size = 3)+
    geom_sf(data = mrktc_sf_check %>% filter(region.check %in% region_i), 
            aes(col = ward.check),  shape = 17, size = 1.5)+
    scale_colour_manual(values = rep(market_pal,2))+
    facet_wrap(~Region_N)+
   coord_sf()+
   labs(col = "Ward of market"
        #title = "Market Survey A-geomatched (circles) and C-linkA (triangles) data",
        )+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

```


## Regions Checked {.tabset}

### Dodoma

```{r dodomacheck}
map_checks[[1]]
```

### Simiyu

```{r simiyucheck}
map_checks[[2]]
```

### Mwanza

```{r mwanzacheck}
map_checks[[3]]
```

### Katavi

```{r katavicheck}
map_checks[[4]]
```

### Morogoro

```{r morogorocheck}
map_checks[[5]]
```

### Mtwara-Unchecked

```{r mtwaracheck}
map_checks[[6]]
```

### Mbeya

```{r mbeyacheck}
map_checks[[7]]
```

### Rukwa

```{r rukwacheck}
map_checks[[8]]
```

### Iringa

```{r iringacheck}
map_checks[[9]]
```

### Songwe

```{r songwecheck}
map_checks[[10]]
```

### Njombe

```{r njombecheck}
map_checks[[11]]
```

### Lindi

```{r lindicheck}
map_checks[[12]]
```

### Ruvuma

```{r ruvumacheck}
map_checks[[13]]
```


## NEXT STEPS:
Review number of markets, number of surveys per market etc.
```{r savedata}
if(filesave){
  write_csv(mrktc_gps_check, file = here("data/data-cleaning_data/mrktc_gps_tanzania_final.csv"))
  write_csv(mrktc_gps_check, file = here("data/tanzania_data/mrktc_gps_tanzania_final.csv"))
}


```

# Market survey C: No GPS

```{r mrktcNogps}
# rows of data:
mrktc_nogps %>% nrow()

# colnames for matching link manual location data from C_nogps to A, to join gps data for each market
colnames(mrktc_nogps); colnames(mrkta_gps_manualgeomatchlkp)

mrktc_nogps_linkA <- mrktc_nogps %>%
  rename(region.manual = district.region.name,
         ward.manual = ward.name.manual,
         market.manual = market.name.manual) %>%
  select(-c(gps.coordinates.of.the.market)) %>% # no gps for C data
  left_join(
    mrkta_gps_manualgeomatchlkp %>% select(-c(fid, country, unique.row.identifier.uuid.)),
    by = c("date","region.manual", "ward.manual","village.manual","market.manual")
  )

mrktc_nogps_linkA_check <- mrktc_nogps_linkA %>%
  left_join(mrktc_gps_raw %>% select(fid, ends_with(".raw")), by = "fid") %>%
  # create a unique field for checking data:
  mutate(
    uniqueMrkt = paste(
    region.geomatch.final,
    district.geomatch.final,
    # district data not included in survey
    ward.geomatch.final,
    village.manual.final,
    market.manual.final,
    sep = "-"
    )
  )

# Unmatched mtwara-mbuyuni
# MTAWARA-MBUYUN matches to CHIUNGUTWA
unmatchedfid <- mrktc_nogps_linkA %>% 
  filter(is.na(gps.coordinates.of.the.market)) %>% 
  select(fid) %>% 
  bind_cols(
    mrkta_gps %>% filter(ward.geomatch.final == "chiungutwa") %>% 
      select(
        contains("final"),
        gps.coordinates.of.the.market)
  )

mrktc_nogps_linkA <- mrktc_nogps_linkA %>%
  left_join(unmatchedfid, by = c("fid"), suffix = c("_A", "_B")) %>%
  mutate(
    "region.geomatch.final" = coalesce(region.geomatch.final_A, region.geomatch.final_B),
    "district.geomatch.final" = coalesce(district.geomatch.final_A, district.geomatch.final_B),
    "ward.geomatch.final" = coalesce(ward.geomatch.final_A, ward.geomatch.final_B),
    "village.manual.final" = coalesce(village.manual.final_A, village.manual.final_B),
    "market.manual.final" = coalesce(market.manual.final_A, market.manual.final_B),
    "reg.ward.mrkt.final" = coalesce(reg.ward.mrkt.final_A, reg.ward.mrkt.final_B),
    "gps.coordinates.of.the.market" = coalesce(gps.coordinates.of.the.market_A, gps.coordinates.of.the.market_B)
  ) %>%
  select(-ends_with("_A"), -ends_with("_B"))

mrktc_gps_check %>% colnames()
mrktc_nogps_check <- mrktc_nogps_linkA %>% 
  mutate(uniqueMrkt.check = paste(region.geomatch.final,district.geomatch.final,ward.geomatch.final,village.manual.final,market.manual.final, sep = "-"),
         date.check = as.character(date)) %>%
  select(fid,
         date,
         date.check, 
         country,
         uniqueMrkt.check = uniqueMrkt.check, 
         region.check = region.geomatch.final,
         district.check = district.geomatch.final,
         ward.check = ward.geomatch.final,
         village.check = village.manual.final,
         market.check = market.manual.final,
         gps.coordinates.of.the.market,
         unique.row.identifier.uuid.)

mrktc_allgps_check <- bind_rows(mrktc_gps_check,mrktc_nogps_check) %>%
  rename(
    date.final = date.check,
    uniqueMrkt.final = uniqueMrkt.check,
    region.final = region.check,
    district.final = district.check,
    ward.final = ward.check,
    village.final = village.check,
    market.final = market.check
  )
```

## NEXT STEPS:
Review number of markets, number of surveys per market etc.
```{r savedata2}
if(filesave){
  write_csv(mrktc_allgps_check, file = here("data/data-cleaning_data/mrktc_allgps_tanzania_final.csv"))
  write_csv(mrktc_allgps_check, file = here("data/tanzania_data/mrktc_allgps_tanzania_final.csv"))
}
```

