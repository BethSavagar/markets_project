---
title: "marketA_mapping"
output: html_document
date: "2024-01-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}

library(sf)
library(here)
library(tidyverse)
library(RColorBrewer)
library(lwgeom)
library(ggpubr)

```

```{r theme, include = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C")
```


# Mapping Market Survey A Locations

- Load in raw market survey A data (following initial string cleaning)
    - `r `"data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv"`
- Load Tanzania shapefile with ward boundaries
    - `r `"data/shapefiles/tza_admbnda_adm3_20181019.shp"`
    - Source <https://data.humdata.org/dataset/cod-ab-tza?> (ADM L3)
- Cross-reference market location data from survey A (region-ward-village) and tanzania shapefile (region-district-ward)

```{r data, include = T, warning = F, echo = F, message = F}

# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tzshp_final/tregs_final.shp")) # with region boundaries
# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tzshp_final/twards_final.shp")) # with ward boundaries

# Market A location data:
mrkta_info <- read_csv(file = here("data/data-cleaning_data/mrkta_generalinfo_tanzania_CLEAN.csv"))
mrkta_gps <- read_csv(file = here("data/data-cleaning_data/mrkta_gps_tanzania_CLEAN.csv"))

```



# Tanzania Map
- Tanzania shapefile with ward boundaries sourced from: https://data.humdata.org/dataset/cod-ab-tza? (ADM L3)

```{r tanzaniaMap, include = F}
tregs_shp <- tregs_shp %>%
  rename("region.name" = Region_N)
  
twards_shp <- twards_shp %>%
  rename(
    region.name = Region20_N,    
    district.name = Dist_N,
    district20.name = Dist20_N,
    ward.name = Ward_N
    )

tanzania_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = region.name)) +
  # geom_sf(data = tanzania_shp, aes(fill = region.name, col = factor(District_C))) +
  geom_sf_text(data = tregs_shp, aes(label = region.name), size = 2)+
  scale_fill_manual(values=tanzania_pal, guide = "none")+
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania map of Regions")

tanzania_map

twards_map <- ggplot() +
  geom_sf(data = twards_shp, aes(fill = region.name)) +
  geom_sf(data = tregs_shp, col = "black", size = 3, fill = NA)+
  scale_fill_manual(values=tanzania_pal)+  
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania map of Regions (colour) and Ward (boundary)", fill = "Regions")

twards_map

```

## Market Survey A (1) : Manual Cleaning

- Map market locations based on manually cleaned string location data from market survey A
- See `r "data-cleaning_scripts/mrkta_cleaning-script.Rmd"` 
- *Survey locations data (regions) consistent with Tanzania shapefile regions for all surveys EXCEPT survey in Ruvuma (yellow), labelled as Rukwa.*

```{r mrktaMap, include = F}

# convert mrkta location data to mapping format & map manually cleaned data:

mrkta_mapdata <- mrkta_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  # no rows are NA for lat and long
  filter(!is.na(lat), !is.na(long))

# check how many rows were lost when removing obs with  missing gps:
# nrow(mrkta_gps); nrow(mrkta_mapdata)

# for now ignore rows which have na in lat or long:
mrkta_sf <- st_as_sf(mrkta_mapdata, coords = c("long","lat"),  crs = 4326)

mrkta_map <- ggplot() +
  geom_sf(data = tregs_shp, aes(fill = region.name), linewidth = 0.1) +
  scale_fill_manual(values=alpha(tanzania_pal,0.7), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = district.region.name), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = region.name), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

# mrkta_map

# Map of market survey locations coloured by region (consistency with Tanzania shapefile)

Regions_Amanual <- mrkta_sf %>% pull(district.region.name) %>% unique()

mrkta_mapByReg <- ggplot() +
  geom_sf(data = tregs_shp, fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = tregs_shp %>% filter(region.name %in% Regions_Amanual), aes(fill = region.name), linewidth = 0.1) +
  scale_fill_manual(values=alpha(market_pal,0.5), guide = "none")+
  geom_sf(data = mrkta_sf, aes(col = district.region.name), size = 1.5)+
  geom_sf_text(data = tregs_shp, aes(label = str_to_title(region.name)), size = 2)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market survey A: survey locations (coloured by stringRegion)", 
       fill = "Tanzania region",
       col = "Market region")+
  theme(legend.position = "right", legend.box = "horizontal")

# mrkta_mapByReg

# mrkta-manual string-location data is consistent with tanzania shapefile for REGION of origin. 

# mrkta-manual Descriptive stats:
# mrkta_gps %>% group_by(district.region.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count()
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(ward.name) %>% count() %>% filter(n>1)
# mrkta_gps %>% group_by(district.region.name, ward.name) %>% count() %>% filter(n>1) # mamba only appears in ward.name unique list
# mrkta_gps %>% filter(ward.name == "mamba")
# mrkta_gps %>% group_by(district.region.name, ward.name, village) %>% count() 
# mrkta_gps %>% group_by(district.region.name, ward.name, village, market.name.corrected) %>% count() 

```

```{r mapPrint}
mrkta_map
mrkta_mapByReg
```


## Market Survey A (2) : Geo-match to Tanzania Shapefile

- Match market survey A gps coordinates to tanzania shape file location data.
- i.e. Market A geo-matched to Tanzania Administrative Levels (Region, District, Ward)

```{r mrktaMap_geomatching, echo = F, warning = F}
################
# Geo-matching #
################

# Match market A locations to Region-District-Ward data from tanzania shapefile:

sf_use_s2(FALSE)
# # Set mrkta data to same crs as tanzania shapefile
# mrkta_sf2 <- st_transform(mrkta_sf, crs = st_crs(twards_shp))

# match mrtka survey locations (mrkta_sf) to tanzania shapefile  (twards_shp) locations using gps geometries
# Join geomatched location data (from tanzania shapefile) to mrtka location data

mrkta_geomatch_gps <- mrkta_gps %>%
  # returns row index of tanzania shapefile with matching geometry
  mutate(twardID = st_nearest_feature(mrkta_sf,twards_shp)) %>% 
  # join matched location data. by rowid (twardID)
  left_join(
    twards_shp %>%
      mutate(twardID = 1:nrow(.)) %>%
      st_drop_geometry() %>% # remove geometry from tanzania shapefile for join
      select(
        twardID,
        "region.name.geomatch" = "region.name",
        "district.name.geomatch" = "district.name",
        "district20.name.geomatch" = "district20.name",
        "ward.name.geomatch" = "ward.name" ,
      ),
    by = c("twardID")) %>%
  select(-twardID)

```

### Market Survey A (2): Data Checking:
- Check consistency between manually cleaned location data, and geomatched data
- Are any rows of market survey A data duplicates (or multiple surveys at the same market?)
- What is the most appropriate level for identifying markets (Region - District - Ward - Village)

```{r mrtka_geomatch_analysis}

# How many market surveys (rows of data) are there?
nrow(mrkta_geomatch_gps)

```

# On a region-by-region basis plot the location of markets from survey A
- Check whether markets are unique
- Add labels to markets for survey and geo-matched location names:

```{r mrktmap}

mrkta_geomatch_mapdata <- mrkta_geomatch_gps %>% 
  mutate(lat = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 1],
         long = str_split(`gps.coordinates.of.the.market`, "\\s", simplify = TRUE)[, 2]) %>% 
  # No rows have NAs for gps data
  filter(!is.na(lat), !is.na(long))

mrkta_geomatch_sf <- st_as_sf(mrkta_geomatch_mapdata, coords = c("long","lat"),  crs = 4326)
```


```{r all}

maps_list <- list()

for(i in 1:length(Regions_Amanual)){
  region_i <- Regions_Amanual[i]
  
  maps_list[[i]] <- ggplot() +
  geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name %in% region_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name %in% region_i), size = 1)+
  
  # # survey data = blue
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name %in% region_i), 
  #              aes(label = ward.name), col = "blue", size = 1.5,
  #              nudge_x = 0.05, nudge_y = -0.025)+
  # 
  # # geomatch data = red
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name %in% region_i), 
  #              aes(label = ward.name.geomatch), col = "red", size = 1.5,
  #              nudge_x = 0.05, nudge_y = +0.025)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name %in% region_i),
               aes(label = ward.name), col = "red", size = 1.5)+
  
  scale_fill_manual(values = tanzania_pal)+
  scale_colour_manual(values = market_pal)+
  coord_sf()+
  labs(title = "Market Survey A: locations of markets with the same ward-name data (manually matched)")+
  facet_wrap(~region.name)+
  theme(legend.position = "right", legend.box = "horizontal")
  
}

maps_list[[1]];maps_list[[2]];maps_list[[3]];maps_list[[4]];maps_list[[5]];maps_list[[6]]
maps_list[[7]];maps_list[[8]];maps_list[[9]];maps_list[[10]];maps_list[[11]];

### Uncertainties: None or uncertainties
# "dodoma" = no uncertainties  
# "simiyu" = none  
# "mwanza" = none
# "katavi" = uncertainties in "usevya" and "kibaoni" wards
# "morogoro" = uncertainties in "minepa" and "milola"
# "mtwara" = uncertainties in ndomoni and lukuledi // mwengemtapika,mtandi&silabu //  mtonya nangwala luchingu // tulindane
# "mbeya" = no uncertainties
# "rukwa" = no uncertainties
# "iringa" = no uncertainties
# "songwe" = no uncertainties
# "njombe" = no uncertainties

```

# Assumption: The survey A gps coords accurately reflect market locations
- gps coords may represent where the survey was completed (travelling away from the market location?
)


# Katavi:
- uncertainties in "usevya" and "kibaoni" wards

```{r }
# "katavi" = uncertainties in "usevya" and "kibaoni" wards
maps_list[[4]]+
  coord_sf(xlim = c(31,31.5), ylim = c(-7.3,-7.05))

# "morogoro" = uncertainties in "minepa" and "milola"
# "mtwara" = uncertainties in ndomoni and lukuledi // mwengemtapika,mtandi&silabu //  mtonya nangwala luchingu // tulindane

ward_i <- c("usevya", "kibaoni", "majimoto")
# usevya and majimoto (2) both within usevya ward.

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "katavi", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_info %>% filter(district.region.name == "katavi", ward.name %in% ward_i) %>% View()

# 1151696 - usevya.05-23
# 1167758 - majimoto/usevya.05-22
# usevya.b NOT reflected in mrkt-C)

mrkta_geomatch_gps <- mrkta_geomatch_gps %>% 
  mutate(village = if_else(ward.name.geomatch == "usevya" & fid == "1167758", "usevya.b", village),
        market.name = if_else(ward.name.geomatch == "usevya" & fid == "1167758", "usevya.b", market.name))
```

# Morogoro: 
- uncertainties in "minepa" and "milola"

```{r }
# "morogoro" = uncertainties in "minepa" and "milola"
maps_list[[5]]+
  coord_sf(xlim = c(36.6,36.8), ylim = c(-8.35,-8.2))
# seemingly distinct 

ward_i <- c("minepa", "milola")

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "morogoro", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "morogoro", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "morogoro", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")


mrkta_info %>% filter(district.region.name == "morogoro", ward.name %in% ward_i) %>% View()

# 1151673 - milola
# 1157529 - minepa
# same respondent, differnet dates, different market names - leave as is. market name as differentiator
#  (both reflected in mrkt-C)

```

# Mtwara:
-  uncertainties in ndomoni and lukuledi // 
- mwengemtapika,mtandi&silabu //  
- mtonya nangwala luchingu // 
- tulindane

```{r mtwara}

maps_list[[6]]+
  coord_sf(xlim = c(38.79, 38.85), ylim = c(-10.75, -10.70))
# ("mwengemtapika", "silabu", "mtandi") each within a different ward

# "mtwara" = uncertainties in ndomoni and lukuledi // mwengemtapika,mtandi&silabu //  mtonya nangwala luchingu tulindane

ward_i <- c("mwengemtapika", "silabu", "mtandi")

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "mtwara", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")


mrkta_info %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
mrkta_geomatch_gps %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()

# 1153837, 1155787, 1157393, 1157394
# different wards and dates, respondents so seemingly correct - use updated ward names (distinct for each)
# represented except mwengemtapika in survey C


ward_i <- c("ndomoni", "lukuledi")

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "mtwara", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_info %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
mrkta_geomatch_gps %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
# 1159822, 1160890
# different wards and dates, respondents so seemingly correct - use updated ward names (ndomoni in lindi district). 
# both represented in survey C


maps_list[[6]]+
  coord_sf(xlim = c(39.2, 39.4), ylim = c(-11, -10.9))

ward_i <- c("mtonya", "nangwala", "luchingu", "tulindane")

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "mtwara", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")

mrkta_info %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
mrkta_geomatch_gps %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
# same day and respondent, v small numbers, different answers
# different wards and dates, respondents so seemingly correct - use updated ward names. 
# all represented in survey C - tulindane, mtonya, nangwala and luchingu.

# keep all, use market name as identifier

# mrkta_geomatch_gps <- mrkta_geomatch_gps


ward_i <- c("mnavira", "makong.onda")

ggplot() +
  # geom_sf(data = tregs_shp %>% filter(region.name %in% region_i), alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = twards_shp %>% filter(region.name == "mtwara", ward.name %in% ward_i), fill = "grey", alpha = 0.5, linewidth = 0.1) +
  geom_sf(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i), size = 1)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name), col = "red", size = 1.5,
  #              nudge_x = 0, nudge_y = +0.01)+
  # geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "katavi", ward.name %in% ward_i),aes(label = ward.name.geomatch), col = "blue", size = 1.5,
  #              nudge_x = 0, nudge_y = -0.01)+
  geom_sf_text(data = mrkta_geomatch_sf %>% filter(district.region.name == "mtwara", ward.name %in% ward_i),aes(label = fid), col = "blue", size = 1.5,
               nudge_x = 0, nudge_y = -0.01)+
  coord_sf()+
  labs(title = "")+
  theme(legend.position = "right", legend.box = "horizontal")


mrkta_info %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()
mrkta_geomatch_gps %>% filter(district.region.name == "mtwara", ward.name %in% ward_i) %>% View()

# different dates and repsondents so use updated location data with market as identifier. 

```


```{r svrybyward}

#####################
# Surveys by Ward #
#####################

# Check consistency between region-ward reported (manual location data) and geomatched region-district-ward.

# Number of market surveys per ward under "Manual" data:
mrkta_geomatch_gps %>% 
  group_by(ward.name) %>% 
  filter(n()>1) %>% 
  print() %>% 
  nrow()

# - For most of the manual location data there is only 1 market survey (A) per ward (region-ward)
# - There are 3 wards which are associated with 2 market surveys (i.e. 6 observations) in the manual location data

# Number of market surveys per ward under "Geomatched" data:
mrkta_geomatch_gps %>% 
  group_by(ward.name.geomatch) %>% 
  filter(n()>1) %>% 
  print() %>% 
  nrow()

# - For most of the geomatched location data there is only 1 market survey (A) per ward (region-ward)
# - There are 5 wards which are associated with 2 market surveys (i.e. 10 observations) in the geomatched location data
```

## CONCLUSION ##
# - For manually cleaned market survey A location data, markets listed as within the same ward are actually distinct markets in different wards. The region-ward name can be updated to the geomatched data.

```{r finaliseLocations}

# Based on above analysis each row of market survey A corresponds to a unique market, and for market level analysis should be identified as such. 
# For region & ward level location data, the geo-matched data is reliable with a unique region-ward location associated with most (all bar 10) markets
# For region & ward level location data, the market.name from manual data is unique to each market, so appending the market name (manual) data to the region-ward (geomatched data) provides a unique identifier for each market in the dataset.

mrkta_final_gps <- mrkta_geomatch_gps %>% 
  rename(region = region.name.geomatch,
         district = district.name.geomatch,
         district20 = district20.name.geomatch,
         ward = ward.name.geomatch,
         village = village,
         market = market.name) %>%
  select(fid,
         date,
         country,
         region,
         district,
         district20,
         ward,
         village,
         market,
         gps.coordinates.of.the.market,
         unique.row.identifier.uuid.)


mrkta_final_gps %>% distinct(region) %>% nrow()
mrkta_final_gps %>% distinct(district) %>% nrow()
mrkta_final_gps %>% distinct(district20) %>% nrow()
mrkta_final_gps %>% distinct(ward) %>% nrow() # ward not unique unless combined with region/district
mrkta_final_gps %>% distinct(village) %>% nrow()
mrkta_final_gps %>% distinct(market) %>% nrow()
mrkta_final_gps %>% distinct(ward,market) %>% nrow()
# SAVE GPS DATA:
# write.csv(mrkta_final_gps, file = here("data/data-cleaning_data/mrkta_gps_tanzania_final.csv"), row.names = F)
```


```{r manualgeomatchsave}

mrkta_gps_manualgeomatch_lkp <- mrkta_geomatch_gps %>%
  # append manual to identify manually cleaned location data:
  mutate(region.manual = district.region.name,
         # district.manual =NA,
         ward.manual = ward.name,
         village.manual = village,
         market.manual = market.name,
         reg.ward.mrkt.manual = paste(region.manual,
                                      ward.manual,
                                      market.manual,
                                      sep = "-")) %>%
  # append final to identify geomatch & finalised location data:
  mutate(region.geomatch.final = region.name.geomatch,
         district.geomatch.final = district.name.geomatch,
         ward.geomatch.final = ward.name.geomatch,
         village.manual.final = village,
         market.manual.final = market.name,
         reg.ward.mrkt.final = paste(region.geomatch.final,
                                      ward.geomatch.final,
                                      market.manual.final,
                                      sep = "-")) %>%
  select(fid,
         date,
         country,
         
         # manual location data:
         ward.manual,
         village.manual,
         market.manual,
        
         # final-geomatched location data:
         region.geomatch.final,
         district.geomatch.final,
         ward.geomatch.final,
         village.manual.final,
         market.manual.final,

         gps.coordinates.of.the.market,
         unique.row.identifier.uuid.)


# Save location data with manual and geomatched names and gps location:
# write.csv(mrkta_gps_manualgeomatch_lkp, file = here("data/data-cleaning_data/mrkta_gps_manualgeomatchlkp.csv"), row.names = F)
```

```{r savemrktaInfo, echo = F}


# link mrkta Info to clean gps data and retain only variables of interest
mrkta_info_final <- mrkta_info %>% 
  select(-c(contains(".code"), contains(".name"), village)) %>%
  left_join(
    mrkta_final_gps %>% select(-c(country)),
    by = c("fid","date", "gps.coordinates.of.the.market", "unique.row.identifier.uuid.")) %>%
  rename(
    "1.origins" = "1.location.brought.from",
    "2.destinations" = "2.location.taken.to.",
    "3a.sheep.sales" = "3a.no.sheep.sold.per.day",
    "3b.goat.sales" = "3b.no.goats.sold.per.day"
  ) %>%
  select(fid,
       date,
       country,
       region, 
       district,
       district20,
       ward,
       village,
       market,
       market.type,
       name.of.respondent,
       `1.origins`,
       `2.destinations`,
       `3a.sheep.sales`,
       `3b.goat.sales`,
       `4.seasonal.variation.in.trade`,
       `4.if.yes.describe`,
       gps.coordinates.of.the.market,
       unique.row.identifier.uuid.)

# write.csv(mrkta_info_final, file = here("data/data-cleaning_data/mrkta_generalinfo_tanzania_final.csv"), row.names = F)

```

## END OF REWRITE
