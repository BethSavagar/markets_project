---
title: "tanzania_mapping"
output: html_document
date: "2024-01-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F, echo = F, warning = F}
library(sf)
library(here)
library(tidyverse)
library(RColorBrewer)
library(lwgeom)
library(ggpubr)
```

```{r theme, include = F, echo = F, warning = F}
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10))
theme_set(custom_theme)

tanzania_pal <- rep(brewer.pal(9,"Pastel1"),times=4)
market_pal <- c(brewer.pal(8, "Dark2"), "#FFA500", "#6A3D9A", "#33A02C")
plotsave <- F
```


# Mapping Tanzania

- Map of tanzania with administrative levels of: Region - District - Ward

Tanzania shapefile sources

Data Sources Overview:

(i) Data Catalog
- Wards shapefile, with region and disitrict info?
- Sourced from National Bureau of Statistics
- <a http://riskprofilesundrr.org/layers/?limit=20&offset=0&regions__name__in=United%20Republic%20of%20Tanzania >

(ii) National Bureau of Statistics
- Region, District and Wards shapefile
- Region and Wards updated 2012
- District updated 2019
- <a https://www.nbs.go.tz/index.php/en/census-surveys/gis>

(iii) Humanitarian data exchange:
- Region, District and Wards shapefile
- Date of upload 2018-19 (added on 13 Feb 2018)
- <a https://data.humdata.org/dataset/cod-ab-tza>


```{r data, include = T, warning = F, echo = F, message = F}

sf_use_s2(FALSE)

# (Load Tanzania Shapefile:
## (i) DataCatalog
twards_datacat_shp <- st_read(here("data/shapefiles/tzwards_datacatalog/tzwards.shp")) # with region boundaries

## (ii) National Bureau of Statistics

twards12_NB_shp <- st_read(here("data/shapefiles/tzwards12_NBS/TZwards.shp")) # with ward boundaries
tdists12_NB_shp <- st_read(here("data/shapefiles/tzregdist12_NBS/Districts.shp")) # with district boundaries
tregs12_NB_shp <- st_read(here("data/shapefiles/tzregdist12_NBS/Regions.shp")) # with region boundaries
tdists19_NB_shp <- st_read(here("data/shapefiles/tzdist19_NBS/Districts and TC as 2020.shp")) # with district boundaries 2019

## (iii) Human Data Exchange
twards_humdata_shp <- st_read(here("data/shapefiles/tzwards_humdata/tza_admbnda_adm3_20181019.shp")) %>%
  rename("Region_Nam"=ADM1_EN,
         "District_N" = ADM2_EN,
         "Ward_Name" = ADM3_EN)
tregs_humdata_shp <- st_read(here("data/shapefiles/tzregs_humdata/tza_admbnda_adm1_20181019.shp")) %>%
  rename("Region_Nam"=ADM1_EN)
```
## Region boundaries:

Check region boundaries from 
 - (i) Data Catalog
 - (ii) Humanitarian data exchange (2018-2019 update)
 - (iii) Tanzania National Bureau of Statistics 2012
 - (iv) Tanzania National Bureau of Statistics 2019-20
    - Check region name attributes for updated district boundaries
    
*Humanitarian data exchange and Tanzania NBS 2020 reflect updated region boundaries including Songwe region creation in 2016*

```{r regions}

# are twards_datacat and twards12_NB the same?
tdists19_NB_shp %>% str() # Region and New District
twards_humdata_shp %>% str() # Region, district, ward, geometry
twards_datacat_shp %>% str() # region, district, ward, geometry


A <- ggplot() +
  geom_sf(data = twards12_NB_shp, aes(fill = Region_Nam)) +
  # geom_sf(data = tanzania_shp, aes(fill = Region_Nam, col = factor(District_C))) +
  # geom_sf_text(data = twards12_NB_shp, aes(label = Region_Nam), size = 2)+
  scale_fill_manual(values=tanzania_pal,guide = "none")+
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania - National Bureau of Statistics")

B <- ggplot() +
  geom_sf(data = twards_datacat_shp, aes(fill = Region_Nam)) +
  # geom_sf(data = tanzania_shp, aes(fill = Region_Nam, col = factor(District_C))) +
  # geom_sf_text(data = twards_datacat_shp, aes(label = Region_Nam), size = 2)+
  scale_fill_manual(values=tanzania_pal,guide = "none")+
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania - Data Catalog")

C <- ggplot() +
  geom_sf(data = tregs_humdata_shp, aes(fill = Region_Nam)) +
  # geom_sf(data = tanzania_shp, aes(fill = Region_Nam, col = factor(District_C))) +
  # geom_sf_text(data = twards_datacat_shp, aes(label = Region_Nam), size = 2)+
  scale_fill_manual(values=tanzania_pal, guide = "none")+
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania - Humanitarian Data Ex")

D <- ggplot() +
  geom_sf(data = tdists19_NB_shp, aes(fill = Region_Nam)) +
  # geom_sf(data = tanzania_shp, aes(fill = Region_Nam, col = factor(District_C))) +
  # geom_sf_text(data = twards_datacat_shp, aes(label = Region_Nam), size = 2)+
  scale_fill_manual(values=tanzania_pal, guide = "none")+
  scale_color_discrete(guide = "none")+
  labs(title = "Tanzania - NBS 2020")

ggarrange(A, B, C, D, nrow = 2, ncol = 2)

# Hum Data Ex and Tanzania NBS data from 2020 reflect the creation of Songwe district in 2016
reg1 <- tdists19_NB_shp %>% distinct(Region_Nam)
reg2 <- tregs_humdata_shp %>% distinct(Region_Nam)
reg1[!reg1$Region_Nam %in% reg2$Region_Nam,]
reg2[!reg2$Region_Nam %in% reg1$Region_Nam,]
```
## District boundaries:

- Only Tanzanian National Bureau of Statistics 2020 contains updated district boundaries
- Also contains updated regions, but not region boundaries

```{r districts}

tdists12_NB_shp %>% str() # District only
tregs12_NB_shp %>% str() # Region only
tdists19_NB_shp %>% str() # Region and New District

# compare tanzania NBS districts in 2012, 2019 with 

Adist <- ggplot() +
  geom_sf(data = tdists12_NB_shp, aes(fill = District_N), alpha = 0.5) +
  scale_fill_discrete(guide = "none")+
  labs(title = "Tanzania - NBS 2012")

Bdist <- ggplot() +
  geom_sf(data = tdists19_NB_shp, aes(fill = NewDist20), alpha = 0.5) +
  scale_fill_discrete(guide = "none")+
  labs(title = "Tanzania - NBS 2019")

Cdist <- ggplot() +
  geom_sf(data = tdists12_NB_shp, aes(fill = District_N), alpha = 0.5, col = "black") +
  geom_sf(data = tdists19_NB_shp, alpha = 0, col = "red") +

  scale_fill_discrete(guide = "none")+
  labs(title = "Tanzania - NBS 2012 (col) and 2019 (lines)")

ggarrange(Adist, Bdist, Cdist, nrow = 2, ncol = 2)

```

## Ward boundaries:

- Humanitarian data exchange has updated correct ward boundaries.

```{r wards}
twards_datacat_shp %>% str()
twards_humdata_shp %>% str()
twards12_NB_shp %>% str()

# Compare Wards in datasets:
# subset rows of shapefiles which don't appear in other ward shapefiles:

twards_datacat_shp[!twards_datacat_shp$geometry %in% twards_humdata_shp$geometry,]
# - 2 rows difference: Pwani-Bagamoyo-Mbwewe

twards_datacat_shp[!twards_datacat_shp$geometry %in% twards12_NB_shp$geometry,] 
# - No difference

twards_humdata_shp[!twards_humdata_shp$geometry %in% twards12_NB_shp$geometry,] 
# 1 row differnce: Pwani-Bagamoyo-Mbwewe

twards12_NB_shp[!twards12_NB_shp$geometry %in% twards_humdata_shp$geometry,] 
# 2 rows difference

# In DataCat and Tanzania Wards data, Mbwewe Ward is listed as 2 separate shapefiles whcih are combined in 1 shapefile in humanitarian data exchange shapefile

ward1 <- ggplot() +
  geom_sf(data = twards_humdata_shp %>% filter(Ward_Name == "Mbwewe"), col = "black") +
  geom_sf(data = twards12_NB_shp %>% filter(Ward_Name == "Mbwewe"), alpha = 0, col = "red") +
  scale_fill_discrete(guide = "none")+
  labs(title = "Tanzania - HumData (blackline) and NBS 2012 (redline)")

```


## Shapefile Finalisation:

```{r joins}

tregs_final <- tregs_humdata_shp %>%
  select("Country_N" = ADM0_EN,
         "Country_C" = ADM0_PCODE,
         "Region_N" = Region_Nam,
         "Region_C" = ADM1_PCODE,
         geometry
         ) %>%
   mutate(
    "Region_N" = tolower(`Region_N`), # all lower case
    "Region_N" = gsub("[[:punct:]]", " ", `Region_N`), # remove punctuation
    "Region_N" = trimws(`Region_N`), #trim leading and trailing spaces
    "Region_N" = gsub("\\s+", ".", `Region_N`), # replace 1+ spaces with "."
   )

tdists_final <- tdists19_NB_shp %>%
  select("Region_N" = Region_Nam,
         "Region_C" = Region_Cod,
         "Dist20_C" = District_C,
         "Dist20_N" = NewDist20, 
         geometry) %>%
   mutate(
    "Region_N" = tolower(`Region_N`), # all lower case
    "Region_N" = gsub("[[:punct:]]", " ", `Region_N`), # remove punctuation
    "Region_N" = trimws(`Region_N`), #trim leading and trailing spaces
    "Region_N" = gsub("\\s+", ".", `Region_N`), # replace 1+ spaces with "."
    
    "Dist20_N" = tolower(`Dist20_N`), # all lower case
    "Dist20_N" = gsub("[[:punct:]]", " ", `Dist20_N`), # remove punctuation
    "Dist20_N" = trimws(`Dist20_N`), #trim leading and trailing spaces
    "Dist20_N" = gsub("\\s+", ".", `Dist20_N`) # replace 1+ spaces with "."
   )

# use twards from humdata and regs/dists from txNBS
twards_distreg20b <- st_join(twards_humdata_shp %>% select(Region_Nam, 
                                                                    District_N,
                                                                    Ward_Name, 
                                                                    geometry),
                                      tdists19_NB_shp %>% select(Region_Nam20 = Region_Nam, 
                                                                 District_N20 = NewDist20, 
                                                                 geometry), 
                            largest = T) %>%
  select(starts_with("Region"),
         starts_with("District"),
         starts_with("Ward"),
         geometry)



twards_final <- twards_distreg20b %>%
  select("Region_N" = Region_Nam,
         "Region20_N" = Region_Nam20,
         "Dist_N" = District_N,
         "Dist20_N" = District_N20, 
         "Ward_N" = Ward_Name,
         geometry) %>%
  mutate(
    "Region_N" = tolower(`Region_N`), # all lower case
    "Region_N" = gsub("[[:punct:]]", " ", `Region_N`), # remove punctuation
    "Region_N" = trimws(`Region_N`), #trim leading and trailing spaces
    "Region_N" = gsub("\\s+", ".", `Region_N`), # replace 1+ spaces with "."
    
    "Region20_N" = tolower(`Region20_N`), # all lower case
    "Region20_N" = gsub("[[:punct:]]", " ", `Region20_N`), # remove punctuation
    "Region20_N" = trimws(`Region20_N`), #trim leading and trailing spaces
    "Region20_N" = gsub("\\s+", ".", `Region20_N`), # replace 1+ spaces with "."
    
    "Dist_N" = tolower(`Dist_N`), # all lower case
    "Dist_N" = gsub("[[:punct:]]", " ", `Dist_N`), # remove punctuation
    "Dist_N" = trimws(`Dist_N`), #trim leading and trailing spaces
    "Dist_N" = gsub("\\s+", ".", `Dist_N`), # replace 1+ spaces with "."
    
    "Dist20_N" = tolower(`Dist20_N`), # all lower case
    "Dist20_N" = gsub("[[:punct:]]", " ", `Dist20_N`), # remove punctuation
    "Dist20_N" = trimws(`Dist20_N`), #trim leading and trailing spaces
    "Dist20_N" = gsub("\\s+", ".", `Dist20_N`), # replace 1+ spaces with "."
    
    "Ward_N" = tolower(`Ward_N`), # all lower case
    "Ward_N" = gsub("[[:punct:]]", " ", `Ward_N`), # remove punctuation
    "Ward_N" = trimws(`Ward_N`), #trim leading and trailing spaces
    "Ward_N" = gsub("\\s+", ".", `Ward_N`)# replace 1+ spaces with "."
  )

```



```{r saveshp}
if(filesave){
  st_write(tregs_final, here("data/shapefiles/tzshp_final/tregs_final.shp"))
  st_write(tdists_final, here("data/shapefiles/tzshp_final/tdists_final.shp"))
  st_write(twards_final, here("data/shapefiles/tzshp_final/twards_final.shp"))
}

```

<!-- ```{r data, include = T, warning = F, echo = F, message = F} -->

<!-- # Load Tanzania Shapefile: -->
<!-- # tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries -->
<!-- tregs_shp <- st_read(here("data/shapefiles/tza_admbnda_adm1_20181019.shp")) # with region boundaries -->
<!-- # tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries -->
<!-- twards_shp <- st_read(here("data/shapefiles/tza_admbnda_adm3_20181019.shp")) # with ward boundaries -->

<!-- # Market A location data: -->
<!-- mrkta_info <- read_csv(file = here("data/tanzania_data/mrkta_generalinfo_tanzania_CLEAN.csv")) -->
<!-- mrkta_gps <- read_csv(file = here("data/tanzania_data/mrkta_gps_tanzania_CLEAN.csv")) -->

<!-- ``` -->
<!-- # Tanzania Map -->
<!-- - Tanzania shapefile with ward boundaries sourced from: https://data.humdata.org/dataset/cod-ab-tza? (ADM L3) -->

<!-- ```{r tanzaniaMap, include = F, echo = F, warning = F} -->
<!-- tregs_shp <- tregs_shp %>% -->
<!--   rename( -->
<!--     "Country_N"=ADM0_EN,     -->
<!--     "Country_NSw" = ADM0_SW, -->
<!--     "Country_C"=ADM0_PCODE, -->
<!--     "Region_Nam" = ADM1_EN, -->
<!--     "Region_Cod" = ADM1_PCODE, -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     "region.name" = tolower(`Region_Nam`), -->
<!--     "region.name" = gsub("[[:punct:]]", " ", `region.name`), # remove punctuation -->
<!--     "region.name" = trimws(`region.name`), #trim leading and trailing spaces -->
<!--     "region.name" = gsub("\\s+", ".", `region.name`)# replace 1+ spaces with "." -->
<!--   )  -->


<!-- twards_shp <- twards_shp %>% -->
<!--   rename( -->
<!--     "Country_N"=ADM0_EN,     -->
<!--     "Country_NSw" = ADM0_SW, -->
<!--     "Country_C"=ADM0_PCODE, -->
<!--     "Region_Nam" = ADM1_EN, -->
<!--     "Region_Cod" = ADM1_PCODE, -->
<!--     "District_N" = ADM2_EN, -->
<!--     "District_C" = ADM2_PCODE, -->
<!--     "Ward_Name"=ADM3_EN, -->
<!--     "Ward_Code"= ADM3_PCODE -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     "region.name" = tolower(`Region_Nam`), -->
<!--     "region.name" = gsub("[[:punct:]]", " ", `region.name`), # remove punctuation -->
<!--     "region.name" = trimws(`region.name`), #trim leading and trailing spaces -->
<!--     "region.name" = gsub("\\s+", ".", `region.name`)# replace 1+ spaces with "." -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     "district.name" = tolower(`District_N`), -->
<!--     "district.name" = gsub("[[:punct:]]", " ", `district.name`), # remove punctuation -->
<!--     "district.name" = trimws(`district.name`), #trim leading and trailing spaces -->
<!--     "district.name" = gsub("\\s+", ".", `district.name`)# replace 1+ spaces with "." -->
<!--   ) %>% -->
<!--   mutate( -->
<!--     "ward.name" = tolower(`Ward_Name`), -->
<!--     "ward.name" = gsub("[[:punct:]]", " ", `ward.name`), # remove punctuation -->
<!--     "ward.name" = trimws(`ward.name`), #trim leading and trailing spaces -->
<!--     "ward.name" = gsub("\\s+", ".", `ward.name`)# replace 1+ spaces with "." -->
<!--   )  -->

<!-- tanzania_map <- ggplot() + -->
<!--   geom_sf(data = tregs_shp, aes(fill = Region_Nam)) + -->
<!--   # geom_sf(data = tanzania_shp, aes(fill = Region_Nam, col = factor(District_C))) + -->
<!--   geom_sf_text(data = tregs_shp, aes(label = Region_Nam), size = 2)+ -->
<!--   scale_fill_manual(values=tanzania_pal, guide = "none")+ -->
<!--   scale_color_discrete(guide = "none")+ -->
<!--   labs(title = "Tanzania map of Regions") -->

<!-- twards_map <- ggplot() + -->
<!--   geom_sf(data = twards_shp, aes(fill = Region_Nam)) + -->
<!--   scale_fill_manual(values=tanzania_pal)+   -->
<!--   scale_color_discrete(guide = "none")+ -->
<!--   labs(title = "Tanzania map of Regions (colour) and Ward (boundary)", fill = "Regions") -->

<!-- # tmaps <- ggarrange(tanzania_map, twards_map, ncol = 1) -->
<!-- # tmaps -->

<!-- if(plotsave){ -->
<!--   ggsave(tanzania_map, file = here("figures/tanzania_map.png"), width = 10, height = 10, units = "cm") -->
<!--   ggsave(twards_map, file = here("figures/tanzania-wards_map.png"), width = 10, height = 10, units = "cm") -->
<!-- } -->
<!-- ``` -->


<!-- ```{r tanzmap, warning = F, echo = F} -->

<!-- tanzania_map -->

<!-- ``` -->


<!-- ```{r wardmap, warning = F, echo = F} -->

<!-- twards_map -->

<!-- ``` -->