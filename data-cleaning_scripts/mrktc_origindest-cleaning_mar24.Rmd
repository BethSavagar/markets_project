---
title: "Tanzania Market Survey C: Data Cleaning"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(readxl)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)
library(rmarkdown)
library(stringdist)
library(fuzzyjoin)
```

# Clean the Market-C Activities Origin and Destination data:

```{r load-data, include = F}

# Market Survey C data
# load cleaned market survey C activity data
mrktc_actvty <- read_csv(here("data/data-cleaning_data/mrktc_mrktactivities_tanzania_final.csv"))


# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
# tregs_shp <- st_read(here("data/shapefiles/tzshp_final/tregs_final.shp")) 

# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tzshp_final/twards_final.shp"))
twards_df <- twards_shp %>% 
  st_drop_geometry()


thfacilities <- st_read(here("data/shapefiles/health_facilities/health_facilities.shp"))
```


# Transform origin-destination data to longform
# Add "orig", "dest" identifier variables:

```{r subsetdata}
# 1 (i) Select only origin and destination data from df:
origdest_df <- mrktc_actvty %>%
  select(fid,
         starts_with("2.sell.place"),
         starts_with("6.buy.place"))

# 1 (ii) Subset Origins, and Destinations and join as "long" dataframe, with fid and "orig-dest" identifier. 
origdest_long <- origdest_df %>%
  
  # Select Origins: 
  select(
    fid,
    place0 = `2.sell.place.name`,
    ward0 = `2.sell.place.ward`,
    district0 = `2.sell.place.district`) %>%
  mutate(origdest = "orig") %>%
  
  # Bind Destinations:
  bind_rows(origdest_df %>%
              select(
                fid,
                 place0 = `6.buy.place.name`,
                 ward0 = `6.buy.place.ward`,
                 district0 = `6.buy.place.district`) %>%
              mutate(origdest = "dest")
  ) %>%
  
  # Remove rows with NO location data:
  
  ##  Replace "na" with NA & remove rows with all NAs
  mutate(place0 = if_else(place0 == "na", NA, place0),
         ward0 = if_else(ward0 == "na", NA, ward0),
         district0 = if_else(district0 == "na", NA, district0)) %>%
  filter(! (is.na(place0) & is.na(ward0) & is.na(district0))) # remove NAs

# 3913 movements in total. 
origdest_long %>% group_by(origdest) %>% count()
```

# Complete origin-destination data with available information:
- i.e. fill in blank place/ward/district data with available information

```{r lkp}

# 2. Complete missing data
# If location data is NA for place/ward/district, complete with available information:

origdest_lkp <- origdest_long %>% # remove NAs
  
  # Update missing place/ward/districts with available info
  mutate(
    place = if_else(is.na(place0), ward0, place0), # replace missing placename with ward
    ward = if_else(is.na(ward0), place0, ward0), # replace missing wardname with place
    district = if_else(is.na(district0), place0, district0) # replace missing district name with place
  )


# when rejoining this dataframe
# - 1. filter to origins and update colnames to sell.place,sell.ward,sell.dist
# - 2. filter to destinations nad update colname to buy.place,buy.ward, buy.dist
# - 3. join to raw data by fid

```

# Clean common location suffixes on raw data and reference data.
# mjini = urban, vijini = rural

```{r matchdist}
# 3. Clean common location suffixes

# mjini = urban, vijini = rural
# suffix for urban: .tc, .mc, .cc
# suffix for rural: "dc"

twards_df %>% distinct(Dist20_N) %>% View()

# - Check in reference data
twards_df %>% 
  # Extracts the part after the last dot:
  mutate(suffix = stringr::str_extract(Dist20_N, "\\.[^.]*$")) %>%
  distinct(suffix) %>% 
  View()

# - Check in origdest data:
origdest_lkp %>%
  mutate(suffix = stringr::str_extract(district, "\\.[^.]*$")) %>%
  distinct(suffix) %>% 
  arrange(suffix) %>% 
  View()

## 3.ii. Replace common suffixes in data:
origdest_lkp <- origdest_lkp %>%
  mutate(dist_suffix = gsub("\\.mji[a-z]*$", ".cc.mc.tc", district), #.mji, .mjini
         dist_suffix = gsub("\\.ji[a-z]*$", ".cc.mc.tc", dist_suffix), # .jini
         dist_suffix = gsub("\\.manispaa$", ".mc", dist_suffix),
         dist_suffix = gsub("\\.munispaa$", ".mc", dist_suffix),
         dist_suffix = gsub("\\.vij[a-z]*$", ".dc", dist_suffix), #.vijijini , .vijini
         dist_suffix = if_else(grepl("dodoma",dist_suffix), "dodoma.cc", dist_suffix),
         dist_suffix = if_else(grepl("makambako",dist_suffix), "makambako.tc", dist_suffix),
         
         # Checks if location ends with .dc, .tc, .cc, or .mc (if yes, keep suffix / if no, append with .dc)
         dist_suffix = if_else(grepl("\\.(dc|tc|cc|mc)$", dist_suffix), dist_suffix, paste0(dist_suffix, ".dc")),
         dist_nosuffix = gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", dist_suffix),
         # 
         # # Place name: 
         # place_suffix = gsub("\\.mji[a-z]*$", ".cc.mc.tc", place), #.mji, .mjini
         # place_suffix = gsub("\\.ji[a-z]*$", ".cc.mc.tc", place_suffix), # .jini
         # place_suffix = gsub("\\.manispaa$", ".mc", place_suffix),
         # place_suffix = gsub("\\.munispaa$", ".mc", place_suffix),
         # place_suffix = gsub("\\.vij[a-z]*$", ".dc", place_suffix), #.vijijini , .vijini
         # place_suffix = if_else(grepl("dodoma",place_suffix), "dodoma.cc", place_suffix),
         # place_suffix = if_else(grepl("makambako",dist_suffix), "makambako.tc", place_suffix),
         # place_suffix = if_else(grepl("\\.(dc|tc|cc|mc)$", place_suffix), # Checks if location ends with .dc, .tc, .cc, or .mc
         #                      dist_suffix,                            # If true, keep the original location
         #                      paste0(dist_suffix, ".dc")              # If false, append ".dc"
         #                      ),
         # place_nosuffix = gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", place_suffix)
  )

## 2.iii. Replace common suffixes in reference list:

twards_match <- twards_df %>%
  distinct(Ward_N, Dist20_N, Region20_N) %>% 
  mutate(Dist20_nosuffix =  gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", Dist20_N))

```

## Clean District Names:

```{r distclean1}

# # Dataframe of district-regions in reference data:

tdists_match <- twards_match %>%
  distinct(Dist20_N, Dist20_nosuffix, Region20_N)
  
dist_lkp <- origdest_lkp %>% 
  distinct(dist_suffix, dist_nosuffix) %>%
  stringdist_join(., tdists_match, 
                  by=c(dist_suffix = "Dist20_N", 
                       dist_nosuffix = "Dist20_nosuffix"),
                mode='left', # use left join
                method = "jw", # use jw distance metric
                max_dist=99, 
                distance_col='dist') %>%
  group_by(dist_suffix) %>%
  slice_min(order_by=dist_suffix.dist, n=1) %>%
  ungroup()
  
dist_lkp <- dist_lkp %>%
  mutate(acceptD0 = if_else(dist_suffix.dist == 0, "accept_D0", 
                            if_else(dist_nosuffix.dist == 0, "accept_D1", NA)))
# Save and complete manual check:
# write.csv(dist_lkp, file = here("data/data-cleaning_data/origdest_distlkp.csv"), row.names = F)

# Load post-manual check:
dist_lkp <- read_excel(here("data/data-cleaning_data/origdest_distlkp.xlsx"))
# accept_D0: dist_suffix matched
# accept_D1: dist_nosuffix matched
# accept_D2: manual check, also "kenya", "manyoni", "tanganyika"


dist_lkp <- dist_lkp %>%
  mutate(district.clean = 
           if_else(
             acceptD0 %in% c("accept_D0", "accept_D1", "accept_D2"),
             Dist20_N,
             if_else(
               acceptD0 %in% c("kenya", "manyoni.dc", "tanganyika"),
               acceptD0,
               dist_nosuffix
             )
           ),
         region.clean = if_else(acceptD0 %in% c("accept_D0", "accept_D1", "accept_D2", "manyoni.dc"),
                                Region20_N,
                                district.clean)
         ) %>%
  distinct(dist_suffix, dist_nosuffix, district.clean, region.clean, acceptD0)

# NOTE #
# Lake Tanganyika is bordered by Rukwa (Nkasi, Kalambo), Katavi (Mpanda?) and Kigoma (kigoma, uvinza) regions
# Tanganyika ward is within muheza.DC in Tanga region

origdest_lkp <- origdest_lkp %>%
  left_join(dist_lkp, by = c("dist_suffix", "dist_nosuffix"))
  # for those districts which are now cleaned, add the confirmed region:
  # can probably remove dist_suffix and dist_nosuffix

```

# Define distinct origin/destination locations from long df

```{r origdestmatch}

# 4. Unique origin-destinations
# List unique entries of place,ward,district and region for matching and cleaning:
# When joining back to original dataframe use:  place, ward, district.clean, region.clean. 

origdest_lkpunique <- origdest_lkp %>%
  distinct(place, ward, district.clean, region.clean) %>%
  # place-ward-district identifiers: 
  mutate(pwd.A = paste(place, ward, district.clean, sep = "-"), # place-ward-district
         wd.A = paste(ward, district.clean, sep = "-"), # ward-district
         wdr.A = paste(ward,district.clean,region.clean, sep = "-") # ward-district-region
         ) %>% 
  rename("ward.A" = ward, "dist.A" = district.clean, "reg.A" = region.clean)

# update tanzania wards dataframe for matching
twards_match <- twards_match %>%
  mutate(
    wd.B = paste(Ward_N, Dist20_N, sep = "-"),
    wdr.B = paste(Ward_N, Dist20_N, Region20_N, sep = "-")) %>%
  select(
    ward.B = Ward_N,
    dist.B = Dist20_N,
    reg.B = Region20_N,
    wd.B, # ward-district
    wdr.B # ward-district-region
  )

```

# Find exact ward-district-region matches.

```{r dcleanmatch}

# 5. Exact ward-district-region matching:

origdest_match <- origdest_lkpunique %>%
  # join on W-D-R
   stringdist_join(.,twards_match, 
                   by=c("ward.A" = "ward.B",
                        "dist.A" = "dist.B",
                        "reg.A" = "reg.B"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=99, 
                distance_col='dist')  %>%
  rowwise() %>%
  # total distance for W-D-R
  mutate(dist_sum = sum(ward.A.dist, dist.A.dist, reg.A.dist)) %>%
  ungroup() %>%
  group_by(pwd.A) %>%
  # keep only the closest match:
  slice_min(order_by=dist_sum, n=1) %>%
  ungroup()

# Identify exact matches in dataframe:
WDR_matched <- origdest_match %>%
  mutate(acceptWDR = if_else(dist_sum == 0, "acceptWDR0", NA))

# Matches are unique with no duplicates:
WDR_matched %>% 
  filter(acceptWDR == "acceptWDR0") %>% 
  group_by(place,ward.A,dist.A,reg.A, ward.B,dist.B,reg.B) %>% 
  mutate(dupe = n()>1) %>% 
  View()
```


## Non-Exact Matches # 
(1) Check locations where ward and region match exactly but the district is incorrect

```{r matchdist}

# 6.1: District Error:

# Identify entries where the ward and region match but the district does not.
# Manually check and accept:
dist_unmatch <- WDR_matched %>%
  # match on Ward and Region, not District
  filter(ward.A.dist == 0, 
         dist.A.dist > 0,
         reg.A.dist == 0) %>%
  # check matches manually:
  select(dist.A, dist.B, dist.A.dist, wdr.A, wdr.B) %>%
  distinct()

# District errors are either:
  # bordering districts/mistakes 
  # the incorrect suffix: t e.g. bariadi.dc = bariadi.tc)

WDR_matched <- WDR_matched %>% 
  # if only district is incorrect then accept correction (based on manual checking above)
  mutate(acceptWDR = if_else((ward.A.dist == 0 & dist.A.dist > 0 & reg.A.dist == 0),
                             "acceptWDR1", 
                             acceptWDR))
# accept WDR1: ward-region matched, district manually checked.

# check for duplicates:
# wdr_match %>% filter(!is.na(acceptWDR)) %>% group_by(place,ward.A,dist.A,reg.A, ward.B,dist.B,reg.B,acceptWDR) %>% mutate(dupe = n()>1) %>% View()
```


(1) Check locations where district and region match exactly but the ward is incorrect

```{r matchwd}

# 6.2: Ward Error:

# Identify entries where the district and region match but the ward does not.
# Manually check in excel:
ward_unmatch <- WDR_matched %>%
  # filter results which matched district and region but don't match by ward:
  filter(ward.A.dist>0, 
         dist.A.dist == 0,
         reg.A.dist == 0) %>%
  select(place, ward.A, ward.B, ward.A.dist, wdr.A, wdr.B) %>%
  distinct()

# save and manually check in excel:
# write.csv(ward_unmatch, file = here("data/data-cleaning_data/unmatchwd_lkp.csv"), row.names = F)

# load excel checked lookup:
ward_unmatchlkp <- read_excel(here("data/data-cleaning_data/unmatchwd_lkpxl.xlsx")) %>%
  mutate(acceptWDR2 = if_else(AcceptW1 == 1, "acceptWDR2", NA)) # recode accept column
# accept WDR2: district-region match, ward manually checked.


## Update WDR_matched dataframe:
WDR_matched <- WDR_matched %>% 
  # join ward_unmatch to update acceptance variable.
  left_join(ward_unmatchlkp %>% 
              filter(acceptWDR2 == "acceptWDR2") %>%
              distinct(place, ward.A, wdr.A, wdr.B, acceptWDR2)) %>%
  mutate(acceptWDR = if_else(is.na(acceptWDR),acceptWDR2,acceptWDR)) %>%
  select(-acceptWDR2)


# Total matches from exact matching of (i) all, (ii) ward-region, (iii) dist-region
WDR_matched %>% group_by(acceptWDR) %>% count()

# Store matched ward-district-region data for joining to origdest_lkp:
wdr_join <- WDR_matched %>%
  # exclude unmatched data:
  filter(!is.na(acceptWDR)) %>%
  # select columns for joining:
  select(place,ward.A,dist.A,reg.A,ward.B,dist.B,reg.B, acceptWDR)

# Save the matched W-D-R data:
# write.csv(wdr_match, file = "data/data-cleaning_data/origdest_wdr_match.csv")

# Check that matched data are unique (no duplicates)
# wdr_join %>%
#   group_by(place,ward.A,dist.A,reg.A,ward.B,dist.B,reg.B) %>%
#   mutate(dupe = n()>1) %>%
#   View()

# origdest_lkpunique <-
  # origdest_lkpunique %>%
  # left_join(
  #   wdr_join,
  #   by = c("place", "ward.A", "dist.A", "reg.A")
  # ) %>%
  # group_by(acceptWDR) %>%
  # count()

# when joined to origdest_lkpunique dataframe (all movements):
# 935 match ward & district, 59 match reg-dist and stringward. 178 match reg-ward and stringdist.
# 653 remain unmatched

```

# Incomplete Matches #
- String match on ward and region only, no matching on district:

```{r unmatchedWardRegion}

# Identify unmatched locations from WDR_matched dataframe:
unmatched <- WDR_matched %>%
  filter(is.na(acceptWDR)) %>% 
  distinct(place, ward.A, dist.A, reg.A, wdr.A)

# unmatched <-
  # origdest_lkpunique %>%
  # left_join(
  #   wdr_join,
  #   by = c("place", "ward.A", "dist.A", "reg.A")
  # ) %>%
  # filter(is.na(acceptWDR)) %>%
  # distinct(place, ward.A, dist.A, reg.A, wdr.A)


# Match data on Ward and Region only, ignoring District:

unmatched_match <- unmatched %>%
   stringdist_join(.,twards_match, 
                   by=c("ward.A" = "ward.B",
                        # "dist.A" = "dist.B",
                        "reg.A" = "reg.B"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=99, 
                distance_col='dist')  %>%
  rowwise() %>%
  # sum stringdist for Ward and Region
  mutate(dist_sum = sum(ward.A.dist, reg.A.dist)) %>%
  ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  # keep closest match:
  slice_min(order_by=dist_sum, n=1) %>%
  ungroup()

# Dataframe for manual checking: 
unmatched_lkp <- unmatched_match %>% 
  # select variables to check consistency between districts and stringdist between wards, regions.
  select(place, wdr.A, wdr.B, dist.A, dist.B, ends_with(".dist"), dist_sum) %>% 
  distinct()

# Save csv for manual check 
# Perfect match on Ward & Region (acceptWR0) - manually check district.
# Perfect match on Ward (acceptW0) - manually check district/region.
# write.csv(unmatched_lkp, file = "data/data-cleaning_data/unmatched2_lkp.csv")
unmatched_lkp <- read_excel(here("data/data-cleaning_data/unmatched2_lkp.xlsx"))

# Identify manually checked matches on ward and region
unmatched_lkp <- unmatched_lkp %>%
  # keep only matches:
  filter(acceptWR0 %in% c("acceptWR0", "acceptW0")) %>%
  # update with place-ward-district-region data:
  left_join(unmatched_match %>% select(place,wdr.A,ward.B,dist.B,reg.B, wdr.B),
                            by = c("place", "wdr.A", "wdr.B", "dist.B"))

# unmatched_lkp %>% group_by(place,wdr.A, wdr.B, dist.A, dist.B) %>% mutate(dupe = n()>1) %>% View()

# Create dataframe for joining to origdest_lkpunique"
unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C, acceptWR0) 

# Check for duplicates:
# unmatched_join %>%
#   group_by(place,ward.A,dist.A,reg.A,ward.C, dist.C, reg.C) %>%
#   mutate(dupe = n()>1) %>% View()

# Join to origdest_lkpunique
# origdest_lkpunique <-
# origdest_lkpunique %>%
#   left_join(
#     wdr_join,
#     by = c("place", "ward.A", "dist.A", "reg.A")
#   ) %>% left_join(
#     unmatched_join,
#     by = c("place", "ward.A", "dist.A", "reg.A")
#   )


```

# Update remaining unmatched data:

```{r unmatched2}

unmatched2 <- unmatched_join %>% 
  # filter to remaining unmatched:
  filter(is.na(acceptWR0)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

```


## HEALTH FACILITIES DATA #
# Match to health facilities data:
# Find exact matches between origdest data and health facilities data on:
# (i) Ward.A = Facility_N (HF), District, Region 
# (ii) Ward.A = Village_St (HF), District, Region
# Check matches are found in tanzania reference data

```{r HF1}

# clean health facilities dataframe: 
hfacilities_df <- thfacilities %>%
  st_drop_geometry() %>%
  select(Facility_N,
         Village_St,
         ward.HF = Ward,
         dist.HF = Council, 
         reg.HF = Region) %>% 
  mutate(
    place.HF = tolower(Facility_N),
    place.HF = gsub("[[:punct:]]", " ",place.HF),
    place.HF = trimws(place.HF),
    place.HF = gsub("\\s+", ".",place.HF),
    
    village.HF = tolower(Village_St),
    village.HF = gsub("[[:punct:]]", " ",village.HF),
    village.HF = trimws(village.HF),
    village.HF = gsub("\\s+", ".",village.HF),
    
    ward.HF = tolower(ward.HF),
    ward.HF = gsub("[[:punct:]]", " ",ward.HF),
    ward.HF = trimws(ward.HF),
    ward.HF = gsub("\\s+", ".",ward.HF),
    
    dist.HF = tolower(dist.HF),
    dist.HF = gsub("[[:punct:]]", " ",dist.HF),
    dist.HF = trimws(dist.HF),
    dist.HF = gsub("\\s+", ".",dist.HF),
    
    reg.HF = tolower(reg.HF),
    reg.HF = gsub("[[:punct:]]", " ",reg.HF),
    reg.HF = trimws(reg.HF),
    reg.HF = gsub("\\s+", ".",reg.HF))


# Match origin-destination data to health facilities data:
# place = ward, district, region
unmatched2_match <- unmatched2 %>%
   stringdist_join(.,hfacilities_df, 
                   by=c("ward.A" = "place.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0, # keep only exact matches
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=ward.A.dist, n=1) %>%
  ungroup()

# Check health facilities matches exist in tanzania data
unmatched2_lkp <- unmatched2_match %>% 
  # join tanzania data by WDR match to health facilities data
  left_join(twards_match,
            by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  # select variables for checking matching HF to T-data and HF to orig-dest data:
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, ward.A.dist, dist.A.dist, reg.A.dist) %>% 
  # keep only exact matches between HF and orig-dest data
  filter(ward.A.dist ==0, dist.A.dist==0, reg.A.dist ==0) %>% 
  # REMOVE rows which have no match in the tanzania data:
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF0") # accept by matching to health facilities placenames


# Create dataframe for joining to origdest_lkpunique"
unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
    distinct(place, ward.A, dist.A, reg.A, wdr.A,
             ward.C, dist.C, reg.C, 
             ward.HF, dist.HF, reg.HF, acceptWR0, acceptHF) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0))

# write.csv(unmatched2_match, file = here("data/data-cleaning_data/unmatched2c_lkp.csv"))

```

# Find exact matches between origdest data and health facilities data on:
# (ii) Ward.A = Village_St (HF), District, Region

```{r unmatched3}

# review unmatched data:
unmatched3 <- unmatched_join %>% 
  filter(is.na(acceptAll)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

# Match between orig-dest data and HF data on village = ward match:
unmatched3_match <- unmatched3 %>%
   stringdist_join(.,hfacilities_df, 
                   by=c("ward.A" = "village.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0, 
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=ward.A.dist, n=1) %>%
  ungroup()


# Check matches exist in tanzania reference data, keep only exact matches:

unmatched3_lkp <- unmatched3_match %>% 
  # Join tanzania data:
  left_join(twards_match,
            by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  # select vars to check between HF- tanzania data - origdest data
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, ward.A.dist, dist.A.dist, reg.A.dist) %>% 
  # keep exact matches only:
  filter(ward.A.dist ==0, dist.A.dist==0, reg.A.dist ==0) %>% 
  # exclude if not found in tanzania data:
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF1") # accept by matching to health facilities villagenames


unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
    distinct(place, ward.A, dist.A, reg.A, wdr.A,
             ward.C, dist.C, reg.C, 
             ward.HF, dist.HF, reg.HF, 
             ward.HF1, dist.HF1, reg.HF1,
             acceptWR0, acceptHF, acceptHF1) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll))


# write.csv(unmatched2_match, file = here("data/data-cleaning_data/unmatched2c_lkp.csv"))

```

# Find FUZZY matches between origdest data and health facilities data on:
# (ii) Ward.A = Facility_N (HF), District, Region

```{r unmatched4}

# Review unmatched data:
unmatched4 <- unmatched_join %>% 
  filter(is.na(acceptAll)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

unmatched4_match <- unmatched4 %>%
   stringdist_join(.,hfacilities_df, 
                   by=c("ward.A" = "place.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0.5, # allow fuzzy matches
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=ward.A.dist, n=1) %>%
  ungroup()

unmatched4_lkp <- unmatched4_match %>% 
  # exact district, region match, check fuzzy matching ward to facility_N
  filter(dist.A.dist == 0, reg.A.dist ==0 ) %>%
  # join twards reference data
  left_join(twards_match,
              by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  # manually review place, wdr.A against placeHF
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, ward.A.dist, dist.A.dist, reg.A.dist) %>%
  # exclude if no match in twards data
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF2") 

unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
  
  # Join HF matched data (2):
  left_join(unmatched4_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF2 = wdr.HF, ward.HF2 = ward.HF, dist.HF2 = dist.HF, reg.HF2 = reg.HF, acceptHF2 = acceptHF)) %>%
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C,
           ward.HF, dist.HF, reg.HF, 
           ward.HF1, dist.HF1, reg.HF1,
           ward.HF2, dist.HF2, reg.HF2,
             acceptWR0, acceptHF, acceptHF1, acceptHF2) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF2, acceptAll))


```

# Find FUZZY matches between origdest data and health facilities data on:
# (i) Ward.A = Village_St (HF), District, Region

```{r}

# update unmatched data:
unmatched5 <- unmatched_join %>% 
  filter(is.na(acceptAll)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

unmatched5_match <- unmatched5 %>%
  # ward.A to village.HF fuzzy
   stringdist_join(.,hfacilities_df, 
                   by=c("ward.A" = "village.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0.5, 
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=ward.A.dist, n=1) %>%
  ungroup()

unmatched5_lkp <- unmatched5_match %>% 
  # only exact matching district and regions:
  filter(dist.A.dist == 0, reg.A.dist ==0 ) %>%
  # match to twards data
  left_join(twards_match,
            by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  # manually check matches:
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, ward.A.dist, dist.A.dist, reg.A.dist) %>%
  # only keep if found in twards reference
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF3") %>%
  distinct()

unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
  
  # Join HF matched data (2):
  left_join(unmatched4_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF2 = wdr.HF, ward.HF2 = ward.HF, dist.HF2 = dist.HF, reg.HF2 = reg.HF, acceptHF2 = acceptHF)) %>%
  
  # Join HF matched data (3):
  left_join(unmatched5_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF3 = wdr.HF, ward.HF3 = ward.HF, dist.HF3 = dist.HF, reg.HF3 = reg.HF, acceptHF3 = acceptHF)) %>%
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C,
           ward.HF, dist.HF, reg.HF, 
           ward.HF1, dist.HF1, reg.HF1,
           ward.HF2, dist.HF2, reg.HF2,
           ward.HF3, dist.HF3, reg.HF3,
           acceptWR0, acceptHF, acceptHF1, acceptHF2, acceptHF3) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF2, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF3, acceptAll))

```

# Find FUZZY matches between origdest data and health facilities data on:
# (iii) Place.A = Facility_N (HF), District, Region

```{r}
# update unmatched : 
unmatched6 <- unmatched_join %>% 
  filter(is.na(acceptAll)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

# fuzzy match place name origdest data with Facility_N in health data:
unmatched6_match <- unmatched6 %>%
   stringdist_join(.,hfacilities_df, 
                   by=c("place" = "place.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0.5, 
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=place.dist, n=1) %>%
  ungroup()

unmatched6_lkp <- unmatched6_match %>% 
  # keep only if district and region match exactly
  filter(dist.A.dist == 0, reg.A.dist ==0 ) %>%
  # join reference tanzania data for checking
  left_join(twards_match,
              by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, place.dist, dist.A.dist, reg.A.dist) %>%
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF4") 

unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
  
  # Join HF matched data (2):
  left_join(unmatched4_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF2 = wdr.HF, ward.HF2 = ward.HF, dist.HF2 = dist.HF, reg.HF2 = reg.HF, acceptHF2 = acceptHF)) %>%
  
  # Join HF matched data (3):
  left_join(unmatched5_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF3 = wdr.HF, ward.HF3 = ward.HF, dist.HF3 = dist.HF, reg.HF3 = reg.HF, acceptHF3 = acceptHF)) %>%
  
  # Join HF matched data (4): 
  left_join(unmatched6_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF4 = wdr.HF, ward.HF4 = ward.HF, dist.HF4 = dist.HF, reg.HF4 = reg.HF, acceptHF4 = acceptHF)) %>%
  
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C,
           ward.HF, dist.HF, reg.HF, 
           ward.HF1, dist.HF1, reg.HF1,
           ward.HF2, dist.HF2, reg.HF2,
           ward.HF3, dist.HF3, reg.HF3,
           ward.HF4, dist.HF4, reg.HF4,
           acceptWR0, acceptHF, acceptHF1, acceptHF2, acceptHF3, acceptHF4) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF2, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF3, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF4, acceptAll))
```


# Find FUZZY matches between origdest data and health facilities data on:
# (iii) Place.A = Village_St (HF), District, Region

```{r}
# 
# 
unmatched7 <- unmatched_join %>%
  filter(is.na(acceptAll)) %>%
  distinct(place,ward.A,dist.A, reg.A)
# 
unmatched7_match <- unmatched7 %>%
   stringdist_join(.,hfacilities_df,
                   by=c("place" = "village.HF",
                        "dist.A" = "dist.HF",
                        "reg.A" = "reg.HF"
                        ),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0.5,
                distance_col='dist')  %>%
  # rowwise() %>%
  # mutate(dist_sum = sum(place.dist)) %>%
  # ungroup() %>%
  group_by(place,ward.A,dist.A) %>%
  slice_min(order_by=place.dist, n=1) %>%
  ungroup()


unmatched7_lkp <- unmatched7_match %>% 
  # keep only if district and region match exactly
  filter(dist.A.dist == 0, reg.A.dist ==0 ) %>%
  # join reference tanzania data for checking
  left_join(twards_match, by = c("ward.HF" = "ward.B", "dist.HF" = "dist.B", "reg.HF" = "reg.B")) %>%
  mutate(wdr.A = paste(ward.A, dist.A, reg.A, sep = "-"),
         wdr.HF = paste(ward.HF, dist.HF, reg.HF, sep = "-")) %>%
  select(place, wdr.A, place.HF, village.HF, wdr.HF, wdr.B, ward.HF, dist.HF, reg.HF, place.dist, dist.A.dist, reg.A.dist) %>%
  filter(!is.na(wdr.B)) %>% 
  mutate(acceptHF = "acceptHF5") 


unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
  
  # Join HF matched data (2):
  left_join(unmatched4_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF2 = wdr.HF, ward.HF2 = ward.HF, dist.HF2 = dist.HF, reg.HF2 = reg.HF, acceptHF2 = acceptHF)) %>%
  
  # Join HF matched data (3):
  left_join(unmatched5_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF3 = wdr.HF, ward.HF3 = ward.HF, dist.HF3 = dist.HF, reg.HF3 = reg.HF, acceptHF3 = acceptHF)) %>%
  
  # Join HF matched data (4): 
  left_join(unmatched6_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF4 = wdr.HF, ward.HF4 = ward.HF, dist.HF4 = dist.HF, reg.HF4 = reg.HF, acceptHF4 = acceptHF)) %>%
  
   # Join HF matched data (5): 
  left_join(unmatched7_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF5 = wdr.HF, ward.HF5 = ward.HF, dist.HF5 = dist.HF, reg.HF5 = reg.HF, acceptHF5 = acceptHF)) %>%
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C,
           ward.HF, dist.HF, reg.HF, 
           ward.HF1, dist.HF1, reg.HF1,
           ward.HF2, dist.HF2, reg.HF2,
           ward.HF3, dist.HF3, reg.HF3,
           ward.HF4, dist.HF4, reg.HF4,
           ward.HF5, dist.HF5, reg.HF5,
           acceptWR0, acceptHF, acceptHF1, acceptHF2, acceptHF3, acceptHF4, acceptHF5) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF2, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF3, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF4, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF5, acceptAll))

```

```{r}

unmatched_final <- unmatched_join %>% 
  filter(is.na(acceptAll)) %>% 
  distinct(place,ward.A,dist.A, reg.A)

# write_csv(unmatched_final, file = here("data/data-cleaning_data/unmatchedfinal_lkp.csv"))

```

```{r unmatchedmanual}

unmatchedfinal_lkp <- read_excel(here("data/data-cleaning_data/unmatchedfinal_lkp.xlsx")) %>%
  rename("acceptManual" = code)


unmatched_join <- unmatched %>%
  select(place, 
         ward.A,
         dist.A,
         reg.A,
         wdr.A) %>%
  left_join(unmatched_lkp %>% 
              # keep only matched data:
              filter(!is.na(acceptWR0)) %>%
              # update names suffix ".C" to distinguish:
              select(place, 
                     wdr.A, 
                     "wdr.C" = wdr.B, 
                     "ward.C" = ward.B, 
                     "dist.C" = dist.B, 
                     "reg.C" = reg.B, 
                     acceptWR0),
            by = c("place", "wdr.A")) %>%
  
  # Join HF matched data:
  left_join(unmatched2_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              # update names suffix ".HF" to distinguish:
              select(place, wdr.A, wdr.HF, ward.HF, dist.HF, reg.HF, acceptHF)) %>%
  
    # Join HF matched data (1): 
  left_join(unmatched3_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF1 = wdr.HF, ward.HF1 = ward.HF, dist.HF1 = dist.HF, reg.HF1 = reg.HF, acceptHF1 = acceptHF)) %>%
  
  # Join HF matched data (2):
  left_join(unmatched4_lkp %>%
              # keep only matched data:
              filter(!is.na(acceptHF)) %>%
              select(place, wdr.A, wdr.HF2 = wdr.HF, ward.HF2 = ward.HF, dist.HF2 = dist.HF, reg.HF2 = reg.HF, acceptHF2 = acceptHF)) %>%
  
  # Join HF matched data (3):
  left_join(unmatched5_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF3 = wdr.HF, ward.HF3 = ward.HF, dist.HF3 = dist.HF, reg.HF3 = reg.HF, acceptHF3 = acceptHF)) %>%
  
  # Join HF matched data (4): 
  left_join(unmatched6_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF4 = wdr.HF, ward.HF4 = ward.HF, dist.HF4 = dist.HF, reg.HF4 = reg.HF, acceptHF4 = acceptHF)) %>%
  
   # Join HF matched data (5): 
  left_join(unmatched7_lkp %>%
                  filter(!is.na(acceptHF)) %>%
                  select(place, wdr.A, wdr.HF5 = wdr.HF, ward.HF5 = ward.HF, dist.HF5 = dist.HF, reg.HF5 = reg.HF, acceptHF5 = acceptHF)) %>%
  
  # Manual match:
  left_join(unmatchedfinal_lkp %>%
              filter(acceptManual == "manual")) %>%
  
  distinct(place, ward.A, dist.A, reg.A, wdr.A,
           ward.C, dist.C, reg.C,
           ward.HF, dist.HF, reg.HF, 
           ward.HF1, dist.HF1, reg.HF1,
           ward.HF2, dist.HF2, reg.HF2,
           ward.HF3, dist.HF3, reg.HF3,
           ward.HF4, dist.HF4, reg.HF4,
           ward.HF5, dist.HF5, reg.HF5,
           ward.manual, dist.manual, reg.manual,
           acceptWR0, acceptHF, acceptHF1, acceptHF2, acceptHF3, acceptHF4, acceptHF5, acceptManual) %>% 
  mutate(acceptAll = if_else(is.na(acceptWR0), acceptHF, acceptWR0),
         acceptAll = if_else(is.na(acceptAll), acceptHF1, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF2, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF3, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF4, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptHF5, acceptAll),
         acceptAll = if_else(is.na(acceptAll), acceptManual, acceptAll))

```

*********
*********

# Clean Corrected location data:

```{r}
# 

origdest_join <- origdest_lkpunique %>%
  # join matched data to original orig-dest unique list:
  left_join(
    wdr_join, by = c("place", "ward.A", "dist.A", "reg.A")
  ) %>% 
  left_join(
    unmatched_join %>% select(-c(wdr.A, acceptWR0, acceptHF, acceptHF1, acceptHF2, acceptHF3, acceptHF4,  acceptHF5, acceptManual)),
    by = c("place", "ward.A", "dist.A", "reg.A")
  ) %>%
  # update acceptAll.final to reflect acceptance code
  # ".Bclean" to reflect matched location data
  mutate(acceptAll.final = if_else(is.na(acceptWDR), acceptAll, acceptWDR),
         "ward.Bclean" = coalesce(ward.B, ward.C, ward.HF, ward.HF1, ward.HF2, ward.HF3, ward.HF4, ward.HF5, ward.manual),
         "dist.Bclean" = coalesce(dist.B, dist.C, dist.HF, dist.HF1, dist.HF2, dist.HF3, dist.HF4, dist.HF5, dist.manual),
         "region.Bclean" = coalesce(reg.B, reg.C, reg.HF, reg.HF1, reg.HF2, reg.HF3, reg.HF4, reg.HF5, reg.manual)
         ) # %>%
  # group_by(acceptAll.final) %>% count() %>%
  # filter(is.na(acceptAll.final))


# Link matched data (origdest_join) to fids for joining to actvty dataframe:
fidorigdest <- origdest_lkp %>%
  left_join(
    origdest_join %>% select(place,ward.A,dist.A,reg.A, ward.Bclean, dist.Bclean, region.Bclean, acceptAll.final),
    by = c("place", "ward" = "ward.A", "district.clean" = "dist.A", "region.clean" = "reg.A")
  ) %>% 
  select(
    fid, 
    origdest,
    ward.Bclean,
    dist.Bclean,
    region.Bclean,
    acceptAll.final
  )

```


# Joining the cleaned data to the original origdest dataframe: 

```{r lastjoin}

# origdest data with cleaned locations"
fidorigdest_complete <- fidorigdest %>% 
  filter(!is.na(acceptAll.final))

# unmatched origdest fids:
fidorigdest_NA <- fidorigdest %>% 
  select(fid,origdest,acceptAll.final) %>% 
  filter(is.na(acceptAll.final))

mrktc_origdest_df <- mrktc_actvty %>%
  select(
    fid,
    `2.sell.place.name`,
    `2.sell.place.ward`,
    `2.sell.place.district`,
    `6.buy.place.name`,
    `6.buy.place.ward`,
    `6.buy.place.district`
    ) %>%
  
  # Join MATCHED ORIGIN DATA:
  left_join(
    fidorigdest_complete %>% filter(origdest == "orig") %>% select(-c(origdest)),
    by = "fid"
  ) %>%
  # update final names:
  rename(
    `2.sell.place.ward.final` = ward.Bclean,
    `2.sell.place.district.final` = dist.Bclean,
    `2.sell.place.region.final` = region.Bclean,
  ) %>%
  
  # Join MATCHED DESTINATION DATA:
  left_join(
    fidorigdest_complete %>% filter(origdest == "dest") %>% select(-c(origdest)),
    by = "fid"
  ) %>%
  # update final names:
  rename(
    `6.buy.place.ward.final` = ward.Bclean,
    `6.buy.place.district.final` = dist.Bclean,
    `6.buy.place.region.final` = region.Bclean,
  )

if(filesave){
  write.csv(mrktc_origdest_df, file = here("data/tanzania_data/mrktc_origdest_tanzania_final.csv"))
  # with manual data:
  write.csv(mrktc_origdest_df, file = here("data/tanzania_data/mrktc_origdest_tanzania_finalv2.csv"))
}

```

