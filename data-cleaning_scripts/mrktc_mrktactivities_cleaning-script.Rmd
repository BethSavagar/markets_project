---
title: "Tanzania Market Survey C: Data Cleaning"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)
library(readxl)

```

Use cleaned market survey C gps data to produce "Market Activities" datasets

```{r dataload}

filesave <- F

mrktc_gps <- read_csv(here("data/tanzania_data/mrktc_allgps_tanzania_final.csv"))

# mrkta_generalinfo, need to link to cleaned update market location data
mrktc_info <-  read_csv(here("data/data-cleaning_data/mrktc_generalinfo_tanzania_final.csv"))

mrktc_activities_raw <- read_csv(here("data/tanzania_data/mrktc_mrktactivities_tanzania.csv"))
```

```{r actvtylkp}

lkp_mrktactvty <- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpmrkt_actvty.csv")) %>%
  mutate(
    Code = as.character(Code),
    `1.mrkt.activity.lkp` = case_match(
      Code,
      "-66" ~ "Other",
      "1" ~ "Selling",
      "2" ~ "Middleman",
      "3" ~ "Trader",
      "4" ~ "Buying"
    )
  )

lkp_sellplacetype <- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpsell_placetype.csv")) %>%
  mutate(
    Code = as.character(Code),
    `2.sell.placetype.lkp` = case_match(
      Code,
      "-66" ~ "Other",
      "1" ~ "Village",
      "2" ~ "Towncentre",
      "3" ~ "Market",
      "4" ~ "Abattoir"
    )
  )

lkp_selltransport <- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpsell_trans.csv")) %>%
  mutate(
    Code = as.character(Code),
    `4.sell.transport.lkp` = case_match(
      Code,
      "-77" ~ "Unknown",
      "-66" ~ "Other",
      "1" ~ "Foot",
      "2" ~ "Vehicle",
      "3" ~ "Cart"
    )
  )

lkp_buyplacetype <- lkp_sellplacetype

lkp_buytransport <- lkp_selltransport

lkp_sellreason <- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpsell_reason.csv"))

lkp_buyreason <- read_csv(here("data/ecopprmarketscsvs/mrktc_lkpbuy_reason.csv"))

```

```{r activitiesClean}

colnames(mrktc_activities_raw)

mrktc_activities_clean1 <- mrktc_activities_raw %>%
  select(
    fid = fid.see.mrktc.generalinfo.,
    # unique.row.id.see.mrktc.generalinfo. # set to 1 for all rows
    # unique.row.id # set to 1 for all rows,
    "1.mrkt.activity" = "1.what.are.the.activities.that.you.are.doing.in.this.market.today.",
    "1.mrkt.activity.other" = "if.other.specify.5",
    "2.sell.placetype.code" = "type.of.place.see.mrktc.lkpsell.placetype.",
    "2.sell.placetype.other" ="if.other.specify",
    "2.sell.place.name" = "name.of.place.8",
    "2.sell.place.ward" = "ward.9",
    "2.sell.place.district" = "district.10",
    # "3.sell.reason"="3.what.is.your.main.reason.for.selling.these.sheep.and.or.goats.",
    # "3.sell.reason.other"="if.other.specify.12",
    "4.sell.transport.type"="4.how.were.sheep.goats.transported.to.the.market.see.mrktc.lkpsell.trans.",
    "4.sell.transport.other" = "if.other.specify.14",
    # "5.sell.other.species."="5.do.you.also.sell.other.animal.species.apart.from.sheep.and.goats.",
    # "5.sell.species.most"="if.yes.out.of.all.the.species.that.you.sell.which.species.do.you.sell.the.most.",
    # "5.specify.sell.species.most"="if.other.specify.17",
    "6.buy.placetype.code"="type.of.place.see.mrktc.lkpplacetype.",
    "6.buy.placetype.other"="if.other.specify.20",
    "6.buy.place.name" ="name.of.place.21",
    "6.buy.place.ward"="ward.22",
    "6.buy.place.district"="district.23",
    # "7.buy.reason"="7.what.is.your.main.reason.for.buying.these.small.ruminants.",
    # "7.buy.reason.other" = "if.other.specify.25",
    "6.buy.transport.yesno" = "will.you.transport.the.sheep.goats.you.are.buying.today.",
    "8.buy.transport.type"="8.how.will.you.transport.these.small.ruminants.that.you.are.buying.see.mrktc.lkpsell.trans.",
    "8.buy.transport.other"="if.other.specify.27",
    # "9.buy.criteria"="9.what.criteria.do.you.use.to.decide.which.small.ruminants.to.buy.",
    # "9.specify.buy.criteria"="if.other.specify.29",
    # "10.buy.species.preference"="10.what.other.species.of.animals.do.you.buy.apart.from.sheep.and.goats.",
    # "10.buy.species.preference.specify"="if.other.specify.31",
    # "11.buy.price.increase" = "11.if.the.prices.of.sheep.and.goats.increase.for.some.reason.e.g.a.shortage.of.animals.due.to.disease.will.you.still.buy.them.",
    # "11.buy.species.alternative" = "if.no.which.other.species.will.you.consider.instead.",
    # "11.buy.species.alternative.specify"="if.other.specify.34",
    # "11.buy.price.increase.details" = "if.yes.how.much.of.an.increase.in.the.current.price.of.sheep.and.goat.unit.price.of.live.animal.will.cause.you.to.change.your.purchasing.behaviour.to.another.animal.species",
    "12.buy.sell.per.month" = "12.how.many.times.in.a.month.do.you.buy.or.sell.sheep.and.or.goats.in.this.market.",
    "unique.row.identifier.uuid."   
  )

colnames(mrktc_activities_clean1)
```


```{r stringclean}

# tolower(``), # lowercase -->
# gsub("[[:punct:]]", " ", ``), # remove punctuation -->
# trimws(``),
# gsub("\\s+", " ", ``))

mrktc_activities_clean2 <- mrktc_activities_clean1 %>% 
  mutate(
    "2.sell.place.name" = tolower(`2.sell.place.name`),
    "2.sell.place.name" = gsub("[[:punct:]]", " ",`2.sell.place.name`),
    "2.sell.place.name" = trimws(`2.sell.place.name`),
    "2.sell.place.name" = gsub("\\s+", ".",`2.sell.place.name`),
    # "2.sell.place.ward",
    "2.sell.place.ward" = tolower(`2.sell.place.ward`),
    "2.sell.place.ward" = gsub("[[:punct:]]", " ",`2.sell.place.ward`),
    "2.sell.place.ward" = trimws(`2.sell.place.ward`),
    "2.sell.place.ward" = gsub("\\s+", ".",`2.sell.place.ward`),
    # "2.sell.place.district"
    "2.sell.place.district" = tolower(`2.sell.place.district`),
    "2.sell.place.district" = gsub("[[:punct:]]", " ",`2.sell.place.district`),
    "2.sell.place.district" = trimws(`2.sell.place.district`),
    "2.sell.place.district" = gsub("\\s+", ".",`2.sell.place.district`),
    
    # "6.buy.place.name"
     "6.buy.place.name" = tolower(`6.buy.place.name`),
    "6.buy.place.name" = gsub("[[:punct:]]", " ",`6.buy.place.name`),
    "6.buy.place.name" = trimws(`6.buy.place.name`),
    "6.buy.place.name" = gsub("\\s+", ".",`6.buy.place.name`),
    # "6.buy.place.ward",
    "6.buy.place.ward" = tolower(`6.buy.place.ward`),
    "6.buy.place.ward" = gsub("[[:punct:]]", " ",`6.buy.place.ward`),
    "6.buy.place.ward" = trimws(`6.buy.place.ward`),
    "6.buy.place.ward" = gsub("\\s+", ".",`6.buy.place.ward`),
    # "6.buy.place.district"
    "6.buy.place.district" = tolower(`6.buy.place.district`),
    "6.buy.place.district" = gsub("[[:punct:]]", " ",`6.buy.place.district`),
    "6.buy.place.district" = trimws(`6.buy.place.district`),
    "6.buy.place.district" = gsub("\\s+", ".",`6.buy.place.district`)
  )

```


```{r activitiesDetails}
# For fields which contain coded data, use lookups to populate. 

lkp_mrktactvty

# # A tibble: 5 × 4
#   Code  Description                           `Unique Row Identifier (UUID)`       `1.mrkt.activity.lkp`
#   <chr> <chr>                                 <chr>                                <chr>                
# 1 -66   Other (give details)                  72387dd7-bec6-11eb-81ba-3822e2cde809 Other                
# 2 1     Selling my own sheep and/ or goats    7236823f-bec6-11eb-81ba-3822e2cde809 Selling              
# 3 2     Middleman (broker)                    72373132-bec6-11eb-81ba-3822e2cde809 Middleman            
# 4 3     Trader (buying and selling)           7237a10d-bec6-11eb-81ba-3822e2cde809 Trader               
# 5 4     Buying sheep and/ or goats for myself 723813aa-bec6-11eb-81ba-3822e2cde809 Buying  

mrktc_activities_v2 <- mrktc_activities_clean2 %>%
  mutate(`1.mrkt.activity` = gsub(" ", ";", `1.mrkt.activity`)) %>% 
  mutate(
    "1.activity.sell" = if_else(grepl("1", `1.mrkt.activity`), 1, 0),
    "1.activity.middleman" = if_else(grepl("2", `1.mrkt.activity`), 1, 0),
    "1.activity.trade" = if_else(grepl("3", `1.mrkt.activity`), 1, 0),
    "1.activity.buy" = if_else(grepl("4", `1.mrkt.activity`), 1, 0),
    "1.activity.other" = if_else(grepl("-66", `1.mrkt.activity`), 1, 0), 
    "1.activity.multi" = if_else(sum(`1.activity.sell`,`1.activity.buy`,`1.activity.middleman`,`1.activity.trade`,`1.activity.other`)>1, 1, 0))

```

```{r}
lkp_sellplacetype
# 
# # A tibble: 5 × 4
#   Code  Description          `Unique Row Identifier (UUID)`       `2.sell.placetype.lkp`
#   <chr> <chr>                <chr>                                <chr>                 
# 1 -66   Other (give details) 723a71c1-bec6-11eb-81ba-3822e2cde809 Other                 
# 2 1     Village              72390c35-bec6-11eb-81ba-3822e2cde809 Village               
# 3 2     Centre/town          723966cf-bec6-11eb-81ba-3822e2cde809 Towncentre            
# 4 3     Market               7239de7c-bec6-11eb-81ba-3822e2cde809 Market                
# 5 4     Abattoir             723a2cba-bec6-11eb-81ba-3822e2cde809 Abattoir  

mrktc_activities_v3 <- mrktc_activities_v2 %>%
  mutate(
    "2.sell.village" = if_else(grepl("1", `2.sell.placetype.code`), 1, 0),
    "2.sell.town" = if_else(grepl("2", `2.sell.placetype.code`), 1, 0),
    "2.sell.market" = if_else(grepl("3", `2.sell.placetype.code`), 1, 0),
    "2.sell.abattoir" = if_else(grepl("4", `2.sell.placetype.code`), 1, 0),
    "2.sell.otherplace" = if_else(grepl("-66", `2.sell.placetype.code`), 1, 0)
  )

```


```{r}
lkp_selltransport

# # A tibble: 5 × 4
#   Code  Description      `Unique Row Identifier (UUID)`       `4.sell.transport.lkp`
#   <chr> <chr>            <chr>                                <chr>                 
# 1 -77   Don't know       723d00f0-bec6-11eb-81ba-3822e2cde809 Unknown               
# 2 -66   Other (describe) 723cbe44-bec6-11eb-81ba-3822e2cde809 Other                 
# 3 1     On foot          723beccf-bec6-11eb-81ba-3822e2cde809 Foot                  
# 4 2     By vehicle       723c33ba-bec6-11eb-81ba-3822e2cde809 Vehicle               
# 5 3     By cart          723c781b-bec6-11eb-81ba-3822e2cde809 Cart   

mrktc_activities_v4 <- mrktc_activities_v3 %>%
  mutate(
    "4.sell.foot" = if_else(grepl("1", `4.sell.transport.type`), 1, 0),
    "4.sell.vehicle" = if_else(grepl("2", `4.sell.transport.type`), 1, 0),
    "4.sell.cart" = if_else(grepl("3", `4.sell.transport.type`), 1, 0),
    "4.sell.othertransport" = if_else(grepl("-66", `4.sell.transport.type`), 1, 0),
    "4.sell.unknowntransport" = if_else(grepl("-77", `4.sell.transport.type`), 1, 0)
  )

```


```{r}
lkp_sellplacetype
# 
# # A tibble: 5 × 4
#   Code  Description          `Unique Row Identifier (UUID)`       `2.sell.placetype.lkp`
#   <chr> <chr>                <chr>                                <chr>                 
# 1 -66   Other (give details) 723a71c1-bec6-11eb-81ba-3822e2cde809 Other                 
# 2 1     Village              72390c35-bec6-11eb-81ba-3822e2cde809 Village               
# 3 2     Centre/town          723966cf-bec6-11eb-81ba-3822e2cde809 Towncentre            
# 4 3     Market               7239de7c-bec6-11eb-81ba-3822e2cde809 Market                
# 5 4     Abattoir             723a2cba-bec6-11eb-81ba-3822e2cde809 Abattoir  

mrktc_activities_v5 <- mrktc_activities_v4 %>%
  mutate(
    "6.buy.village" = if_else(grepl("1", `6.buy.placetype.code`), 1, 0),
    "6.buy.town" = if_else(grepl("2", `6.buy.placetype.code`), 1, 0),
    "6.buy.market" = if_else(grepl("3", `6.buy.placetype.code`), 1, 0),
    "6.buy.abattoir" = if_else(grepl("4", `6.buy.placetype.code`), 1, 0),
    "6.buy.otherplace" = if_else(grepl("-66", `6.buy.placetype.code`), 1, 0)
  )

```


```{r}
lkp_selltransport

# # A tibble: 5 × 4
#   Code  Description      `Unique Row Identifier (UUID)`       `4.sell.transport.lkp`
#   <chr> <chr>            <chr>                                <chr>                 
# 1 -77   Don't know       723d00f0-bec6-11eb-81ba-3822e2cde809 Unknown               
# 2 -66   Other (describe) 723cbe44-bec6-11eb-81ba-3822e2cde809 Other                 
# 3 1     On foot          723beccf-bec6-11eb-81ba-3822e2cde809 Foot                  
# 4 2     By vehicle       723c33ba-bec6-11eb-81ba-3822e2cde809 Vehicle               
# 5 3     By cart          723c781b-bec6-11eb-81ba-3822e2cde809 Cart   

mrktc_activities_v6 <- mrktc_activities_v5 %>%
  mutate(
    "8.buy.foot" = if_else(grepl("1", `8.buy.transport.type`), 1, 0),
    "8.buy.vehicle" = if_else(grepl("2", `8.buy.transport.type`), 1, 0),
    "8.buy.cart" = if_else(grepl("3", `8.buy.transport.type`), 1, 0),
    "8.buy.othertransport" = if_else(grepl("-66", `8.buy.transport.type`), 1, 0),
    "8.buy.unknowntransport" = if_else(grepl("-77", `8.buy.transport.type`), 1, 0)
  )

```

```{r}

mrktc_activities_v6 %>% select(`12.buy.sell.per.month`) %>% summary()
mrktc_activities_v6 %>% distinct(`12.buy.sell.per.month`) # remove any > 24

mrktc_activities_v7 <- mrktc_activities_v6 %>%
  mutate(`12.buy.sell.per.month` = if_else(`12.buy.sell.per.month`>30, NA, `12.buy.sell.per.month`))

```

```{r }

mrktc_activities_v7 %>% colnames()

mrktc_activities_summary <- mrktc_activities_v7 %>%
  select(
    fid, 
    starts_with("1."),
    starts_with("2."),
    starts_with("4."),
    starts_with("6."),
    starts_with("8."),
    starts_with("12."),
    unique.row.identifier.uuid.
  )



```

```{r saveActvty}
if(filesave){
  write_csv(mrktc_activities_summary, file = here("data/data-cleaning_data/mrktc_mrktactivities_tanzania_final.csv"))
}

```


## ORIGIN WARDS:


```{r originwards}
# tolower(``), # lowercase -->
# gsub("[[:punct:]]", " ", ``), # remove punctuation -->
# trimws(``),
# gsub("\\s+", " ", ``))

mrktc_activities_v6 %>% distinct(`2.sell.place.ward`, `2.sell.place.district`)

mrktc_activities_v6 %>% distinct(`2.sell.place.ward`)

mrktc_activities_v6 %>% distinct(`2.sell.place.district`) %>% arrange()

```

