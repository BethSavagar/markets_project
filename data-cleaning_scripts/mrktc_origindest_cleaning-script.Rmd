---
title: "Tanzania Market Survey C: Data Cleaning"
author: "Beth Savagar"
date: "2023-02-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

```{r libraries, include = F}
library(readr)
library(tidyverse)
library(sf)
library(ggplot2)
library(here)
library(knitr)
library(ggpubr)
library(RColorBrewer)
library(rmarkdown)
library(stringdist)
library(fuzzyjoin)
```

```{r load-data, include = F}

# Market Survey C data
# mrktc_gps <- read_csv(here("data/tanzania_data/mrktc_allgps_tanzania_final.csv"))
# mrktc_info <-  read_csv(here("data/data-cleaning_data/mrktc_generalinfo_tanzania_final.csv"))
mrktc_actvty <- read_csv(here("data/data-cleaning_data/mrktc_mrktactivities_tanzania_final.csv"))


# Load Tanzania Shapefile:
# tanzania_shp <- st_read(here("data/shapefiles/Districts and TC as 2020.shp")) # with district boundaries
tregs_shp <- st_read(here("data/shapefiles/tzshp_final/tregs_final.shp")) 

# tdists_shp <- st_read(here("data/shapefiles/tza_admbnda_adm2_20181019.shp")) # with district boundaries
twards_shp <- st_read(here("data/shapefiles/tzshp_final/twards_final.shp"))

```

# mjini = urban, vijini = rural

```{r subsetdata}

# 1.i. Tanzania wards, reference dataframe:
twards_df <- twards_shp %>% 
  st_drop_geometry()

# 1.ii. Origin and destination data:
# mrktc_origdest <- mrktc_actvty %>% 
#   select(fid,
#          starts_with("2.sell.place"), 
#          starts_with("6.buy.place"))


mrktc_origdest_long <- mrktc_actvty %>%
  
  # Select Origins: 
  select(
    fid,
    place0 = `2.sell.place.name`,
    ward0 = `2.sell.place.ward`,
    district0 = `2.sell.place.district`) %>%
  mutate(origdest = "orig") %>%
  
  # Bind Destinations:
  bind_rows(mrktc_actvty %>%
              select(
                fid,
                 place0 = `6.buy.place.name`,
                 ward0 = `6.buy.place.ward`,
                 district0 = `6.buy.place.district`) %>%
              mutate(origdest = "dest")
  ) %>%
  
  # Remove rows with no location data:
  
  ##  Replace "na" with NA & remove rows with all NAs
  mutate(place0 = if_else(place0 == "na", NA, place0),
         ward0 = if_else(ward0 == "na", NA, ward0),
         district0 = if_else(district0 == "na", NA, district0)) %>%
  filter(! (is.na(place0) & is.na(ward0) & is.na(district0))) %>% # remove NAs
  
  # Update missing place/ward/districts with available info
  mutate(
    place = if_else(is.na(place0), ward0, place0), # replace missing placename with ward
    ward = if_else(is.na(ward0), place0, ward0), # replace missing wardname with place
    district = if_else(is.na(district0), place0, district0) # replace missing district name with place
  )

```


```{r matchdist}
# 2. Clean common location suffixes

# mjini = urban, vijini = rural
# suffix for urban: .tc, .mc, .cc
# suffix for rural: "dc"

twards_df %>% distinct(Dist20_N) %>% View()

# - Check in reference data
twards_df %>% 
  # Extracts the part after the last dot:
  mutate(suffix = stringr::str_extract(Dist20_N, "\\.[^.]*$")) %>%
  distinct(suffix) %>% 
  View()

# - Check in origdest data:
mrktc_origdest_long %>%
  mutate(suffix = stringr::str_extract(district, "\\.[^.]*$")) %>%
  distinct(suffix) %>% 
  arrange(suffix) %>% 
  View()

## 2.ii. Replace common suffixes in data:
mrktc_origdest_long <- mrktc_origdest_long %>%
  mutate(dist_suffix = gsub("\\.mji[a-z]*$", ".cc.mc.tc", district), #.mji, .mjini
         dist_suffix = gsub("\\.ji[a-z]*$", ".cc.mc.tc", dist_suffix), # .jini
         dist_suffix = gsub("\\.manispaa$", ".mc", dist_suffix),
         dist_suffix = gsub("\\.munispaa$", ".mc", dist_suffix),
         dist_suffix = gsub("\\.vij[a-z]*$", ".dc", dist_suffix), #.vijijini , .vijini
         dist_suffix = if_else(grepl("dodoma",dist_suffix), "dodoma.cc", dist_suffix),
         dist_suffix = if_else(grepl("makambako",dist_suffix), "makambako.tc", dist_suffix),
         
         # Checks if location ends with .dc, .tc, .cc, or .mc (if yes, keep suffix / if no, append with .dc)
         dist_suffix = if_else(grepl("\\.(dc|tc|cc|mc)$", dist_suffix), dist_suffix, paste0(dist_suffix, ".dc")),
         dist_nosuffix = gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", dist_suffix),
         # 
         # # Place name: 
         # place_suffix = gsub("\\.mji[a-z]*$", ".cc.mc.tc", place), #.mji, .mjini
         # place_suffix = gsub("\\.ji[a-z]*$", ".cc.mc.tc", place_suffix), # .jini
         # place_suffix = gsub("\\.manispaa$", ".mc", place_suffix),
         # place_suffix = gsub("\\.munispaa$", ".mc", place_suffix),
         # place_suffix = gsub("\\.vij[a-z]*$", ".dc", place_suffix), #.vijijini , .vijini
         # place_suffix = if_else(grepl("dodoma",place_suffix), "dodoma.cc", place_suffix),
         # place_suffix = if_else(grepl("makambako",dist_suffix), "makambako.tc", place_suffix),
         # place_suffix = if_else(grepl("\\.(dc|tc|cc|mc)$", place_suffix), # Checks if location ends with .dc, .tc, .cc, or .mc
         #                      dist_suffix,                            # If true, keep the original location
         #                      paste0(dist_suffix, ".dc")              # If false, append ".dc"
         #                      ),
         # place_nosuffix = gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", place_suffix)
  )

## 2.iii. Replace common suffixes in reference list:

twards_match <- twards_df %>%
  distinct(Ward_N, Dist20_N, Region20_N) %>% 
  mutate(Dist20_nosuffix =  gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", Dist20_N))

```

## Clean District Names:

```{r distclean1}

# # Dataframe of district-regions in regerence data:

tdists_match <- twards_match %>%
  distinct(Dist20_N, Dist20_nosuffix, Region20_N)
  
dist_lkp <- mrktc_origdest_long %>% 
  distinct(dist_suffix, dist_nosuffix) %>%
  stringdist_join(., tdists_match, 
                  by=c(dist_suffix = "Dist20_N", 
                       dist_nosuffix = "Dist20_nosuffix"),
                mode='left', # use left join
                method = "jw", # use jw distance metric
                max_dist=99, 
                distance_col='dist') %>%
  group_by(dist_suffix) %>%
  slice_min(order_by=dist_suffix.dist, n=1) %>%
  ungroup()
  
dist_lkp <- dist_lkp %>%
  mutate(acceptD0 = if_else(dist_suffix.dist == 0, "accept_D0", 
                            if_else(dist_nosuffix.dist == 0, "accept_D1", NA)))
# Save and complete manual check:
# write.csv(dist_lkp, file = here("data/data-cleaning_data/origdest_distlkp.csv"), row.names = F)

# Load post-manual check:
dist_lkp <- read_excel(here("data/data-cleaning_data/origdest_distlkp.xlsx"))

dist_lkp <- dist_lkp %>%
  mutate(district.clean = 
           if_else(
             acceptD0 %in% c("accept_D0", "accept_D1", "accept_D2"),
             Dist20_N,
             if_else(
               acceptD0 %in% c("kenya", "manyoni.dc", "tanganyika"),
               acceptD0,
               dist_nosuffix
             )
           ),
         region.clean = if_else(acceptD0 %in% c("accept_D0", "accept_D1", "accept_D2", "manyoni.dc"),
                                Region20_N,
                                district.clean)
         ) %>%
  distinct(dist_suffix, dist_nosuffix, acceptD0, district.clean, region.clean)

# NOTE #
# Lake Tanganyika is bordered by Rukwa, Katavi and Kigoma regions
# Tanganyika ward is within muheza.DC in Tanga region

origdest_long <- mrktc_origdest_long %>%
  left_join(dist_lkp, by = c("dist_suffix", "dist_nosuffix"))
  # for those districts which are now cleaned, add the confirmed region:

```


```{r origdestmatch}

origdest_match <- origdest_long %>%
  distinct(place, ward, district.clean, acceptD0, region.clean) %>%
  # place-ward-district: 
  mutate(pwd.A =paste(place, ward, district.clean, sep = "-"), 
         wd.A = paste(ward, district.clean, sep = "-"),
         wdr.A = paste(ward,district.clean,region.clean, sep = "-")) %>% 
  rename("ward.A" = ward, "dist.A" = district.clean, "reg.A" = region.clean)


twards_match <- twards_match %>%
  mutate(
    wd.B = paste(Ward_N, Dist20_N, sep = "-"),
    wdr.B = paste(Ward_N, Dist20_N, Region20_N, sep = "-")) %>%
  select(
    ward.B = Ward_N,
    dist.B = Dist20_N,
    reg.B = Region20_N,
    wd.B,
    wdr.B
  )

```


# For entries with a confirmed district

```{r dcleanmatch}

## For confirmed districts:
# Append the region, find the closest place-ward-district match in the data
# 
# wdr_match <- origdest_match %>%
#    stringdist_join(.,twards_match, 
#                    by=c("pwd.A" = "wdr.B",
#                         "wdr.A" = "wdr.B",
#                         "reg.A" = "reg.B"),
#                 mode='left', #use left join
#                 method = "jw", #use jw distance metric
#                 max_dist=99, 
#                 distance_col='dist')  %>%
#   rowwise() %>%
#   mutate(dist_sum = sum(ward.A.dist, dist.A.dist, reg.A.dist)) %>%
#   ungroup() %>%
#   group_by(pwd.A) %>%
#   slice_min(order_by=dist_sum, n=1) %>%
#   ungroup()

wdr_match <- origdest_match %>%
   stringdist_join(.,twards_match, 
                   by=c("ward.A" = "ward.B",
                        "dist.A" = "dist.B",
                        "reg.A" = "reg.B"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=99, 
                distance_col='dist')  %>%
  rowwise() %>%
  mutate(dist_sum = sum(ward.A.dist, dist.A.dist, reg.A.dist)) %>%
  ungroup() %>%
  group_by(pwd.A) %>%
  slice_min(order_by=dist_sum, n=1) %>%
  ungroup()


wdr_match <- wdr_match %>%
  mutate(
    acceptWDR = 
      if_else(dist_sum == 0, "acceptWDR0", NA)
  )

# Identify entries where the ward and region match but the district is incorrect:

unmatchdstrct <- wdr_match %>%
  # filter results which matched district and region but don't match by ward:
  filter(ward.A.dist == 0, 
         dist.A.dist > 0,
         reg.A.dist == 0) %>%
  select(dist.A, dist.B, dist.A.dist, wdr.A, wdr.B) %>%
  distinct()
# manually checked all examples, matches are either:
  # bordering districts/mistakes 
  # the incorrect suffix: t e.g. bariadi.dc = bariadi.tc)

wdr_match <- wdr_match %>% 
  left_join(unmatchdstrct %>% mutate(acceptWDR1 = "acceptWDR1") %>% 
              select(wdr.A,wdr.B,acceptWDR1))



# Identify entries where the district and region match but the ward is incorrect:
# Check these manually in excel
unmatchwd <- wdr_match %>%
  # filter results which matched district and region but don't match by ward:
  filter(ward.A.dist>0, 
         dist.A.dist == 0,
         reg.A.dist == 0) %>%
  select(place, ward.A, ward.B, ward.A.dist, wdr.A, wdr.B) %>%
  distinct()

# write.csv(unmatchwd, file = here("data/data-cleaning_data/unmatchwd_lkp.csv"), row.names = F)
unmatchwd_lkp <- read_excel(here("data/data-cleaning_data/unmatchwd_lkpxl.xlsx")) %>%
  mutate(acceptWDR2 = "acceptWDR2")

wdr_match_check <- wdr_match %>% 
  left_join(unmatchwd_lkp %>% 
              select(place, wdr.A,wdr.B,acceptWDR2)) %>%
  mutate(acceptWDR = if_else(is.na(acceptWDR),acceptWDR1,acceptWDR),
         acceptWDR = if_else(is.na(acceptWDR),acceptWDR2,acceptWDR)
  ) %>%
  distinct()

wdr_match_check %>% group_by(acceptWDR) %>% count()


wdr_match_join <- wdr_match_check %>%
  filter(!is.na(acceptWDR)) %>%
  select(place,ward.A,pwd.A,wdr.A,dist.A,ward.B,dist.B,reg.B,wdr.B, acceptWDR) %>%
  distinct(place, pwd.A, wdr.A, wdr.B, acceptWDR, .keep_all = T)

# wdr_match_join %>%
#   group_by(place, wdr.A, wdr.B) %>%
#   mutate(dupe = n()>1) %>% View()

origdest_match2 <- origdest_match %>% 
  left_join(
    wdr_match_join,
    by = c("place", "ward.A", "dist.A", "pwd.A", "wdr.A")
  ) %>%
  distinct(
    place,ward.A,dist.A,reg.A,pwd.A,wdr.A,ward.B,dist.B,reg.B,wdr.B,acceptWDR, .keep_all=T
  )

# origdest_match2 %>% group_by(place,ward.A,dist.A,reg.A,wdr.B) %>% mutate(dupe = n()>1) %>% View()

unmatchedZ <- wdr_match_check %>% 
  filter(is.na(acceptWDR)) %>% 
  distinct(place,ward.A,dist.A, wdr.B)



origdest_long %>%
  left_join(origdest_match2 %>% select(-c("acceptD0")), 
            by = c("place", ward = "ward.A",district.clean = "dist.A")) %>% 
  group_by(place0,ward0,district0,origdest,pwd.A,wdr.A,ward.B,dist.B,reg.B,acceptWDR) %>%
  mutate(dupe = n()>1) %>% View()


origdest_long %>%
  left_join(origdest_match2 %>% select(-c("acceptD0")), 
            by = c("place", ward = "ward.A",district.clean = "dist.A")) %>% 
  group_by(place0,ward0,district0,origdest,pwd.A,wdr.A,ward.B,dist.B,reg.B,acceptWDR) %>%
  mutate(dupe = n()>1) %>% group_by(dupe) %>% count()

  group_by(acceptWDR) %>% count()

```



```{r}

twards_match <- twards_df %>%
  distinct(Ward_N, Dist20_N, Region20_N) %>% 
  mutate(Dist20_nosuffix =  gsub("\\.(dc|tc|cc|mc|cc\\.mc\\.tc)$", "", Dist20_N),
         wdr20 = paste(Ward_N, Dist20_nosuffix, Region20_N, sep = "-"),
         wd20 = paste(Ward_N, Dist20_nosuffix, sep = "-"))
  

matched_df <- stringdist_join(origdest_match, twards_match, 
                             by=c("pwd" = "wdr20",
                                  "wd" = "wd20"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=99, 
                distance_col='dist') %>%
  rowwise() %>%
  # mutate(dist_sum = sum(dist_suffix.dist, ward.dist),
  #        distnosuffix_sum = sum(dist_nosuffix.dist, ward.dist)) %>%
  mutate(dist_sum = sum(wd.dist, pwd.dist)) %>%
  ungroup() %>%
  group_by(pwd) %>%
  slice_min(order_by=dist_sum, n=1) %>%
  ungroup()

matched_df %>% select(pwd.A = pwd,wdr.B=wdr20,wd.A = wd,wd.B = wd20,ends_with(".dist"), dist_sum) %>% View()
matched_df %>% filter(wd.dist == 0) %>% nrow() # 936 rows with perfect ward-district match!

matched_df <- matched_df %>%
  mutate(accept = if_else(wd.dist==0, "accept0", NA)) 

join_df <- matched_df %>%
  filter(accept == "accept0") %>%
  select(-c(wdr20,wd20,pwd.dist,wd.dist,dist,dist_sum))

unmatched_df1 <- matched_df %>% 
  filter(is.na(accept))


# Match on ward and district data 
twards_unique <- twards_match %>% group_by(Ward_N) %>% count()  %>% filter(n==1) %>% pull(Ward_N)
tdists_unique <- twards_match %>% group_by(Dist20_N, Dist20_nosuffix) %>% count() %>% group_by (Dist20_nosuffix) %>% count() %>% filter(n==1) %>% pull(Dist20_nosuffix)

isWardDist <- unmatched_df1 %>%
  select(place, ward, dist_suffix, dist_nosuffix, pwd, wd) %>%
  mutate(
    is.ward = if_else(
      ward == place & ward == dist_nosuffix & ward %in% twards_match$Ward_N,
      "Y", 
      NA),
    is.district = if_else(
      dist_nosuffix == place & dist_nosuffix == ward & dist_nosuffix %in% twards_match$Dist20_nosuffix,
      "Y", 
      NA))

wdonly <- isWardDist %>%
  filter(is.ward=="Y" & is.na(is.district) & ward %in% twards_unique) %>%
  left_join(twards_match %>% select(Ward_N, Dist20_N, Region20_N, Dist20_nosuffix), 
            by = c(ward = "Ward_N")) %>%
  mutate(Ward_N = ward, 
         accept = "acceptW0")

distonly <- isWardDist %>%
  filter(is.district=="Y" & is.na(is.ward) & dist_nosuffix %in% tdists_unique) %>%
  left_join(twards_match %>% 
              filter(Dist20_nosuffix %in% tdists_unique) %>%
              select(Dist20_N, Region20_N, Dist20_nosuffix), 
            by = c(dist_nosuffix = "Dist20_nosuffix")) %>%
  mutate(Dist20_nosuffix = dist_nosuffix,
         Ward_N = NA, 
         accept = "acceptD0") %>%
  # remove duplicates (because each row of iswarddist will match every row for district in twards)
  distinct()

#  [1] "place"           "ward"            "dist_suffix"     "dist_nosuffix"   "pwd"            
#  [6] "wd"              "Ward_N"          "Dist20_N"        "Region20_N"      "Dist20_nosuffix"
# [11] "accept"  

join_df2 <- bind_rows(
  wdonly,
  distonly
)

# Accept ward-district-region from twards data if isWard & only 1 ward in refdata
# Accept district-region from twards data if isDistrict & only 1 district in refdata

matched_df <- matched_df %>%
  left_join(
    join_df2 %>%
      rename("Ward_N.b" = Ward_N, 
             "Dist20_N.b" = Dist20_N, 
             "Dist20_nosuffix.b" = Dist20_nosuffix,
             "Region20_N.b" = Region20_N,
             "accept.b" = accept
             )
  ) %>% 
  mutate(accept = if_else(is.na(accept), accept.b, accept))


unmatched_df2 <- matched_df %>% 
  filter(is.na(accept)) %>% 
  select(-c(ends_with(".b"), `is.ward`, `is.district`))

write.csv(unmatched_df2, file = here("data/data-cleaning_data/mrktc_origdest_unmatch.csv"))
  
# mrktc_origdest_match2 <- mrktc_origdest_match %>%
#   left_join(
#     pwd_join %>% select(place, ward, dist_suffix, Ward_N, Dist20_N, Region20_N, accept),
#     by = c("place", "ward", "dist_suffix")
#   )

# write.csv(unmatched_df2 %>% 
#             select("pwd.A" = pwd,
#                    "wd.A" = wd,
#                    "wd.B" = wd20,
#                    "wdr.B" = wdr20,
#                    accept1,
#                    pwd.dist,
#                    wd.dist,
#                    dist_sum), file = here("data/data-cleaning_data/mrktc_origdest_unmatch.csv"))

```

# Pwd_unmatch - save as excel sheet and manually check wd-dist matches mark 1 if accepted, mark 0 if not accepted:

```{r manualmatch}
# unmatched_df2_lkp <- read_excel(here("data/data-cleaning_data/mrktc_origdest-stringmatch_lkp.xlsx"), sheet = "unmatch2") %>% rename("accept.c" = accept1)

# colnames(pwd_join)

matched_df <- matched_df %>% 
  left_join(unmatched_df2_lkp %>% 
              filter(`accept.c`== 1) %>%
              select(-c("pwd.dist","wd.dist","dist_sum")) %>% 
              distinct(), 
            by = c(pwd = "pwd.A", wdr20 = "wdr.B", wd = "wd.A", wd20 = "wd.B")) %>%
  mutate(accept = if_else(is.na(accept), accept.c, accept),
         accept = if_else(accept == "1", "manual", accept))


matched_df %>% group_by(accept) %>% count()


matched_clean <- matched_df %>%
  mutate(ward.match = if_else( accept %in% c("accept0", "manual"), Ward_N,
                               if_else(accept == "acceptW0", Ward_N.b, NA)),
         dist.match = if_else( accept %in% c("accept0", "manual"), Dist20_N,
                               if_else(accept %in% c("acceptW0", "acceptD0"), Dist20_N.b, NA)),
         reg.match = if_else( accept %in% c("accept0", "manual"), Region20_N,
                               if_else(accept %in% c("acceptW0", "acceptD0"), Region20_N.b, NA))
         ) %>%
  select(place, ward, dist_nosuffix, dist_suffix, ends_with(".match"), accept)

left_join(mrktc_origdest_match, 
          matched_clean, 
          by = c("place", "ward", "dist_suffix", "dist_nosuffix")) %>%
  distinct() %>% 
  group_by(accept) %>% count()

left_join(mrktc_origdest_match, 
          matched_clean, 
          by = c("place", "ward", "dist_suffix", "dist_nosuffix")) 

```



### District cleaning for remaining unmatched rows:

```{r distclean}

unmatched_df3 <- matched_clean %>% filter(is.na(accept)) %>% select(-c(ends_with(".match"), accept, wd))
tdists_match <- twards_match %>% distinct(Dist20_N, Dist20_nosuffix, Region20_N)

district_lkp <- matched_clean %>% 
  filter(is.na(accept)) %>% 
  select(place,ward,dist_nosuffix, dist_suffix) %>%
  distinct(dist_suffix, dist_nosuffix) %>%
  stringdist_join(., tdists_match, 
                             by=c(dist_suffix = "Dist20_N",
                                  "dist_nosuffix" = "Dist20_nosuffix"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=99, 
                distance_col='dist') %>%
  group_by(dist_suffix) %>%
  slice_min(order_by=dist_suffix.dist, n=1) %>%
  ungroup()

# Manually check matched districts in Excel 
# write.csv(district_lkp, file = here("mrktc_origdest-district_lkp.csv"))
district_lkp <- read_excel(here("data/data-cleaning_data/mrktc_origdest-district_lkp.xlsx"))

unmatched_df3 <- unmatched_df3 %>% 
  left_join(district_lkp %>% 
              select(acceptD1, dist_suffix, dist_nosuffix, Dist20_N, Dist20_nosuffix) %>% 
              filter(acceptD1 == 1) %>%
              distinct(), 
            by = c("dist_suffix", "dist_nosuffix")) %>%
  rename(dist_suffix.clean = Dist20_N, dist_nosuffix.clean = Dist20_nosuffix) %>%
  mutate(dist_nosuffix.clean = if_else(is.na(dist_nosuffix.clean), dist_nosuffix, dist_nosuffix.clean), 
         dist_suffix.clean = if_else(is.na(dist_suffix.clean), dist_nosuffix, dist_suffix.clean))

twards_unique_match <- twards_df %>%filter(Ward_N %in% twards_unique)
twards_df %>% group_by(Ward_N) %>% count() %>% filter(n>1) %>% sort(desc(n))

# if ward is unique then allow match?

ward_exactmatch_lkp <- unmatched_df3 %>% 
  # filter(is.na(accept)) %>% 
  distinct(place, ward, dist_nosuffix.clean, dist_suffix.clean) %>%
  stringdist_join(., twards_unique_match, by=c(ward = "Ward_N"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0, 
                distance_col='dist') %>%
  group_by(place,ward) %>%
  slice_min(order_by=dist, n=1) %>%
  ungroup() %>%
  select(place, ward, dist_nosuffix.clean, Ward_N, Dist20_N, Region20_N, dist)

  
  ## If districts within confirmed districts list:

distlist <- unmatched_df3 %>% 
  filter(acceptD1 == "1") %>%
  distinct(dist_suffix.clean) %>%
  pull()


df_master <- c()

for(i in 1:length(distlist)){
  
  dist_i <- distlist[i]
  ref_i <- twards_df %>% filter(Dist20_N == dist_i)
  df_i <- unmatched_df3 %>%
    filter(
      dist_suffix.clean == dist_i
    ) %>%
    distinct(ward, dist_suffix.clean)
  
  df_i_match <- stringdist_join(df_i, 
                                ref_i %>% select(Ward_N, Dist20_N, Region20_N), 
                                by=c(ward = "Ward_N"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=10, 
                distance_col='dist') %>%
    group_by(ward) %>%
    slice_min(order_by=dist, n=1) %>%
    ungroup() %>%
    select(ward, dist_suffix.clean, Ward_N, Dist20_N, Region20_N, dist) %>%
    distinct()
  
  df_master <- bind_rows(df_master,
                         df_i_match)
}

# manually check matches between districts 
# update unmatched df

# then:

# 1) create dataframe which contains only wards found in the data
# 2) find exact matches for wards in data


wdlist <- unmatched_df3 %>% 
  distinct(ward) %>%
  pull()

df_wardmaster <- c()

for(i in 1:length(wdlist)){
  
  ward_i <- wdlist[i]
  ref_i <- twards_df %>% filter(Ward_N == ward_i)
  df_i <- unmatched_df3 %>%
    filter(
      ward == ward_i
    )
  
  df_i_match <- stringdist_join(df_i, 
                                ref_i %>% select(Ward_N, Dist20_N, Region20_N), 
                                by=c(ward = "Ward_N"),
                mode='left', #use left join
                method = "jw", #use jw distance metric
                max_dist=0, 
                distance_col='dist') %>%
    group_by(ward) %>%
    slice_min(order_by=dist, n=1) %>%
    ungroup() %>%
    left_join(twards_df %>% select(Dist20_N, "region.A"= Region20_N), 
                               by = c("dist_suffix.clean" = "Dist20_N")) %>%
    select(ward, dist_suffix.clean, region.A, Ward_N, Dist20_N, Region20_N, dist) %>%
    distinct()
  
  df_wardmaster <- bind_rows(df_wardmaster,
                         df_i_match)
}
```




join_df3 <- pwd_join %>% 
  # round distance metrics for joining
  mutate(pwd.dist = round(pwd.dist, digits = 4),
         wd.dist = round(pwd.dist, digits = 4),
         dist_sum = round(pwd.dist, digits = 4)) %>%
  left_join(
    pwd_unmatch_lkp %>% 
      # round distance metrics for joining
      mutate(pwd.dist = round(pwd.dist, digits = 4),
             wd.dist = round(pwd.dist, digits = 4),
             dist_sum = round(pwd.dist, digits = 4)),
      by = c(pwd = "pwd.A",
             wd = "wd.A",
             wdr20 = "wdr.B",
             wd20 = "wd.B",
             "pwd.dist",
             "wd.dist",
             "dist_sum"
             )
    ) %>%
  # update accept field:
  mutate(accept = if_else(is.na(accept) & accept1 == 1, "accept1", accept)) %>%
  distinct()

pwd_unmatch2 <- pwd_join2 %>% 
  filter(is.na(accept)) %>% 
  distinct()
  # select(pwd.A = pwd, wdr.B=wdr20, wd.A = wd, wd.B = wd20, ends_with(".dist"), dist_sum) 


mrktc_origdest_match2 <- mrktc_origdest_match %>%
  left_join(
    pwd_join2 %>% 
      select(place, ward, dist_suffix, Ward_N, Dist20_N, Region20_N, accept) %>%
      filter(!is.na(accept)),
    by = c("place", "ward", "dist_suffix")
  )

```















<!-- ```{r checks} -->


<!-- # 1. Ward - match;  District - match -->
<!-- # 2. Ward - match; District - minor error -->
<!-- # 3. Ward - minor error; District - match -->
<!-- # 4. Ward - minor error; District - minor error -->
<!-- # 5. Ward = match; placecheck = ward OR pwd -->
<!-- # 6. Dist - match; placecheck = dist OR pwd -->


<!-- PWDmatch <- PWDmatch %>%  -->
<!--   mutate( -->
<!--     # 1. Ward - match;  District - match -->
<!--     match = if_else(dist_sum == 0, "accept0", NA), -->
<!--     match = if_else(is.na(match) & distnosuffix_sum == 0, "accept0*", match), -->

<!--     # 2. Ward - match; District - minor error -->
<!--     match = if_else(is.na(match) & ward.dist == 0 & dist_sum < 0.2, "acceptW0", match), -->

<!--     # 3. Ward - minor error; District - match -->
<!--     match = if_else(is.na(match) & dist_nosuffix.dist == 0 & dist_sum < 0.217, "acceptD0", match), -->
<!--     # 4. Ward - minor error; District - minor error -->
<!--     #### -->

<!--     # If all fields are the same and match a ward or district name: -->
<!--     match = if_else(is.na(match) & ward.dist == 0 & placecheck == "pwd", "acceptW1", match), -->

<!--     match = if_else(is.na(match) & dist_nosuffix.dist == 0 & placecheck == "pwd", "acceptD1", match), -->

<!--     # If ward name is correct -->
<!--     match = if_else(is.na(match) & ward.dist == 0, "acceptW2", match) -->

<!--   ) -->


<!-- PWDmatch %>% filter(is.na(match)) %>% View() -->
<!-- ## If place == ward == district  -->









<!-- warddistmatch %>% select(dist_suffix, Dist20_N, dist_nosuffix, Dist20_nosuffix, ward, Ward_N, everything()) %>% -->
<!--   filter(is.na(match), dist_nosuffix.dist == 0) %>% -->
<!--   View() -->
<!-- # 377 match districts -->


<!-- warddistmatch %>% select(dist_suffix, Dist20_N, dist_nosuffix, Dist20_nosuffix, ward, Ward_N, everything()) %>% -->
<!--   filter(is.na(match), ward.dist == 0) %>% -->
<!--   View() -->
<!-- # 73 matched wards -->

<!-- distmatch %>% filter(is.na(match)) %>% arrange(dist_suffix.dist) %>% View() -->
<!-- distmatch %>% group_by(dist_match) %>% count() %>% filter(n>1) # 11 district entries match multiples -->


<!-- # Accept all exact matches for ward? -->

<!-- ``` -->








<!-- ```{r} -->




<!-- mrktc_origdest_distinct <- mrktc_origdest_long %>% -->
<!--   distinct(place,ward,district) %>% -->
<!--   mutate( -->
<!--     # AND = NA -->
<!--     place = gsub("\\.na\\.", "\\.and\\.", place), # translation -->
<!--          ward = gsub("\\.na\\.", "\\.and\\.", ward), -->
<!--          district = gsub("\\.na\\.", "\\.and\\.", district), -->

<!--          # OF = YA -->
<!--          # place = gsub("\\.ya\\.", "\\.of\\.", place), # translation -->
<!--          # ward = gsub("\\.ya\\.", "\\.of\\.", ward), -->
<!--          # district = gsub("\\.ya\\.", "\\.of\\.", district), -->
<!--          #  -->
<!--          # # replace mji in middle of word (means urban) -->
<!--          # place = gsub("mji[a-z]*\\.", "urban.", place), -->
<!--          # ward = gsub("mji[a-z]*\\.", "urban.", ward), -->
<!--          # district = gsub("mji[a-z]*\\.", "urban.", district), -->

<!--          # replace mji at end of word (means urban)  -->
<!--          place = gsub("mji[a-z]*\\b", "urban", place), -->
<!--          ward = gsub("mji[a-z]*\\b", "urban", ward), -->
<!--          district = gsub("mji[a-z]*\\b", "urban", district), -->

<!--          # # replace vij in middle of word -->
<!--          # place = gsub("vij[a-z]*\\.", "rural.", place), -->
<!--          # ward = gsub("vij[a-z]*\\.", "rural.", ward), -->
<!--          # district = gsub("vij[a-z]*\\.", "rural.", district), -->

<!--          # replace vij at end of word: -->
<!--          place = gsub("vij[a-z]*\\b", "rural", place), -->
<!--          ward = gsub("vij[a-z]*\\b", "rural", ward), -->
<!--          district = gsub("vij[a-z]*\\b", "rural", district), -->

<!--          # replace manispaa (means municipality) in middle of word -->
<!--          place = gsub("manispaa", "municipality", place), -->
<!--          ward = gsub("manispaa", "municipality", ward), -->
<!--          district = gsub("manispaa", "municipality", district), -->

<!--          # replace munispaa means municipality) in middle of word -->
<!--          place = gsub("munispaa", "municipality", place), -->
<!--          ward = gsub("munispaa", "municipality", ward), -->
<!--          district = gsub("munispaa", "municipality", district) -->
<!--          ) -->





<!-- ``` -->


<!-- # Compare districts to tanzania districts list: -->

<!-- ```{r } -->

<!-- # tdists <- twards_df %>% distinct(district) %>% pull() -->
<!-- # tdisturban <- tdists[grep("urban", tdists)] -->
<!-- #  -->
<!-- # twards <- twards_df %>% distinct(ward) %>% pull() -->
<!-- # tregs <- twards_df %>% distinct(region) %>% pull() -->
<!-- # #  -->
<!-- # mrktc_origdest_distinct <- mrktc_origdest_distinct %>%  -->
<!-- #   mutate(district = if_else(str_detect(district, "\\.urban") & !district %in% tdisturban,  -->
<!-- #                             str_remove(district, "\\.urban"), -->
<!-- #                             district)) -->
<!-- #  -->
<!-- #  -->
<!-- # distcorrect <- mrktc_origdest_distinct %>%  -->
<!-- #   # list distinct district names in origdest data: -->
<!-- #   distinct(district) %>%  -->
<!-- #   filter(!is.na(district)) %>% -->
<!-- #   arrange() %>% -->
<!-- #   mutate( -->
<!-- #     # check if recorded district name matches any fields in tanzania region, district or ward  -->
<!-- #     treg = tregs[amatch(district, tregs, maxDist = Inf)], -->
<!-- #     tdist = tdists[amatch(district, tdists, maxDist = Inf)], -->
<!-- #     tward = twards[amatch(district, twards, maxDist = Inf)] -->
<!-- #   ) %>% -->
<!-- #   mutate(check = if_else(district == tdist, "accept_0",  -->
<!-- #                          if_else(district == tward, "ward.name", -->
<!-- #                                  if_else(district == treg, "reg.name", NA))) -->
<!-- #          ) -->
<!-- #    -->
<!-- # # save and then compare to twards_df in excel -->
<!-- # write.csv(distcorrect, file = here("data/data-cleaning_data/mrktc_origdest_tdists.csv"), row.names = F) -->
<!-- # write.csv(twards_df, file = here("data/data-cleaning_data/twards_df.csv"), row.names = F) -->
<!-- #  -->
<!-- #  -->
<!-- # # save for checking -->
<!-- # write.csv(mrktc_warddist_unmatch, file = here("data/data-cleaning_data/mrktc_origplace_clean1.csv")) -->
<!-- #  -->
<!-- ``` -->


<!-- ```{r originaldistricts} -->

<!-- tdists <- twards_df %>% distinct(district) %>% pull() -->
<!-- # tdisturban <- tdists[grep("urban", tdists)] -->

<!-- twards <- twards_df %>% distinct(ward) %>% pull() -->
<!-- tregs <- twards_df %>% distinct(region) %>% pull() -->

<!-- # Find exact matches on ward and district from twards geodata: -->

<!-- mrktc_origdest_check <- mrktc_origdest_distinct %>%  -->
<!--   # list distinct district names in origdest data: -->
<!--   arrange() %>% -->
<!--   left_join(twards_df %>% select(district, ward, ET_ID) %>% mutate(tmatch_0 = "tmatch_0"), by = c("district", "ward"))  -->

<!-- mrktc_origdest_check %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- # Verify District Names: -->
<!-- # - Start by cleaning district names: -->

<!-- distonly_match <- mrktc_origdest_check %>% -->
<!--   # filter(is.na(tmatch_0)) %>% -->
<!--   # select(-c(ET_ID, tmatch_0)) %>% -->
<!--   # identify districts which are found in the tdists data: -->
<!--   mutate(tmatch_0 = if_else(is.na(tmatch_0) & district %in% tdists, "tmatch_distonly_0", tmatch_0)) -->

<!-- distonly_match %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- # 544 districts are unmatched -->

<!-- distonly_match %>% filter(is.na(tmatch_0)) %>% distinct(district) -->

<!-- # remove ".urban" and .municipality suffix if not found in twards data -->
<!-- # remove .rural as only .urban distinction is required and found in tdists -->

<!-- distonly_match <- distonly_match %>% -->
<!--   mutate( -->
<!--     # remove ".urban" and .municipality suffix if not found in twards data -->
<!-- # remove .rural as only .urban distinction is required and found in tdists -->
<!--     district_clean1 = gsub("municipality", "urban", district),  -->
<!--     district_clean1 = if_else(str_detect(district_clean1, "\\.urban") & !district_clean1 %in% tdists, -->
<!--                               str_remove(district_clean1, "\\.urban"), -->
<!--                               district_clean1), -->
<!--     district_clean1 = gsub(".rural", "", district_clean1)) %>% -->
<!--   mutate(tmatch_0 = if_else(is.na(tmatch_0) & district_clean1 %in% tdists, "tmatch_distonly_1", tmatch_0), -->
<!--          ## identify if ward or region name: -->
<!--          tmatch_0 = if_else(is.na(tmatch_0) & district_clean1 %in% tregs, "reg.name", -->
<!--                             if_else(is.na(tmatch_0) & district_clean1 %in% twards, "ward.name?", tmatch_0)) -->
<!--          ) -->

<!-- distonly_match %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- distonly_match %>% filter(is.na(tmatch_0)) %>% distinct(district) %>% View() -->

<!-- distonly_matchOld <- distonly_match -->


<!-- # mrktc_origdest_distinct <- mrktc_origdest_distinct %>%  -->
<!-- #   mutate(district_clean1 = if_else(str_detect(district, "\\.urban") & !district %in% tdisturban,  -->
<!-- #                             str_remove(district, "\\.urban"), -->
<!-- #                             district)) -->
<!-- #  -->



<!-- #  -->
<!-- #  -->
<!-- # # Match District and Ward is typo:  -->
<!-- # mrktc_origdest_unmatch <- mrktc_origdest_check %>% -->
<!-- #   filter(is.na(tmatch_0)) %>% -->
<!-- #   select(-c(ET_ID, tmatch_0)) %>% -->
<!-- #   filter(district %in% tdists) -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- #    -->
<!-- #    -->
<!-- #   mutate( -->
<!-- #     # check if recorded district name matches any fields in tanzania region, district or ward  -->
<!-- #     Dtreg = tregs[amatch(district, tregs, maxDist = Inf)], -->
<!-- #     Dtdist = tdists[amatch(district, tdists, maxDist = Inf)], -->
<!-- #     Dtward = twards[amatch(district, twards, maxDist = Inf)], -->
<!-- #      -->
<!-- #      # check if recorded ward name matches any fields in tanzania region, district or ward  -->
<!-- #     Wtreg = tregs[amatch(ward, tregs, maxDist = Inf)], -->
<!-- #     Wtdist = tdists[amatch(ward, tdists, maxDist = Inf)], -->
<!-- #     Wtward = twards[amatch(ward, twards, maxDist = Inf)], -->
<!-- #   ) %>% -->
<!-- #   mutate(Dcheck = if_else(district == Dtdist, "accept_0",  -->
<!-- #                          if_else(district == Dtward, "ward.name", -->
<!-- #                                  if_else(district == Dtreg, "reg.name", NA))), -->
<!-- #          Wcheck = if_else(ward == Wtward, "accept_0",  -->
<!-- #                          if_else(ward == Wtdist, "dist.name", -->
<!-- #                                  if_else(ward == Wtreg, "reg.name", NA))) -->
<!-- #          ) -->
<!-- #    -->
<!-- #  -->
<!-- #  -->
<!-- # distward_exact <- distcorrect2 %>% -->
<!-- #   select(place,ward,district, Wtward, Dtdist, Wcheck, Dcheck) %>% -->
<!-- #   mutate(twarddist = paste(Wtward, Dtdist, sep = "-")) %>% -->
<!-- #   anti_join(twards_df %>% select(district, ward), by = c()) -->


<!-- ``` -->


<!-- ```{r, distnew} -->

<!-- tdists <- twards_df %>% distinct(district20) %>% pull() -->

<!-- twards20_df <- twards_df %>% -->
<!--   mutate(district20group = gsub(".tc", "", district20),  -->
<!--          district20group = gsub(".dc", "", district20group)) -->

<!-- districtgroups <- twards20_df %>%  -->
<!--   distinct(district20, district20group) %>% -->
<!--   group_by(district20group) %>% -->
<!--   count() %>% -->
<!--   filter(n>1) %>% -->
<!--   select(district20group) %>% -->
<!--   pull() -->

<!-- twards20_df <- twards20_df %>% -->
<!--   mutate(district20clean = if_else( -->
<!--     district20group %in% districtgroups, district20, district20group)) %>%  -->
<!--   select(-district20group) -->

<!-- tdists_cut <-  twards_df %>% mutate(district20 = gsub(".tc", "", district20), -->
<!--                                     district20 = gsub(".dc", "", district20)) %>% -->
<!--   distinct(district20) %>% pull() -->
<!-- # tdisturban <- tdists[grep("urban", tdists)] -->

<!-- twards <- twards_df %>% distinct(ward) %>% pull() -->
<!-- tregs <- twards_df %>% distinct(region20) %>% pull() -->

<!-- # Find exact matches on ward and district from twards geodata: -->

<!-- mrktc_origdest_check <- mrktc_origdest_distinct %>%  -->
<!--   # list distinct district names in origdest data: -->
<!--   arrange() %>% -->
<!--   left_join(twards_df %>% select(district20, ward, ET_ID) %>% mutate(tmatch_0 = "tmatch_0"), by = c("district" = "district20", "ward"))  -->

<!-- mrktc_origdest_check %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- # Verify District Names: -->
<!-- # - Start by cleaning district names: -->

<!-- distonly_match <- mrktc_origdest_check %>% -->
<!--   # filter(is.na(tmatch_0)) %>% -->
<!--   # select(-c(ET_ID, tmatch_0)) %>% -->
<!--   # identify districts which are found in the tdists data: -->
<!--   mutate(tmatch_0 = if_else(is.na(tmatch_0) & district %in% tdists, "tmatch_distonly_0", tmatch_0)) -->

<!-- distonly_match %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- # 544 districts are unmatched -->

<!-- distonly_match %>% filter(is.na(tmatch_0)) %>% distinct(district) -->

<!-- # remove ".urban" and .municipality suffix if not found in twards data -->
<!-- # remove .rural as only .urban distinction is required and found in tdists -->

<!-- distonly_match <- distonly_match %>% -->
<!--   mutate( -->
<!--     # remove ".urban" and .municipality suffix if not found in twards data -->
<!-- # remove .rural as only .urban distinction is required and found in tdists -->
<!--     district_clean1 = gsub("municipality", "urban", district),  -->
<!--     district_clean1 = if_else(str_detect(district_clean1, "\\.urban") & !district_clean1 %in% tdists, -->
<!--                               str_remove(district_clean1, "\\.urban"), -->
<!--                               district_clean1), -->
<!--     district_clean1 = gsub(".rural", "", district_clean1)) %>% -->
<!--   mutate(tmatch_0 = if_else(is.na(tmatch_0) & district_clean1 %in% tdists, "tmatch_distonly_1", tmatch_0), -->
<!--          ## identify if ward or region name: -->
<!--          tmatch_0 = if_else(is.na(tmatch_0) & district_clean1 %in% tregs, "reg.name", -->
<!--                             if_else(is.na(tmatch_0) & district_clean1 %in% twards, "ward.name?", tmatch_0)) -->
<!--          ) -->

<!-- distonly_match %>% -->
<!--   group_by(tmatch_0) %>%  -->
<!--   count() -->

<!-- distonly_match %>% filter(is.na(tmatch_0)) %>% distinct(district) %>% View() -->

<!-- distonly_matchNew <- distonly_match -->


<!-- ``` -->
